{
  "id": "ok1K0TEAAYXPcU8ANwiD8K7BrCA",
  "name": "ORS Alternative Visits List",
  "description": "A list of prisoners to be visited along with details of their visitors, including DOB and address. The report prompts for a visit date, an establishment code  and one, more or all wing(s). The data is presented in a streamlined format and is an alternative to the standard Visits List. The report now includes Risk to Children Alerts and displays on the report as 'RTC?'.  The Alert types are 'SC', 'RCS' and 'RCC'.  A tab has also been added to assist unlock for visits by displaying by wing VIS0003 - v00.00.08 Last Modified: 20/12/2019",
  "metadata": {
    "version": "1.0.0",
    "tags": ["VIS0003 - v00.00.08", "Visits"]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3376551/DP0",
      "name": "Prisoners to be Visited",
      "description": "Visits",
      "datasource": "nomis",
      "query": "dataset_base_ AS ( SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY AS OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME AS LAST_NAME, AT_OFFENDER.FIRST_NAME AS FIRST_NAME, CASE WHEN INSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1 ) = 0 THEN NULL ELSE SUBSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, INSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1 ) + 1, CASE WHEN INSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 2 ) = 0 THEN LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION) ELSE INSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 2 ) - INSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1 ) END - 1 ) END AS UNIT_CODE_1, SUBSTR( AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID) + 2, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION) ) AS UNIT_DESCRIPTION_4_SHORT, DT_IEP_BAND_LAST.IEP_LEVEL AS IEP_LEVEL, CASE WHEN MAX( CASE WHEN AT_OFFENDER_ALERTS.ALERT_CODE = 'HA' THEN CASE WHEN AT_OFFENDER_ALERTS.ALERT_TYPE = 'H' THEN CASE WHEN AT_OFFENDER_ALERTS.ALERT_STATUS = 'ACTIVE' THEN 2 ELSE 1 END ELSE 1 END ELSE 1 END ) OVER ( PARTITION BY (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) ) = 2 THEN 'Y' ELSE 'N' END AS ACCT, CASE WHEN AT_OFFENDER_VISITS.VISIT_TYPE = 'OFFI' THEN 'Official' ELSE 'Social/Family' END AS VISIT_TYPE, SUBSTR(TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME), 11, 6) AS VISIT_SLOT_START_TIME, AT_OFFENDER_VISITS.START_TIME AS START_TIME, TO_CHAR(AT_OFFENDER_VISITS.START_TIME, 'HH24:mi') AS VISIT_START_TIME_, AT_OFFENDER_VISITS.VISIT_DATE AS VISIT_DATE, SUBSTR( AT_OFFENDER_VISIT_ORDERS.VISIT_ORDER_NUMBER || '', 9, 5 ) AS VISIT_ORDER_NUMBER_LAST_5_DI32, TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME, 'AM') AS AM_OR_PM, DT_OFFENDER_RESTRICTIONS.DESCRIPTION AS DESCRIPTION, AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID AS OFFENDER_BOOK_ID FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.AGENCY_INTERNAL_LOCATIONS AT_AGENCY_INTERNAL_LOCATION_L4, ( SELECT iep_level, description, agy_loc_id, offender_book_id, iep_date FROM ( SELECT iep.iep_level, rc.description, iep.agy_loc_id, iep.offender_book_id, iep.iep_date, ROW_NUMBER() OVER ( PARTITION BY iep.offender_book_id ORDER BY iep.iep_time DESC, iep.iep_level_seq DESC ) AS row_seq_filter FROM oms_owner.offender_iep_levels iep LEFT OUTER JOIN oms_owner.reference_codes rc ON iep.iep_level = rc.code AND rc.domain = 'IEP_LEVEL' ) WHERE row_seq_filter = 1 ) DT_IEP_BAND_LAST, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.AGENCY_LOCATIONS AT_WING_ESTABLISHMENT, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.OFFENDER_ALERTS AT_OFFENDER_ALERTS, USER_ACCESSIBLE_CASELOADS WING_CASELOAD_SECURITY, OMS_OWNER.OFFENDER_VISITS AT_OFFENDER_VISITS, OMS_OWNER.AGENCY_VISIT_TIMES AT_AGENCY_VISIT_TIMES, OFFENDER_VISIT_ORDERS AT_OFFENDER_VISIT_ORDERS, ( SELECT off_rest.offender_book_id, ref_code.description FROM oms_owner.offender_restrictions off_rest, oms_owner.reference_codes ref_code WHERE off_rest.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' AND ( off_rest.EXPIRY_DATE >= ( SELECT visit_date FROM prompt_ ) OR off_rest.EXPIRY_DATE IS NULL ) ) DT_OFFENDER_RESTRICTIONS, OMS_OWNER.LIVING_UNITS AT_ALL_LIVING_UNITS, OMS_OWNER.AGENCY_VISIT_SLOTS AT_AGENCY_VISIT_SLOTS WHERE ( AT_AGENCY_VISIT_SLOTS.AGENCY_VISIT_SLOT_ID = AT_OFFENDER_VISITS.AGENCY_VISIT_SLOT_ID AND AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID = AT_OFFENDER_VISITS.AGY_LOC_ID ) AND ( AT_AGENCY_VISIT_TIMES.AGY_LOC_ID = AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID AND AT_AGENCY_VISIT_TIMES.WEEK_DAY = AT_AGENCY_VISIT_SLOTS.WEEK_DAY AND AT_AGENCY_VISIT_TIMES.TIME_SLOT_SEQ = AT_AGENCY_VISIT_SLOTS.TIME_SLOT_SEQ ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_OFFENDER_RESTRICTIONS.OFFENDER_BOOK_ID (+) ) AND ( AT_OFFENDER_VISIT_ORDERS.OFFENDER_VISIT_ORDER_ID (+) = AT_OFFENDER_VISITS.OFFENDER_VISIT_ORDER_ID ) AND ( AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID ) AND ( AT_OFFENDER_ALERTS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID ) AND ( AT_OFFENDER_BOOKING.LIVING_UNIT_ID = AT_AGENCY_INTERNAL_LOCATION_L4.INTERNAL_LOCATION_ID ) AND ( AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST' ) AND ( DT_IEP_BAND_LAST.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID ) AND ( AT_OFFENDER_BOOKING.LIVING_UNIT_ID (+) = AT_ALL_LIVING_UNITS.LIVING_UNIT_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+) ) AND ( NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI') ) AND ( AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID = AT_WING_ESTABLISHMENT.AGY_LOC_ID ) AND ( AT_WING_ESTABLISHMENT.AGY_LOC_ID = WING_CASELOAD_SECURITY.CASELOAD_ID ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_OFFENDER_VISITS.OFFENDER_BOOK_ID ) AND (AT_OFFENDER_VISITS.VISIT_STATUS = 'SCH') AND ( WING_CASELOAD_SECURITY.USERNAME = ( SELECT username FROM context_ ) ) AND ( WING_CASELOAD_SECURITY.USERNAME = ( SELECT username FROM context_ ) ) AND ( (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND ( AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = ( SELECT establishment_code FROM prompt_ ) ) AND ( AT_ALL_LIVING_UNITS.AGY_LOC_ID || '-' || AT_ALL_LIVING_UNITS.LEVEL_1_CODE IN ('All') OR 'All' IN ('All') ) AND (AT_OFFENDER_VISITS.VISIT_STATUS <> 'CANC') AND ( TRUNC(AT_OFFENDER_VISITS.VISIT_DATE) = ( SELECT visit_date FROM prompt_ ) ) ) ), dataset_ AS ( SELECT DISTINCT OFFENDER_ID_DISPLAY, LAST_NAME, FIRST_NAME, UNIT_CODE_1, UNIT_DESCRIPTION_4_SHORT, IEP_LEVEL, ACCT, VISIT_TYPE, VISIT_SLOT_START_TIME, START_TIME, VISIT_START_TIME_, VISIT_DATE, VISIT_ORDER_NUMBER_LAST_5_DI32, AM_OR_PM, DESCRIPTION, OFFENDER_BOOK_ID FROM dataset_base_ )",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "referenceType": "establishment",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Establishment\\Establishment Code',mono,free,,Not_Persistent,,User:3)",
          "mandatory": "true"
        },
        {
          "index": 1,
          "name": "wing",
          "filterType": "autocomplete",
          "referenceType": "wing",
          "reportFieldType": "string",
          "display": "Wing (All for all)",
          "description": "@Prompt('Wing (All for all)','A','Cell\\Level 1 Living Unit LOV',multi,free,,Not_Persistent,,User:4)",
          "mandatory": "true"
        },
        {
          "index": 2,
          "name": "visit_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Enter Visit Date",
          "description": "@prompt('Enter Visit Date','D',,Mono,Free,Not_Persistent,,User:0)",
          "mandatory": "true"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP0.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP0.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name",
            "legacyId": "DP0.DO10046",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "UNIT_CODE_1",
            "type": "string",
            "display": "Unit Code 1",
            "legacyId": "DP0.DO10472",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "UNIT_DESCRIPTION_4_SHORT",
            "type": "string",
            "display": "Cell Location",
            "legacyId": "DP0.DO10427",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "IEP_LEVEL",
            "type": "string",
            "display": "IEP Level",
            "legacyId": "DP0.DO10715",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "ACCT",
            "type": "string",
            "display": "ACCT",
            "legacyId": "DP0.DO10585",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "VISIT_TYPE",
            "type": "string",
            "display": "Visit Type",
            "legacyId": "DP0.DO6c8",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "VISIT_SLOT_START_TIME",
            "type": "string",
            "display": "Visit Slot Start Time",
            "legacyId": "DP0.DO6ce",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "START_TIME",
            "type": "date",
            "display": "Visit Start Time",
            "legacyId": "DP0.DO6cc",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "VISIT_START_TIME_",
            "type": "string",
            "display": "Visit Start Time (Time Only)",
            "legacyId": "DP0.DO7b5",
            "legacySqlClass": "column"
          },
          {
            "index": 11,
            "name": "VISIT_DATE",
            "type": "date",
            "display": "Visit Date",
            "legacyId": "DP0.DO6cb",
            "legacySqlClass": "column"
          },
          {
            "index": 12,
            "name": "VISIT_ORDER_NUMBER_LAST_5_DI32",
            "type": "string",
            "display": "Visit Order Number  - Last 5 Digits",
            "legacyId": "DP0.DO739",
            "legacySqlClass": "column"
          },
          {
            "index": 13,
            "name": "AM_OR_PM",
            "type": "string",
            "display": "AM or PM",
            "legacyId": "DP0.DO7b4",
            "legacySqlClass": "column"
          },
          {
            "index": 14,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Visit Restriction Description",
            "legacyId": "DP0.DO782",
            "legacySqlClass": "column"
          },
          {
            "index": 15,
            "name": "OFFENDER_BOOK_ID",
            "type": "double",
            "display": "Offender Book Id",
            "legacyId": "DP0.DO10898",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376551/DP2",
      "name": "Visitors",
      "description": "Visits",
      "datasource": "nomis",
      "query": "dataset_base_ AS ( SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY AS OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME AS LAST_NAME, AT_OFFENDER.FIRST_NAME AS FIRST_NAME, DT_ALL_VISITORS.OFFENDER_VISIT_VISITOR_ID AS OFFENDER_VISIT_VISITOR_ID, DT_ALL_VISITORS.LAST_NAME AS VISITOR_LAST_NAME, DT_ALL_VISITORS.FIRST_NAME AS VISITOR_FIRST_NAME, DT_ALL_VISITORS.OFFENDER_ID_DISPLAY AS NOMS_NUMBER_OF_VISITING_PRIS32, AT_PERSONS.BIRTHDATE AS BIRTHDATE, TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME, 'AM') AS AM_OR_PM, CASE WHEN AT_OFFENDER_VISITS.VISIT_TYPE = 'OFFI' THEN 'Official' ELSE 'Social/Family' END AS VISIT_TYPE, SUBSTR(TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME), 11, 6) AS VISIT_SLOT_START_TIME, AT_OFFENDER_VISITS.START_TIME AS START_TIME, TO_CHAR(AT_OFFENDER_VISITS.START_TIME, 'HH24:mi') AS VISIT_START_TIME_, AT_OFFENDER_VISITS.VISIT_DATE AS VISIT_DATE, DT_OFFENDER_RESTRICTIONS.DESCRIPTION AS DESCRIPTION, DT_VISITOR_ADDRESSES.FULL_ADDRESS AS FULL_ADDRESS, DT_ALL_VISITORS.PERSONID AS PERSONID, DT_ALL_VISITORS.VISITID AS VISITID, DT_ALL_VISITOR_RSTS.DESCRIPTION AS VISITING_PERSON_RESTRICTION_39, DT_ALL_VISITOR_RSTS.VR_OFFENDER_BOOK_ID AS VR_OFFENDER_BOOK_ID, DT_ALL_VISITOR_RSTS.VISITOR_RESTRICTION_ID AS VISITOR_RESTRICTION_ID, DT_ALL_VISITOR_RSTS.TYPE AS TYPE FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, ( SELECT ADDRESS_TYPE AS ADDRESS_TYPE, CASE WHEN NO_FIXED_ADDRESS_FLAG = 'Y' THEN 'No fixed address' ELSE SUBSTR( CASE WHEN FLAT IS NULL THEN NULL ELSE FLAT || '  ' END || CASE WHEN PREMISE IS NULL THEN NULL ELSE PREMISE || '  ' END || CASE WHEN STREET IS NULL THEN NULL ELSE STREET || '  ' END || CASE WHEN LOCALITY IS NULL THEN NULL ELSE LOCALITY || '  ' END || CASE WHEN city_name IS NULL THEN OMS_MISCELLANEOUS.GETDESCCODE('CITY', CITY_CODE) ELSE city_name END || '  ' || CASE WHEN COUNTY_CODE IS NULL THEN NULL ELSE OMS_MISCELLANEOUS.GETDESCCODE('COUNTY', COUNTY_CODE) || '  ' END, 1, 200 ) || CASE WHEN POSTAL_CODE IS NULL THEN NULL ELSE POSTAL_CODE || '  ' END || SUBSTR( CASE WHEN COUNTRY_CODE IS NULL THEN NULL ELSE OMS_MISCELLANEOUS.GETDESCCODE('COUNTRY', COUNTRY_CODE) END, 1, 40 ) END AS FULL_ADDRESS, OWNER_ID, start_date AS AddressStartDate, TRUNC(ADD_MONTHS(LAST_DAY(end_date), -1) - 1) AS AddressEndDate FROM oms_owner.addresses WHERE OWNER_CLASS = 'PER' AND start_date <= ( SELECT visit_date FROM prompt_ ) AND end_date IS NULL OR ( SELECT visit_date FROM prompt_ ) <= TRUNC(ADD_MONTHS(LAST_DAY(end_date), -1) - 1) ) DT_VISITOR_ADDRESSES, ( SELECT off_vis.offender_visit_id AS VisitID, off_vis_vis.offender_visit_visitor_id, TO_CHAR(off_vis_vis.person_id) AS PersonID, NULL AS Offender_ID_Display, 'PERSON' AS vistor_type, per.last_name, per.first_name, per.middle_name, RC.description, off_vis.offender_visit_id FROM offender_visit_visitors off_vis_vis, offender_visits off_vis, reference_codes RC, persons per, offender_contact_persons ocp WHERE per.person_id = off_vis_vis.person_id AND NOT off_vis_vis.person_id IS NULL AND off_vis_vis.person_id = ocp.person_id AND off_vis.offender_book_id = ocp.offender_book_id AND off_vis.offender_visit_id = off_vis_vis.offender_visit_id AND ocp.relationship_type = RC.code AND RC.domain = 'RELATIONSHIP' UNION ALL SELECT off_vis.offender_visit_id, off_vis_vis.offender_visit_visitor_id, NULL, vns.offender_id_display AS Offender_ID_Display, 'OFFENDER' AS vistor_type, vns.last_name, vns.first_name, vns.middle_name, RC.description, off_vis.offender_visit_id FROM offender_visit_visitors off_vis_vis, offender_visits off_vis, reference_codes RC, v_name_search2 vns, offender_contact_persons ocp, offender_bookings ob WHERE off_vis.offender_visit_id = off_vis_vis.offender_visit_id AND NOT off_vis_vis.offender_book_id IS NULL AND ob.offender_book_id = off_vis_vis.offender_book_id AND ocp.contact_root_offender_id = ob.root_offender_id AND ocp.relationship_type = RC.code AND ocp.offender_book_id = off_vis.offender_book_id AND vns.root_offender_id = ocp.contact_root_offender_id AND RC.domain = 'RELATIONSHIP' AND ob.ACTIVE_FLAG = 'Y' ) DT_ALL_VISITORS, OMS_OWNER.PERSONS AT_PERSONS, OMS_OWNER.AGENCY_VISIT_TIMES AT_AGENCY_VISIT_TIMES, OMS_OWNER.OFFENDER_VISITS AT_OFFENDER_VISITS, ( SELECT off_rest.offender_book_id, ref_code.description FROM oms_owner.offender_restrictions off_rest, oms_owner.reference_codes ref_code WHERE off_rest.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' AND ( off_rest.EXPIRY_DATE >= ( SELECT visit_date FROM prompt_ ) OR off_rest.EXPIRY_DATE IS NULL ) ) DT_OFFENDER_RESTRICTIONS, ( SELECT vt_rst.person_id, 0 AS VR_Offender_Book_Id, vt_rst.visitor_restriction_id, vt_rst.effective_date, vt_rst.expiry_date, ref_code.code, ref_code.description, 'Estate' AS type FROM oms_owner.visitor_restrictions vt_rst, oms_owner.reference_codes ref_code WHERE vt_rst.visit_restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' /* AND (vt_rst.effective_date <= '08-01-2020 00:00:00' ) */ AND ( vt_rst.expiry_date IS NULL OR vt_rst.expiry_date >= ( SELECT visit_date FROM prompt_ ) ) UNION ALL SELECT OCP.person_id, OCP.offender_book_id, offpr.offender_person_restrict_id AS visitor_restrict_id, offpr.restriction_effective_date AS effective_date, offpr.restriction_expiry_date AS expiry_date, ref_code.code, ref_code.description, 'Restriction' AS type FROM oms_owner.offender_person_restricts offpr, oms_owner.reference_codes ref_code, OMS_OWNER.OFFENDER_CONTACT_PERSONS OCP WHERE OCP.OFFENDER_CONTACT_PERSON_ID = offpr.offender_contact_person_id AND offpr.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' /* AND (offpr.restriction_effective_date <= '08-01-2020 00:00:00' ) */ AND ( offpr.restriction_expiry_date IS NULL OR offpr.restriction_expiry_date >= ( SELECT visit_date FROM prompt_ ) ) ) DT_ALL_VISITOR_RSTS, USER_ACCESSIBLE_CASELOADS, OMS_OWNER.LIVING_UNITS AT_ALL_LIVING_UNITS, OMS_OWNER.AGENCY_VISIT_SLOTS AT_AGENCY_VISIT_SLOTS WHERE ( AT_AGENCY_VISIT_SLOTS.AGENCY_VISIT_SLOT_ID = AT_OFFENDER_VISITS.AGENCY_VISIT_SLOT_ID AND AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID = AT_OFFENDER_VISITS.AGY_LOC_ID ) AND ( AT_AGENCY_VISIT_TIMES.AGY_LOC_ID = AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID AND AT_AGENCY_VISIT_TIMES.WEEK_DAY = AT_AGENCY_VISIT_SLOTS.WEEK_DAY AND AT_AGENCY_VISIT_TIMES.TIME_SLOT_SEQ = AT_AGENCY_VISIT_SLOTS.TIME_SLOT_SEQ ) AND ( DT_ALL_VISITORS.OFFENDER_VISIT_ID (+) = AT_OFFENDER_VISITS.OFFENDER_VISIT_ID ) AND ( AT_PERSONS.PERSON_ID (+) = DT_ALL_VISITORS.PERSONID ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_OFFENDER_RESTRICTIONS.OFFENDER_BOOK_ID (+) ) AND ( DT_ALL_VISITOR_RSTS.PERSON_ID (+) = AT_PERSONS.PERSON_ID ) AND ( DT_VISITOR_ADDRESSES.OWNER_ID (+) = AT_PERSONS.PERSON_ID ) AND ( AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID ) AND ( AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST' ) AND ( USER_ACCESSIBLE_CASELOADS.USERNAME = ( SELECT username FROM context_ ) ) AND ( AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID ) AND ( AT_OFFENDER_BOOKING.LIVING_UNIT_ID (+) = AT_ALL_LIVING_UNITS.LIVING_UNIT_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+) ) AND ( NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI') ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_OFFENDER_VISITS.OFFENDER_BOOK_ID ) AND (AT_OFFENDER_VISITS.VISIT_STATUS = 'SCH') AND ( (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND ( AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = ( SELECT establishment_code FROM prompt_ ) ) AND ( USER_ACCESSIBLE_CASELOADS.USERNAME = ( SELECT username FROM context_ ) ) AND ( AT_ALL_LIVING_UNITS.AGY_LOC_ID || '-' || AT_ALL_LIVING_UNITS.LEVEL_1_CODE IN ( SELECT wing FROM prompt_ ) OR 'All' IN ( SELECT wing FROM prompt_ ) ) AND (AT_OFFENDER_VISITS.VISIT_STATUS <> 'CANC') AND ( TRUNC(AT_OFFENDER_VISITS.VISIT_DATE) >= ( SELECT visit_date FROM prompt_ ) ) AND NOT DT_ALL_VISITORS.PERSONID IS NULL AND NOT DT_ALL_VISITORS.OFFENDER_VISIT_VISITOR_ID IS NULL ) UNION SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY AS OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME AS LAST_NAME, AT_OFFENDER.FIRST_NAME AS FIRST_NAME, DT_ALL_VISITORS.OFFENDER_VISIT_VISITOR_ID AS OFFENDER_VISIT_VISITOR_ID, DT_ALL_VISITORS.LAST_NAME AS VISITOR_LAST_NAME, DT_ALL_VISITORS.FIRST_NAME AS VISITOR_FIRST_NAME, DT_ALL_VISITORS.OFFENDER_ID_DISPLAY AS NOMS_NUMBER_OF_VISITING_PRIS32, AT_PERSONS.BIRTHDATE AS BIRTHDATE, TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME, 'AM') AS AM_OR_PM, CASE WHEN AT_OFFENDER_VISITS.VISIT_TYPE = 'OFFI' THEN 'Official' ELSE 'Social/Family' END AS VISIT_TYPE, SUBSTR(TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME), 11, 6) AS VISIT_SLOT_START_TIME, AT_OFFENDER_VISITS.START_TIME AS START_TIME, TO_CHAR(AT_OFFENDER_VISITS.START_TIME, 'HH24:mi') AS VISIT_START_TIME_, AT_OFFENDER_VISITS.VISIT_DATE AS VISIT_DATE, DT_OFFENDER_RESTRICTIONS.DESCRIPTION AS DESCRIPTION, AT_OFFENDERS_LOCATIONS2.DESCRIPTION AS FULL_ADDRESS, DT_ALL_VISITORS.PERSONID AS PERSONID, DT_ALL_VISITORS.VISITID AS VISITID, DT_PRISONER_RSTS.DESCRIPTION AS VISITING_PERSON_RESTRICTION_39, DT_PRISONER_RSTS.OFFENDER_BOOK_ID AS VR_OFFENDER_BOOK_ID, DT_PRISONER_RSTS.OFFENDER_RESTRICTION_ID AS VISITOR_RESTRICTION_ID, '' AS TYPE FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_VISTING_OFFENDERS_BOOKINGS, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS2, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.OFFENDERS AT_VISITING_OFFENDERS, ( SELECT off_vis.offender_visit_id AS VisitID, off_vis_vis.offender_visit_visitor_id, TO_CHAR(off_vis_vis.person_id) AS PersonID, NULL AS Offender_ID_Display, 'PERSON' AS vistor_type, per.last_name, per.first_name, per.middle_name, RC.description, off_vis.offender_visit_id FROM offender_visit_visitors off_vis_vis, offender_visits off_vis, reference_codes RC, persons per, offender_contact_persons ocp WHERE per.person_id = off_vis_vis.person_id AND NOT off_vis_vis.person_id IS NULL AND off_vis_vis.person_id = ocp.person_id AND off_vis.offender_book_id = ocp.offender_book_id AND off_vis.offender_visit_id = off_vis_vis.offender_visit_id AND ocp.relationship_type = RC.code AND RC.domain = 'RELATIONSHIP' UNION ALL SELECT off_vis.offender_visit_id, off_vis_vis.offender_visit_visitor_id, NULL, vns.offender_id_display AS Offender_ID_Display, 'OFFENDER' AS vistor_type, vns.last_name, vns.first_name, vns.middle_name, RC.description, off_vis.offender_visit_id FROM offender_visit_visitors off_vis_vis, offender_visits off_vis, reference_codes RC, v_name_search2 vns, offender_contact_persons ocp, offender_bookings ob WHERE off_vis.offender_visit_id = off_vis_vis.offender_visit_id AND NOT off_vis_vis.offender_book_id IS NULL AND ob.offender_book_id = off_vis_vis.offender_book_id AND ocp.contact_root_offender_id = ob.root_offender_id AND ocp.relationship_type = RC.code AND ocp.offender_book_id = off_vis.offender_book_id AND vns.root_offender_id = ocp.contact_root_offender_id AND RC.domain = 'RELATIONSHIP' AND ob.ACTIVE_FLAG = 'Y' ) DT_ALL_VISITORS, OMS_OWNER.PERSONS AT_PERSONS, OMS_OWNER.AGENCY_VISIT_TIMES AT_AGENCY_VISIT_TIMES, OMS_OWNER.OFFENDER_VISITS AT_OFFENDER_VISITS, ( SELECT off_rest.offender_book_id, ref_code.description FROM oms_owner.offender_restrictions off_rest, oms_owner.reference_codes ref_code WHERE off_rest.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' AND ( off_rest.EXPIRY_DATE >= ( SELECT visit_date FROM prompt_ ) OR off_rest.EXPIRY_DATE IS NULL ) ) DT_OFFENDER_RESTRICTIONS, ( SELECT DISTINCT off_rest.offender_book_id, off_rest.offender_restriction_id, off_rest.restriction_type, off_rest.effective_date, off_rest.expiry_date, ref_code.code, ref_code.description FROM oms_owner.offender_restrictions off_rest, oms_owner.reference_codes ref_code WHERE off_rest.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' AND ( off_rest.expiry_date IS NULL OR off_rest.expiry_date >= ( SELECT visit_date FROM prompt_ ) ) ) DT_PRISONER_RSTS, USER_ACCESSIBLE_CASELOADS, OMS_OWNER.LIVING_UNITS AT_ALL_LIVING_UNITS, OMS_OWNER.AGENCY_VISIT_SLOTS AT_AGENCY_VISIT_SLOTS WHERE ( AT_AGENCY_VISIT_SLOTS.AGENCY_VISIT_SLOT_ID = AT_OFFENDER_VISITS.AGENCY_VISIT_SLOT_ID AND AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID = AT_OFFENDER_VISITS.AGY_LOC_ID ) AND ( AT_AGENCY_VISIT_TIMES.AGY_LOC_ID = AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID AND AT_AGENCY_VISIT_TIMES.WEEK_DAY = AT_AGENCY_VISIT_SLOTS.WEEK_DAY AND AT_AGENCY_VISIT_TIMES.TIME_SLOT_SEQ = AT_AGENCY_VISIT_SLOTS.TIME_SLOT_SEQ ) AND ( DT_PRISONER_RSTS.OFFENDER_BOOK_ID (+) = AT_VISTING_OFFENDERS_BOOKINGS.OFFENDER_BOOK_ID ) AND ( DT_ALL_VISITORS.OFFENDER_VISIT_ID (+) = AT_OFFENDER_VISITS.OFFENDER_VISIT_ID ) AND ( AT_VISITING_OFFENDERS.OFFENDER_ID_DISPLAY (+) = DT_ALL_VISITORS.OFFENDER_ID_DISPLAY ) AND ( AT_VISTING_OFFENDERS_BOOKINGS.OFFENDER_ID (+) = AT_VISITING_OFFENDERS.OFFENDER_ID ) AND ( AT_PERSONS.PERSON_ID (+) = DT_ALL_VISITORS.PERSONID ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_OFFENDER_RESTRICTIONS.OFFENDER_BOOK_ID (+) ) AND (AT_VISTING_OFFENDERS_BOOKINGS.ACTIVE_FLAG = 'Y') AND ( AT_OFFENDERS_LOCATIONS2.AGY_LOC_ID = AT_VISTING_OFFENDERS_BOOKINGS.AGY_LOC_ID ) AND ( AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID ) AND ( AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST' ) AND ( USER_ACCESSIBLE_CASELOADS.USERNAME = ( SELECT username FROM context_ ) ) AND ( AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID ) AND ( AT_OFFENDER_BOOKING.LIVING_UNIT_ID (+) = AT_ALL_LIVING_UNITS.LIVING_UNIT_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID ) AND ( AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+) ) AND ( NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI') ) AND ( AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_OFFENDER_VISITS.OFFENDER_BOOK_ID ) AND (AT_OFFENDER_VISITS.VISIT_STATUS = 'SCH') AND ( (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND ( AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = ( SELECT establishment_code FROM prompt_ ) ) AND ( USER_ACCESSIBLE_CASELOADS.USERNAME = ( SELECT username FROM context_ ) ) AND ( AT_ALL_LIVING_UNITS.AGY_LOC_ID || '-' || AT_ALL_LIVING_UNITS.LEVEL_1_CODE IN ( SELECT wing FROM prompt_ ) OR 'All' IN ( SELECT wing FROM prompt_ ) ) AND (AT_OFFENDER_VISITS.VISIT_STATUS <> 'CANC') AND ( TRUNC(AT_OFFENDER_VISITS.VISIT_DATE) >= ( SELECT visit_date FROM prompt_ ) ) AND NOT DT_ALL_VISITORS.OFFENDER_VISIT_VISITOR_ID IS NULL ) ), dataset_ AS ( SELECT OFFENDER_ID_DISPLAY, LAST_NAME, FIRST_NAME, OFFENDER_VISIT_VISITOR_ID, VISITOR_LAST_NAME, VISITOR_FIRST_NAME, NOMS_NUMBER_OF_VISITING_PRIS32, BIRTHDATE, AM_OR_PM, VISIT_TYPE, VISIT_SLOT_START_TIME, START_TIME, VISIT_START_TIME_, VISIT_DATE, DESCRIPTION, FULL_ADDRESS, PERSONID, VISITID, VISITING_PERSON_RESTRICTION_39, VR_OFFENDER_BOOK_ID, VISITOR_RESTRICTION_ID, TYPE, CASE WHEN NOMS_NUMBER_OF_VISITING_PRIS32 IS NULL THEN VISITOR_LAST_NAME ELSE VISITOR_LAST_NAME || ' Inter-Prison Visitor' END AS V_VISITOR_WITH_IP, VISITOR_FIRST_NAME || ' ' || CASE WHEN NOMS_NUMBER_OF_VISITING_PRIS32 IS NULL THEN VISITOR_LAST_NAME ELSE VISITOR_LAST_NAME || ' Inter-Prison Visitor' END AS V_VISITORFULLNAME, CASE WHEN NOT(NOMS_NUMBER_OF_VISITING_PRIS32 IS NULL) THEN VISITING_PERSON_RESTRICTION_39 WHEN TYPE = 'Estate' THEN VISITING_PERSON_RESTRICTION_39 WHEN VISITOR_RESTRICTION_ID IS NULL THEN '' WHEN OFFENDER_ID_DISPLAY = TO_CHAR(VR_OFFENDER_BOOK_ID) THEN VISITING_PERSON_RESTRICTION_39 ELSE '' END AS V_ALL_V_RESTRICT FROM dataset_base_ )",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "referenceType": "establishment",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Establishment\\Establishment Code',mono,free,,Not_Persistent,,User:3)",
          "mandatory": "true"
        },
        {
          "index": 1,
          "name": "wing",
          "filterType": "autocomplete",
          "referenceType": "wing",
          "reportFieldType": "string",
          "display": "Wing (All for all)",
          "description": "@Prompt('Wing (All for all)','A','Cell\\Level 1 Living Unit LOV',multi,free,,Not_Persistent,,User:4)",
          "mandatory": "true"
        },
        {
          "index": 2,
          "name": "visit_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Enter Visit Date",
          "description": "@prompt('Enter Visit Date','D',,Mono,Free,Not_Persistent,,User:0)",
          "mandatory": "true"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP2.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP2.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name",
            "legacyId": "DP2.DO10046",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "OFFENDER_VISIT_VISITOR_ID",
            "type": "double",
            "display": "Visit Visitor Id",
            "legacyId": "DP2.DO778",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "VISITOR_LAST_NAME",
            "type": "string",
            "display": "Visitor Last Name",
            "legacyId": "DP2.DO6d9",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "VISITOR_FIRST_NAME",
            "type": "string",
            "display": "Visitor First Name",
            "legacyId": "DP2.DO6da",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "NOMS_NUMBER_OF_VISITING_PRIS32",
            "type": "string",
            "display": "NOMS Number of Visiting Prisoner",
            "legacyId": "DP2.DO755",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "BIRTHDATE",
            "type": "date",
            "display": "Visitor Person's Birth Date",
            "legacyId": "DP2.DO6e0",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "AM_OR_PM",
            "type": "string",
            "display": "AM or PM",
            "legacyId": "DP2.DO7b4",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "VISIT_TYPE",
            "type": "string",
            "display": "Visit Type",
            "legacyId": "DP2.DO6c8",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "VISIT_SLOT_START_TIME",
            "type": "string",
            "display": "Visit Slot Start Time",
            "legacyId": "DP2.DO6ce",
            "legacySqlClass": "column"
          },
          {
            "index": 11,
            "name": "START_TIME",
            "type": "date",
            "display": "Visit Start Time",
            "legacyId": "DP2.DO6cc",
            "legacySqlClass": "column"
          },
          {
            "index": 12,
            "name": "VISIT_START_TIME_",
            "type": "string",
            "display": "Visit Start Time (Time Only)",
            "legacyId": "DP2.DO7b5",
            "legacySqlClass": "column"
          },
          {
            "index": 13,
            "name": "VISIT_DATE",
            "type": "date",
            "display": "Visit Date",
            "legacyId": "DP2.DO6cb",
            "legacySqlClass": "column"
          },
          {
            "index": 14,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Visit Restriction Description",
            "legacyId": "DP2.DO782",
            "legacySqlClass": "column"
          },
          {
            "index": 15,
            "name": "FULL_ADDRESS",
            "type": "string",
            "display": "Full Address",
            "legacyId": "DP2.DO7e6",
            "legacySqlClass": "column"
          },
          {
            "index": 16,
            "name": "PERSONID",
            "type": "string",
            "display": "Person Id",
            "legacyId": "DP2.DO78e",
            "legacySqlClass": "column"
          },
          {
            "index": 17,
            "name": "VISITID",
            "type": "string",
            "display": "Visit Id",
            "legacyId": "DP2.DO78e",
            "legacySqlClass": "column"
          },
          {
            "index": 18,
            "name": "VISITING_PERSON_RESTRICTION_39",
            "type": "string",
            "display": "Visiting Person Restriction Description",
            "legacyId": "DP2.DO780",
            "legacySqlClass": "column"
          },
          {
            "index": 19,
            "name": "VR_OFFENDER_BOOK_ID",
            "type": "double",
            "display": "Vr Offender Book Id",
            "legacyId": "DP2.DO807",
            "legacySqlClass": "column"
          },
          {
            "index": 20,
            "name": "VISITOR_RESTRICTION_ID",
            "type": "double",
            "display": "Visitor Restriction Id",
            "legacyId": "DP2.DO7b7",
            "legacySqlClass": "column"
          },
          {
            "index": 21,
            "name": "TYPE",
            "type": "string",
            "display": "Restriction Type",
            "legacyId": "DP2.DO809",
            "legacySqlClass": "column"
          },
          {
            "index": 22,
            "name": "V_VISITOR_WITH_IP",
            "type": "string",
            "display": "Visitor Name",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 23,
            "name": "V_VISITORFULLNAME",
            "type": "string",
            "display": "Visitor Full Name",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 24,
            "name": "V_ALL_V_RESTRICT",
            "type": "string",
            "display": "All Visitor Restrictions",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3376551/DP3",
      "name": "Alerts",
      "description": "Visits",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY AS OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME AS LAST_NAME, AT_OFFENDER.FIRST_NAME AS FIRST_NAME, CASE WHEN INSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1) = 0 THEN NULL ELSE SUBSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, INSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1) + 1, CASE WHEN INSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 2) = 0 THEN LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION) ELSE INSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 2) - INSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 1, 1) END - 1) END AS UNIT_CODE_1, SUBSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID) + 2, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION)) AS UNIT_DESCRIPTION_4_SHORT, DT_IEP_BAND_LAST.IEP_LEVEL AS IEP_LEVEL, CASE WHEN MAX(CASE WHEN AT_OFFENDER_ALERTS.ALERT_CODE = 'HA' THEN CASE WHEN AT_OFFENDER_ALERTS.ALERT_TYPE = 'H' THEN CASE WHEN AT_OFFENDER_ALERTS.ALERT_STATUS = 'ACTIVE' THEN 2 ELSE 1 END ELSE 1 END ELSE 1 END) OVER (PARTITION BY (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID)) = 2 THEN 'Y' ELSE 'N' END AS ACCT, CASE WHEN AT_OFFENDER_VISITS.VISIT_TYPE = 'OFFI' THEN 'Official' ELSE 'Social/Family' END AS VISIT_TYPE, SUBSTR(TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME), 11, 6) AS VISIT_SLOT_START_TIME, AT_OFFENDER_VISITS.START_TIME AS START_TIME, TO_CHAR(AT_OFFENDER_VISITS.START_TIME, 'HH24:mi') AS VISIT_START_TIME_, AT_OFFENDER_VISITS.VISIT_DATE AS VISIT_DATE, SUBSTR(AT_OFFENDER_VISIT_ORDERS.VISIT_ORDER_NUMBER || '', 9, 5) AS VISIT_ORDER_NUMBER_LAST_5_DI32, TO_CHAR(AT_AGENCY_VISIT_TIMES.START_TIME, 'AM') AS AM_OR_PM, DT_OFFENDER_RESTRICTIONS.DESCRIPTION AS DESCRIPTION, AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID AS OFFENDER_BOOK_ID FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.AGENCY_INTERNAL_LOCATIONS AT_AGENCY_INTERNAL_LOCATION_L4, (SELECT iep_level, description, agy_loc_id, offender_book_id, iep_date FROM (SELECT iep.iep_level, rc.description, iep.agy_loc_id, iep.offender_book_id, iep.iep_date, ROW_NUMBER() OVER (PARTITION BY iep.offender_book_id ORDER BY iep.iep_time DESC, iep.iep_level_seq DESC) AS row_seq_filter FROM oms_owner.offender_iep_levels iep LEFT OUTER JOIN oms_owner.reference_codes rc ON iep.iep_level = rc.code AND rc.domain = 'IEP_LEVEL') WHERE row_seq_filter = 1) DT_IEP_BAND_LAST, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.AGENCY_LOCATIONS AT_WING_ESTABLISHMENT, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.OFFENDER_ALERTS AT_OFFENDER_ALERTS, USER_ACCESSIBLE_CASELOADS WING_CASELOAD_SECURITY, OMS_OWNER.OFFENDER_VISITS AT_OFFENDER_VISITS, OMS_OWNER.AGENCY_VISIT_TIMES AT_AGENCY_VISIT_TIMES, OFFENDER_VISIT_ORDERS AT_OFFENDER_VISIT_ORDERS, (SELECT off_rest.offender_book_id, ref_code.description FROM oms_owner.offender_restrictions off_rest, oms_owner.reference_codes ref_code WHERE off_rest.restriction_type = ref_code.code AND ref_code.domain = 'VST_RST_TYPE' AND (off_rest.EXPIRY_DATE >= (SELECT visit_date FROM prompt_) OR off_rest.EXPIRY_DATE IS NULL)) DT_OFFENDER_RESTRICTIONS, OMS_OWNER.LIVING_UNITS AT_ALL_LIVING_UNITS, OMS_OWNER.AGENCY_VISIT_SLOTS AT_AGENCY_VISIT_SLOTS WHERE (AT_AGENCY_VISIT_SLOTS.AGENCY_VISIT_SLOT_ID = AT_OFFENDER_VISITS.AGENCY_VISIT_SLOT_ID AND AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID = AT_OFFENDER_VISITS.AGY_LOC_ID) AND (AT_AGENCY_VISIT_TIMES.AGY_LOC_ID = AT_AGENCY_VISIT_SLOTS.AGY_LOC_ID AND AT_AGENCY_VISIT_TIMES.WEEK_DAY = AT_AGENCY_VISIT_SLOTS.WEEK_DAY AND AT_AGENCY_VISIT_TIMES.TIME_SLOT_SEQ = AT_AGENCY_VISIT_SLOTS.TIME_SLOT_SEQ) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_OFFENDER_RESTRICTIONS.OFFENDER_BOOK_ID (+)) AND (AT_OFFENDER_VISIT_ORDERS.OFFENDER_VISIT_ORDER_ID (+) = AT_OFFENDER_VISITS.OFFENDER_VISIT_ORDER_ID) AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDER_ALERTS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_OFFENDER_BOOKING.LIVING_UNIT_ID = AT_AGENCY_INTERNAL_LOCATION_L4.INTERNAL_LOCATION_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (DT_IEP_BAND_LAST.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_OFFENDER_BOOKING.LIVING_UNIT_ID (+) = AT_ALL_LIVING_UNITS.LIVING_UNIT_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID = AT_WING_ESTABLISHMENT.AGY_LOC_ID) AND (AT_WING_ESTABLISHMENT.AGY_LOC_ID = WING_CASELOAD_SECURITY.CASELOAD_ID) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_OFFENDER_VISITS.OFFENDER_BOOK_ID) AND (AT_OFFENDER_VISITS.VISIT_STATUS = 'SCH') AND (WING_CASELOAD_SECURITY.USERNAME = (SELECT username FROM context_)) AND (WING_CASELOAD_SECURITY.USERNAME = (SELECT username FROM context_)) AND ((AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = '(SELECT establishment_code FROM prompt_)') AND (AT_ALL_LIVING_UNITS.AGY_LOC_ID || '-' || AT_ALL_LIVING_UNITS.LEVEL_1_CODE IN ('All') OR 'All' IN ('All')) AND (AT_OFFENDER_VISITS.VISIT_STATUS <> 'CANC') AND (TRUNC(AT_OFFENDER_VISITS.VISIT_DATE) = (SELECT visit_date FROM prompt_)))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, LAST_NAME, FIRST_NAME, UNIT_CODE_1, UNIT_DESCRIPTION_4_SHORT, IEP_LEVEL, ACCT, VISIT_TYPE, VISIT_SLOT_START_TIME, START_TIME, VISIT_START_TIME_, VISIT_DATE, VISIT_ORDER_NUMBER_LAST_5_DI32, AM_OR_PM, DESCRIPTION, OFFENDER_BOOK_ID FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "referenceType": "establishment",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Establishment\\Establishment Code',mono,free,,Not_Persistent,,User:3)",
          "mandatory": "true"
        },
        {
          "index": 1,
          "name": "wing",
          "filterType": "autocomplete",
          "referenceType": "wing",
          "reportFieldType": "string",
          "display": "Wing (All for all)",
          "description": "@Prompt('Wing (All for all)','A','Cell\\Level 1 Living Unit LOV',multi,free,,Not_Persistent,,User:4)",
          "mandatory": "true"
        },
        {
          "index": 2,
          "name": "visit_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Enter Visit Date",
          "description": "@prompt('Enter Visit Date','D',,Mono,Free,Not_Persistent,,User:0)",
          "mandatory": "true"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP3.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "ALERT_CODE",
            "type": "string",
            "display": "Alert Type Code",
            "legacyId": "DP3.DO1007e",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "visit-prisoner-summary",
      "name": "Visit Prisoner Summary",
      "datasource": "redshift",
      "query": "SELECT COALESCE(TO_CHAR(VISIT_DATE, 'dd/mm/yyyy'), '') AS VISIT_DATE, AM_OR_PM, VISIT_START_TIME_, VISIT_TYPE, OFFENDER_ID_DISPLAY, LAST_NAME, FIRST_NAME, FIRST_NAME || ' ' || LAST_NAME AS FULL_NAME FROM ${tableId}",
      "schema": {
        "field": [
          {
            "name": "VISIT_DATE",
            "type": "string",
            "display": "Visit Date"
          },
          {
            "name": "AM_OR_PM",
            "type": "string",
            "display": "AM / PM"
          },
          {
            "name": "VISIT_START_TIME_",
            "type": "string",
            "display": "Visit Time"
          },
          {
            "name": "VISIT_TYPE",
            "type": "string",
            "display": "Visit Type"
          },
          {
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number"
          },
          {
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name"
          },
          {
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name"
          },
          {
            "name": "FULL_NAME",
            "type": "string",
            "display": "Full Name"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": ["${role}", "ROLE_PRISONS_REPORTING_USER"]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "visitors",
      "name": "Visitors",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML-child",
      "dataset": "3376551/DP2",
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "VISITID",
            "display": "Visit ID",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "VISIT_TYPE",
            "display": "Visit Type",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:V_VISITORFULLNAME",
            "display": "Visitor Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:BIRTHDATE",
            "display": "D.O.B.",
            "formula": "format_date(${BIRTHDATE}, 'dd/MM/yyyy')",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:FULL_ADDRESS",
            "display": "Visitor Address",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:DESCRIPTION",
            "display": "Visitor Restriction",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "173687.RS",
      "name": "Alternative Visits List",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376551/DP2",
      "feature": [
        {
          "type": "print"
        }
      ],
      "child": [
        {
          "reportId": "visitors",
          "joinField": ["VISITID"]
        }
      ],
      "specification": {
        "template": "parent-child",
        "field": [
          {
            "name": "VISITID",
            "display": "Visit ID",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:VISIT_DATE",
            "display": "Visit Date",
            "formula": "format_date(${VISIT_DATE}, 'dd/MM/yyyy')",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:AM_OR_PM",
            "display": "AM / PM",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:VISIT_START_TIME_",
            "display": "Visit Time",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:V_ALL_V_RESTRICT",
            "display": "",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "175911.RS",
      "name": "Unlock By Wing",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376551/DP0",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-section",
        "section": ["AM_OR_PM","UNIT_CODE_1"],
        "field": [
          {
            "name": "$ref:AM_OR_PM",
            "display": "AM / PM",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:UNIT_CODE_1",
            "display": "Wing",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:UNIT_DESCRIPTION_4_SHORT",
            "display": "Cell Location",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:IEP_LEVEL",
            "display": "IEP Level",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:ACCT",
            "display": "ACCT",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:VISIT_START_TIME_",
            "display": "Visit Start Time",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:VISIT_TYPE",
            "display": "Visit Type",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    }
  ]
}
