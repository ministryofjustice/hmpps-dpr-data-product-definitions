{
  "id": "Fur3cQIN1QcAIy8IAAB3faH.ACJIAGc1",
  "name": "MIS DRAFT NSR-5397 IPP Report v3.1 - Sentence Type to ID IPP plus HPI Alert",
  "metadata": {
    "version": "1.0.0",
    "tags": []
  },
  "description": "<br/>NAT00 v1.0  Last Modified: 21.09.23",
  "datasource": [
    {
      "id": "bodmis",
      "name": "BODMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "bodmis"
    }
  ],
  "dataset": [
    {
      "id": "3375368/DP12",
      "name": "IPP Prisoners",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END AS DATE_OF_BIRTH, AT_OFFENDER_BOOKING.PNC_ID, CASE WHEN AT_DIM_OFFENDER_ASSESSMENTS.CURRENT_SEC_CAT_LEVEL IS NULL THEN 'Unclassfied' ELSE AT_DIM_OFFENDER_ASSESSMENTS.CURRENT_SEC_CAT_LEVEL END AS SECURITY_CATEGORY_CURRENT_LE31, AT_ESTABLISHMENT.AREA_DESCRIPTION, AT_ESTABLISHMENT.ESTABLISHMENT_DESCRIPTION, AT_OFFENDER_BOOKING.SURNAME, AT_OFFENDER_BOOKING.FIRST_NAME, AT_OFFENDER_BOOKING.MAIN_LEGAL_STATUS_CODE, AT_DIM_SENTENCE_TYPE.SENTENCE_CODE_NK, AT_DIM_SENTENCE_TYPE.SENTENCE_DESCRIPTION, AT_DIM_SENTENCE_TYPE.SENTENCE_CATEGORY_NK, AT_OFFENDER_BOOKING.MAIN_LEGAL_STATUS_DESCRIPTION FROM BODIMIS.FACT_CASE_SENTENCE AT_FACT_SENTENCE, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT, BODIMIS.DIM_SENTENCE_TYPE AT_DIM_SENTENCE_TYPE, BODIMIS.DIM_COURT_CASE_STATUS AT_DIM_COURT_CASE_STATUS, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_DATE AT_DOB, BODIMIS.DIM_OFFENDER_ASSESSMENT AT_DIM_OFFENDER_ASSESSMENTS, BODIMIS.DIM_CELL AT_CELL, BODIMIS.DIM_COURT_CASE AT_COURT_CASE WHERE (AT_COURT_CASE.COURT_CASE_STATUS_SK = AT_DIM_COURT_CASE_STATUS.COURT_CASE_STATUS_SK (+)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (AT_OFFENDER_BOOKING.BIRTH_DATE_SK = AT_DOB.DATE_SK) AND (AT_CELL.ESTABLISHMENT_SK = AT_ESTABLISHMENT.ESTABLISHMENT_SK) AND (AT_CELL.UNIT_4_SK = AT_OFFENDER_BOOKING.LIVING_UNIT_SK) AND (AT_COURT_CASE.COURT_CASE_SK = AT_FACT_SENTENCE.COURT_CASE_SK (+)) AND (AT_ESTABLISHMENT.ACTIVE_FLAG = 'Y') AND (AT_FACT_SENTENCE.SENTENCE_TYPE_SK = AT_DIM_SENTENCE_TYPE.SENTENCE_TYPE_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER('DPRWS') AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK IS NULL OR AT_COURT_CASE.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER('DPRWS') AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = AT_DIM_OFFENDER_ASSESSMENTS.OFFENDER_BOOKING_SK (+)) AND ((AT_ESTABLISHMENT.ESTABLISHMENT_CODE_NK IN (SELECT SAC.CASELOAD_ID FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC WHERE SAC.USERNAME = UPPER('DPRWS'))) AND (AT_DIM_COURT_CASE_STATUS.COURT_CASE_STATUS = 'Active') AND (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND AT_ESTABLISHMENT.ESTABLISHMENT_CODE_NK <> 'ZZGHI' AND AT_DIM_SENTENCE_TYPE.SENTENCE_CODE_NK IN ('IPP', 'LR_IPP', 'DPP', 'LR_DPP', 'LIFE/IPP'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, DATE_OF_BIRTH, PNC_ID, SECURITY_CATEGORY_CURRENT_LE31, AREA_DESCRIPTION, ESTABLISHMENT_DESCRIPTION, SURNAME, FIRST_NAME, MAIN_LEGAL_STATUS_CODE, SENTENCE_CODE_NK, SENTENCE_DESCRIPTION, SENTENCE_CATEGORY_NK, MAIN_LEGAL_STATUS_DESCRIPTION, ALERT_CODE_NK AS V_ALERT_CODE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP12.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "DATE_OF_BIRTH",
            "type": "date",
            "display": "Date of Birth",
            "legacyId": "DP12.DO10085",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "PNC_ID",
            "type": "string",
            "display": "PNC ID",
            "legacyId": "DP12.DO100db",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "SECURITY_CATEGORY_CURRENT_LE31",
            "type": "string",
            "display": "Security Category - Current Level",
            "legacyId": "DP12.DO10832",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "AREA_DESCRIPTION",
            "type": "string",
            "display": "Establishment Area",
            "legacyId": "DP12.DO100c7",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "ESTABLISHMENT_DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DP12.DO10129",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "SURNAME",
            "type": "string",
            "display": "Offender Surname",
            "legacyId": "DP12.DO1007b",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "Offender Given Name 1",
            "legacyId": "DP12.DO10080",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "MAIN_LEGAL_STATUS_CODE",
            "type": "string",
            "display": "Main Legal Status Code",
            "legacyId": "DP12.DO100de",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "SENTENCE_CODE_NK",
            "type": "string",
            "display": "Sentence Type",
            "legacyId": "DP12.DO3e",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "SENTENCE_DESCRIPTION",
            "type": "string",
            "display": "Sentence Name",
            "legacyId": "DP12.DO3d",
            "legacySqlClass": "column"
          },
          {
            "index": 11,
            "name": "SENTENCE_CATEGORY_NK",
            "type": "string",
            "display": "Sentence Category",
            "legacyId": "DP12.DO1de",
            "legacySqlClass": "column"
          },
          {
            "index": 12,
            "name": "MAIN_LEGAL_STATUS_DESCRIPTION",
            "type": "string",
            "display": "Main Legal Status Description",
            "legacyId": "DP12.DO100df",
            "legacySqlClass": "column"
          },
          {
            "index": 13,
            "name": "V_ALERT_CODE",
            "type": "string",
            "display": "V_ALERT_CODE",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3375368/DP3",
      "name": "Load End Date",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT BODIMIS.ETL_LOAD_LOG.BUSINESS_DATE FROM BODIMIS.ETL_LOAD_LOG WHERE (BODIMIS.ETL_LOAD_LOG.LOAD_ID = (SELECT MAX(LOAD_ID) FROM BODIMIS.ETL_LOAD_LOG WHERE NOT LOAD_END_DATETIME IS NULL))), dataset_ AS (SELECT BUSINESS_DATE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "BUSINESS_DATE",
            "type": "date",
            "display": "Latest Business Date Available",
            "legacyId": "DP3.DO104dd",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3375368/DP18",
      "name": "Alerts",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_ALERT.ALERT_CODE_NK, AT_ALERT.ALERT_DESCRIPTION FROM BODIMIS.FACT_CASE_SENTENCE AT_FACT_SENTENCE, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT, BODIMIS.DIM_SENTENCE_TYPE AT_DIM_SENTENCE_TYPE, BODIMIS.DIM_COURT_CASE_STATUS AT_DIM_COURT_CASE_STATUS, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_ALERT AT_ALERT, BODIMIS.FACT_OFFENDER_ALERT AT_OFFENDER_ALERT, BODIMIS.DIM_CELL AT_CELL, BODIMIS.DIM_COURT_CASE AT_COURT_CASE WHERE (AT_COURT_CASE.COURT_CASE_STATUS_SK = AT_DIM_COURT_CASE_STATUS.COURT_CASE_STATUS_SK (+)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = AT_OFFENDER_ALERT.OFFENDER_BOOKING_SK (+)) AND (AT_ALERT.ALERT_SK (+) = AT_OFFENDER_ALERT.ALERT_SK) AND (AT_CELL.ESTABLISHMENT_SK = AT_ESTABLISHMENT.ESTABLISHMENT_SK) AND (AT_CELL.UNIT_4_SK = AT_OFFENDER_BOOKING.LIVING_UNIT_SK) AND (AT_COURT_CASE.COURT_CASE_SK = AT_FACT_SENTENCE.COURT_CASE_SK (+)) AND (AT_ESTABLISHMENT.ACTIVE_FLAG = 'Y') AND (AT_FACT_SENTENCE.SENTENCE_TYPE_SK = AT_DIM_SENTENCE_TYPE.SENTENCE_TYPE_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER('DPRWS') AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK IS NULL OR AT_COURT_CASE.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER('DPRWS') AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND ((AT_ESTABLISHMENT.ESTABLISHMENT_CODE_NK IN (SELECT SAC.CASELOAD_ID FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC WHERE SAC.USERNAME = UPPER('DPRWS'))) AND (AT_DIM_COURT_CASE_STATUS.COURT_CASE_STATUS = 'Active') AND (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND AT_ESTABLISHMENT.ESTABLISHMENT_CODE_NK <> 'ZZGHI' AND AT_DIM_SENTENCE_TYPE.SENTENCE_CODE_NK IN ('IPP', 'LR_IPP', 'DPP', 'LR_DPP', 'LIFE/IPP') AND AT_ALERT.ALERT_CODE_NK = (SELECT establishment_code FROM prompt_) AND (AT_OFFENDER_ALERT.ALERT_STATUS = 'ACTIVE'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, ALERT_CODE_NK, ALERT_DESCRIPTION FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP18.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "ALERT_CODE_NK",
            "type": "string",
            "display": "Alert Code",
            "legacyId": "DP18.DO1008e",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "ALERT_DESCRIPTION",
            "type": "string",
            "display": "Alert Description",
            "legacyId": "DP18.DO10090",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "142301.RS",
      "name": "All IPP Prisoners",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3375368/DP12",
      "filter": {
        "name": "prefilter_",
        "query": "prefilter_ AS (SELECT * FROM dataset_ WHERE (SENTENCE_NAME NOT(IN ('Adult Imprison above 12 mths below 4 yrs','Adult Imprison above 4 years (not Life)','Adult Imprisonment less than 12 months','Civil Imprisonment ','CIVIL IMPRISONMENT OVER 12 MONTHS SENTENCE','CJA03 Standard Determinate Sentence','EDS LASPO Automatic Release','EDS LASPO Discretionary Release','EDS Sec 279 Sentencing Code (21+)','Imprisoned in Default of a fine','Imprisonment in Default of Fine','Legacy (pre 1991 Act)','Licence Recall','Licence recall from Extended Sentence','LR - EDS LASPO Automatic Release','ORA CJA03 Standard Determinate Sentence','ORA Licence Recall','ORA Sentencing Code Standard Determinate Sentence','Section 236A SOPC CJA03','Sentencing Code Standard Determinate Sentence','Sent Extended Sec 86 of PCC(S) Act 2000','SOPC Sec 278 Sentencing Code (21+)','Young Offender Institution','[NULL_VALUE]'))))"
      },
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP12.DO10076"
          },
          {
            "name": "$ref:SURNAME",
            "display": "Offender Surname",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO1007b"
          },
          {
            "name": "$ref:MAIN_LEGAL_STATUS_CODE",
            "display": "Main Legal Status Code",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO100de"
          },
          {
            "name": "$ref:ESTABLISHMENT_DESCRIPTION",
            "display": "Establishment Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO10129"
          },
          {
            "name": "$ref:MAIN_LEGAL_STATUS_DESCRIPTION",
            "display": "Main Legal Status Description",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO100df"
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "Offender Given Name 1",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO10080"
          },
          {
            "name": "$ref:SENTENCE_CODE_NK",
            "display": "Sentence Type",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO3e"
          },
          {
            "name": "$ref:SENTENCE_DESCRIPTION",
            "display": "Sentence Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO3d"
          },
          {
            "name": "$ref:AREA_DESCRIPTION",
            "display": "Establishment Area",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO100c7"
          },
          {
            "name": "$ref:SECURITY_CATEGORY_CURRENT_LE31",
            "display": "Security Category - Current Level",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO10832"
          },
          {
            "name": "$ref:PNC_ID",
            "display": "PNC ID",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO100db"
          },
          {
            "name": "$ref:DATE_OF_BIRTH",
            "display": "Date of Birth",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP12.DO10085"
          },
          {
            "name": "$ref:V_ALERT_CODE",
            "display": "=NameOf([v_Alert_Code])",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[Alert Code]"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_ALERT_CODE :: ReferenceError: error is not defined",
      "entityId": "Fur3cQIN1QcAIy8IAAB3faH.ACJIAGc1",
      "entityType": "dpd"
    },
    {
      "type": "athenQuery",
      "error": "Error: Error: Query failed: GENERIC_USER_ERROR: Failed To Get Query Passthrough Schema",
      "entityId": "3375368/DP12",
      "entityType": "dataset"
    }
  ]
}