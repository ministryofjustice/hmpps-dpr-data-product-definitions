{
  "id": "okRrMP4ADljHBnIAJByD8LAVpgw",
  "name": "ORS Create Global Credit",
  "description": "This report outputs a list of prisoners who have received a global credit to their Spends account on a specified date. Balances before and after the credit was applied are shown along with the credit amount. The report consists of multiple queries to return the information required, so there is a possibility of seeing 'no data to retrieve' messages; these can be ignored.<br/>FIN0003 - v00.00.08 Last Modified: 12/08/08",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "r1.1127 FIN0003 v00.00.08 drop9.6"
    ]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3376816/DP2",
      "name": "Global Credit amount",
      "description": "Finance",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDERS_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME, SUBSTR(AT_OFFENDER.FIRST_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME_2 IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME_2, 1, 1) || '.' END END AS INITIALS, SUM(AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_AMOUNT) AS SUM_OF_TRANSACTION_AMOUNT FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.OFFENDER_TRANSACTIONS AT_OFFENDER_TRANSACTIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.TRANSACTION_TYPES AT_TRANSACTION_TYPES, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER_TRANSACTIONS.OFFENDER_ID = AT_OFFENDER_BOOKING.ROOT_OFFENDER_ID) AND (AT_TRANSACTION_TYPES.TXN_TYPE = AT_OFFENDER_TRANSACTIONS.TXN_TYPE) AND (AT_TRANSACTION_TYPES.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER('or_jqb29y')) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER('or_jqb29y')) AND ((AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = (SELECT establishment_code FROM prompt_)) AND (AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_DATE = TO_DATE('17-07-2008 00:00:00', 'DD-MM-YYYY HH24:MI:SS')) AND AT_TRANSACTION_TYPES.TXN_TYPE = 'DEM' AND AT_OFFENDER_TRANSACTIONS.SUB_ACCOUNT_TYPE = 'SPND') GROUP BY AT_OFFENDERS_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME, SUBSTR(AT_OFFENDER.FIRST_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME_2 IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME_2, 1, 1) || '.' END END), dataset_ AS (SELECT DESCRIPTION, OFFENDER_ID_DISPLAY, LAST_NAME, INITIALS, SUM_OF_TRANSACTION_AMOUNT, SUM(SPEND_ACCOUNT_BALANCE - TRANSACTION_CREDIT_AMOUNTS) || TRANSACTION_DEBIT_AMOUNTS AS V_BALANCEAFTERGLOBALCREDITAP33 FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DP2.DO1033b",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP2.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP2.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "INITIALS",
            "type": "string",
            "display": "Initials",
            "legacyId": "DP2.DO10071",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "SUM_OF_TRANSACTION_AMOUNT",
            "type": "double",
            "display": "Sum of Transaction Amount",
            "legacyId": "DP2.DO45a9",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "V_BALANCEAFTERGLOBALCREDITAP33",
            "type": "string",
            "display": "V_BALANCEAFTERGLOBALCREDITAP33",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3376816/DP7",
      "name": "Transactions after Global Credit applied",
      "description": "Finance",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDERS_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME, SUBSTR(AT_OFFENDER.FIRST_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME_2 IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME_2, 1, 1) || '.' END END AS INITIALS, CASE WHEN (AT_OFFENDER_TRANSACTIONS.TXN_POSTING_TYPE) = 'CR' THEN (AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_AMOUNT) ELSE 0 END AS TRANSACTION_CREDIT_AMOUNTS, CASE WHEN (AT_OFFENDER_TRANSACTIONS.TXN_POSTING_TYPE) = 'DR' THEN (AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_AMOUNT) ELSE 0 END AS TRANSACTION_DEBIT_AMOUNTS FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.OFFENDER_TRANSACTIONS AT_OFFENDER_TRANSACTIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER_TRANSACTIONS.OFFENDER_ID = AT_OFFENDER_BOOKING.ROOT_OFFENDER_ID) AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND ((AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code','A','Establishment\\Establishment Code',mono,free,,Not_Persistent,,User:3) */)) AND AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_DATE BETWEEN (SELECT TXN_DATE FROM prompt_ /* = #prompt('Transaction Date (dd/mm/yyyy)','D','Offender Transactions\\Transaction Date',Mono,Free,Not_Persistent,,User:0) */) AND CURRENT_TIMESTAMP AND AT_OFFENDER_TRANSACTIONS.SUB_ACCOUNT_TYPE = 'SPND' AND AT_OFFENDER_TRANSACTIONS.TXN_ID > ALL (SELECT DISTINCT AT_OFFENDER_TRANSACTIONS.TXN_ID FROM OMS_OWNER.OFFENDER_TRANSACTIONS AT_OFFENDER_TRANSACTIONS, OMS_OWNER.TRANSACTION_TYPES AT_TRANSACTION_TYPES WHERE (AT_TRANSACTION_TYPES.TXN_TYPE = AT_OFFENDER_TRANSACTIONS.TXN_TYPE) AND (AT_TRANSACTION_TYPES.ACTIVE_FLAG = 'Y') AND (AT_TRANSACTION_TYPES.TXN_TYPE = 'DEM' AND AT_OFFENDER_TRANSACTIONS.SUB_ACCOUNT_TYPE = 'SPND' AND (AT_OFFENDER_TRANSACTIONS.TXN_ENTRY_DATE = (SELECT TXN_DATE FROM prompt_ /* = #Prompt('Transaction Date (dd/mm/yyyy)','D',,mono,free,Not_Persistent,,,User:0) */)))))), dataset_ AS (SELECT DESCRIPTION, OFFENDER_ID_DISPLAY, LAST_NAME, INITIALS, TRANSACTION_CREDIT_AMOUNTS, TRANSACTION_DEBIT_AMOUNTS FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Establishment\\Establishment Code',mono,free,,Not_Persistent,,User:3)",
          "mandatory": "true",
          "referenceType": "establishment"
        },
        {
          "index": 1,
          "name": "txn_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Transaction Date (dd/mm/yyyy)",
          "description": "@prompt('Transaction Date (dd/mm/yyyy)','D','Offender Transactions\\Transaction Date',Mono,Free,Not_Persistent,,User:0)",
          "mandatory": "true"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DP7.DO1033b",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP7.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP7.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "INITIALS",
            "type": "string",
            "display": "Initials",
            "legacyId": "DP7.DO10071",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "TRANSACTION_CREDIT_AMOUNTS",
            "type": "double",
            "display": "Transaction Credit Amounts",
            "legacyId": "DP7.DO6a",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "TRANSACTION_DEBIT_AMOUNTS",
            "type": "double",
            "display": "Transaction Debit Amounts",
            "legacyId": "DP7.DO6b",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376816/DPa",
      "name": "Current Spends Balance",
      "description": "Finance",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDERS_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME, SUBSTR(AT_OFFENDER.FIRST_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME, 1, 1) || '.' || CASE WHEN AT_OFFENDER.MIDDLE_NAME_2 IS NULL THEN NULL ELSE SUBSTR(AT_OFFENDER.MIDDLE_NAME_2, 1, 1) || '.' END END AS INITIALS, CASE WHEN (AT_ACCOUNT_CODES.ACCOUNT_NAME) = 'Spends' THEN (AT_OFFENDER_SUB_ACCOUNTS.BALANCE) ELSE 0 END AS SPEND_ACCOUNT_BALANCE FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, USER_ACCESSIBLE_CASELOADS, OMS_OWNER.OFFENDER_SUB_ACCOUNTS AT_OFFENDER_SUB_ACCOUNTS, OMS_OWNER.ACCOUNT_CODES AT_ACCOUNT_CODES WHERE (AT_OFFENDER_SUB_ACCOUNTS.OFFENDER_ID (+) = AT_OFFENDER_BOOKING.ROOT_OFFENDER_ID) AND (AT_ACCOUNT_CODES.ACCOUNT_CODE = AT_OFFENDER_SUB_ACCOUNTS.TRUST_ACCOUNT_CODE) AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER('or_jqb29y')) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER('or_jqb29y')) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = (SELECT establishment_code FROM prompt_))), dataset_ AS (SELECT DESCRIPTION, OFFENDER_ID_DISPLAY, LAST_NAME, INITIALS, SPEND_ACCOUNT_BALANCE FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DPa.DO1033b",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DPa.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DPa.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "INITIALS",
            "type": "string",
            "display": "Initials",
            "legacyId": "DPa.DO10071",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "SPEND_ACCOUNT_BALANCE",
            "type": "double",
            "display": "Spend Account Balance",
            "legacyId": "DPa.DOd7",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "75327.RS",
      "name": "Create Global Credit",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376816/DP2",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO10044"
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO10045"
          },
          {
            "name": "$ref:INITIALS",
            "display": "Initials",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO10071"
          },
          {
            "name": "$ref:SUM_OF_TRANSACTION_AMOUNT",
            "display": "Sum of Transaction Amount",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO45a9"
          },
          {
            "name": "$ref:V_BALANCEAFTERGLOBALCREDITAP33",
            "display": "Amount",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=Sum([Spend Account Balance]-[Transaction Credit Amounts])+[Transaction Debit Amounts]"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_BALANCEAFTERGLOBALCREDITAP33 :: ReferenceError: error is not defined",
      "entityId": "okRrMP4ADljHBnIAJByD8LAVpgw",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_BALANCEAFTERGLOBALCREDITAP33 :: ReferenceError: error is not defined",
      "entityId": "okRrMP4ADljHBnIAJByD8LAVpgw",
      "entityType": "dpd"
    },
    {
      "type": "sqlQuery",
      "error": "Error: ORA-00904: \"TRANSACTION_DEBIT_AMOUNTS\": invalid identifier\nHelp: https://docs.oracle.com/error-help/db/ora-00904/",
      "entityId": "3376816/DP2",
      "entityType": "dataset"
    },
    {
      "type": "sqlQuery",
      "error": "Error: ORA-00904: \"TXN_DATE\": invalid identifier\nHelp: https://docs.oracle.com/error-help/db/ora-00904/",
      "entityId": "3376816/DP7",
      "entityType": "dataset"
    }
  ]
}