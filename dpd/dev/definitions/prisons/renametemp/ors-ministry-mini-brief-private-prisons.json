{
  "id": "klk_l6oAC3IXL.4BMv8AISgWcQA",
  "name": "ORS Ministry Mini Brief Private Prisons",
  "description": "<br/>This report is intended to assist private prison establishments to submit a mini brief to ministers on a monthly basis, Prior to this report private establishments would need to run various reports and try to pull a document together.<br/>The report contains overview stats for Ethnic Breakdown, Category, Adult/Young Person breakdown, Sentence and IEP levels for an establishment selected at runtime.<br/><br/><br/>PDD0080 - v00.00.01 Last Modified: 12/06/17",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "PDD0080"
    ]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3377299/DP2",
      "name": "Ethnic Codes",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, CASE WHEN AT_ETHNICITY_DESC.CODE = 'W8' THEN 'White: Gypsy or Irish Traveller' WHEN AT_ETHNICITY_DESC.CODE = 'O1' THEN 'Asian/Asian British: Chinese' ELSE AT_ETHNICITY_DESC.DESCRIPTION END AS ETHNIC_DESC_, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, CASE WHEN AT_OFFENDER.RACE_CODE = 'W8' THEN 'W3' WHEN AT_OFFENDER.RACE_CODE = 'O1' THEN 'A4' ELSE AT_OFFENDER.RACE_CODE END AS ETHNIC_CODE FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.REFERENCE_CODES AT_ETHNICITY_DESC, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_ETHNICITY_DESC.DOMAIN (+) = 'ETHNICITY') AND (AT_ETHNICITY_DESC.CODE (+) = AT_OFFENDER.RACE_CODE) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O')) GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, CASE WHEN AT_ETHNICITY_DESC.CODE = 'W8' THEN 'White: Gypsy or Irish Traveller' WHEN AT_ETHNICITY_DESC.CODE = 'O1' THEN 'Asian/Asian British: Chinese' ELSE AT_ETHNICITY_DESC.DESCRIPTION END, CASE WHEN AT_OFFENDER.RACE_CODE = 'W8' THEN 'W3' WHEN AT_OFFENDER.RACE_CODE = 'O1' THEN 'A4' ELSE AT_OFFENDER.RACE_CODE END), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, ETHNIC_DESC_, NUMBER_OF_OFFENDERS, ETHNIC_CODE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP2.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP2.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "ETHNIC_DESC_",
            "type": "string",
            "display": "Ethnic Desc.",
            "legacyId": "DP2.DOc28",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP2.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "ETHNIC_CODE",
            "type": "string",
            "display": "Ethnic Code",
            "legacyId": "DP2.DO88",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3377299/DP3",
      "name": "Category",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, CASE WHEN TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) <= 17 THEN 'Juvenile' WHEN TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) >= 18 AND TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) <= 20 THEN 'Young Person' ELSE 'Adult' END AS ADULT_YOUNG_PERSON_JUVENILE_37, AT_HEADER_BLOCK.STATUS_2 FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.V_HEADER_BLOCK AT_HEADER_BLOCK, USER_ACCESSIBLE_CASELOADS, (SELECT oa.offender_book_id, oa.assessment_seq, oa.assess_status, oa.review_place_agy_loc_id, oa.assessment_date, oa.calc_sup_level_type, oa.overrided_sup_level_type, oa.review_sup_level_type, oa.next_review_date, rc.description AS review_sup_level_description, oa.evaluation_result_code, ROW_NUMBER() OVER (PARTITION BY oa.offender_book_id ORDER BY CASE WHEN oa.assess_status <> 'I' THEN 1 ELSE 2 END, oa.assessment_date DESC, oa.assessment_seq DESC) AS row_seq_filter FROM offender_assessments oa INNER JOIN assessments a ON a.assessment_id = oa.assessment_type_id AND a.assessment_class = 'TYPE' AND a.assessment_code = 'CATEGORY' AND a.determine_sup_level_flag = 'Y' LEFT OUTER JOIN reference_codes rc ON rc.code = oa.review_sup_level_type AND rc.domain = 'SUP_LVL_TYPE') DT_CATEGORISATION WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_HEADER_BLOCK.OFFENDER_BOOK_ID (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_CATEGORISATION.OFFENDER_BOOK_ID (+)) AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O') AND (DT_CATEGORISATION.row_seq_filter = 1 OR DT_CATEGORISATION.row_seq_filter IS NULL)) GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, CASE WHEN TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) <= 17 THEN 'Juvenile' WHEN TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) >= 18 AND TRUNC(MONTHS_BETWEEN(CURRENT_TIMESTAMP, AT_OFFENDER.BIRTH_DATE) / 12) <= 20 THEN 'Young Person' ELSE 'Adult' END, AT_HEADER_BLOCK.STATUS_2), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, NUMBER_OF_OFFENDERS, ADULT_YOUNG_PERSON_JUVENILE_37, STATUS_2 FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP3.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP3.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP3.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "ADULT_YOUNG_PERSON_JUVENILE_37",
            "type": "string",
            "display": "Adult / Young Person / Juvenile Indicator",
            "legacyId": "DP3.DO8b9",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "STATUS_2",
            "type": "string",
            "display": "Security Category",
            "legacyId": "DP3.DO265",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3377299/DP4",
      "name": "Sentence",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END AS CONVICTED_UNCONVICTED_STATUS FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.IMPRISONMENT_STATUSES AT_IMPRISON_STATUSES_SEQ, USER_ACCESSIBLE_CASELOADS, (SELECT AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_BOOK_ID, CASE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.HDCAD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.HDCAD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.APD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.APD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.PRRD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.PRRD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.ARD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.ARD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.ARD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.ARD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.CRD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.CRD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.CRD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.CRD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.NPD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.NPD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.NPD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.NPD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.MTD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.MTD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.MTD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.MTD_CALCULATED_DATE ELSE NULL END AS Last_Rel_Date, EFFECTIVE_SENTENCE_LENGTH FROM OMS_OWNER.OFFENDER_SENT_CALCULATIONS AT_OFFENDER_SENT_CALCULATIONS WHERE AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_SENT_CALCULATION_ID = (SELECT MAX(A.OFFENDER_SENT_CALCULATION_ID) FROM OMS_OWNER.OFFENDER_SENT_CALCULATIONS A WHERE AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_BOOK_ID = A.OFFENDER_BOOK_ID)) DT_LAST_RELEASE_DATE, OMS_OWNER.OFFENDER_IMPRISON_STATUSES AT_OFFENDER_IMPRISON_STS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_LAST_RELEASE_DATE.OFFENDER_BOOK_ID (+)) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDER_IMPRISON_STS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS = AT_OFFENDER_IMPRISON_STS.IMPRISONMENT_STATUS) AND (AT_OFFENDER_IMPRISON_STS.LATEST_STATUS = 'Y') AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O') AND NOT DT_LAST_RELEASE_DATE.EFFECTIVE_SENTENCE_LENGTH IS NULL AND DT_LAST_RELEASE_DATE.EFFECTIVE_SENTENCE_LENGTH <> '00/00/00') GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, NUMBER_OF_OFFENDERS, CONVICTED_UNCONVICTED_STATUS FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP4.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP4.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP4.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "CONVICTED_UNCONVICTED_STATUS",
            "type": "string",
            "display": "Convicted / Unconvicted Status",
            "legacyId": "DP4.DO716",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3377299/DP5",
      "name": "Unsentenced",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END AS CONVICTED_UNCONVICTED_STATUS FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.IMPRISONMENT_STATUSES AT_IMPRISON_STATUSES_SEQ, USER_ACCESSIBLE_CASELOADS, (SELECT AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_BOOK_ID, CASE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.HDCAD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.HDCAD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.APD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.APD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.PRRD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.PRRD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.ARD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.ARD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.ARD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.ARD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.CRD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.CRD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.CRD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.CRD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.NPD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.NPD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.NPD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.NPD_CALCULATED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.MTD_OVERRIDED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.MTD_OVERRIDED_DATE WHEN NOT AT_OFFENDER_SENT_CALCULATIONS.MTD_CALCULATED_DATE IS NULL THEN AT_OFFENDER_SENT_CALCULATIONS.MTD_CALCULATED_DATE ELSE NULL END AS Last_Rel_Date, EFFECTIVE_SENTENCE_LENGTH FROM OMS_OWNER.OFFENDER_SENT_CALCULATIONS AT_OFFENDER_SENT_CALCULATIONS WHERE AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_SENT_CALCULATION_ID = (SELECT MAX(A.OFFENDER_SENT_CALCULATION_ID) FROM OMS_OWNER.OFFENDER_SENT_CALCULATIONS A WHERE AT_OFFENDER_SENT_CALCULATIONS.OFFENDER_BOOK_ID = A.OFFENDER_BOOK_ID)) DT_LAST_RELEASE_DATE, OMS_OWNER.OFFENDER_IMPRISON_STATUSES AT_OFFENDER_IMPRISON_STS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_LAST_RELEASE_DATE.OFFENDER_BOOK_ID (+)) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDER_IMPRISON_STS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS = AT_OFFENDER_IMPRISON_STS.IMPRISONMENT_STATUS) AND (AT_OFFENDER_IMPRISON_STS.LATEST_STATUS = 'Y') AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O') AND (DT_LAST_RELEASE_DATE.EFFECTIVE_SENTENCE_LENGTH = '00/00/00' OR DT_LAST_RELEASE_DATE.EFFECTIVE_SENTENCE_LENGTH IS NULL)) GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, NUMBER_OF_OFFENDERS, CONVICTED_UNCONVICTED_STATUS FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP5.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP5.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP5.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "CONVICTED_UNCONVICTED_STATUS",
            "type": "string",
            "display": "Convicted / Unconvicted Status",
            "legacyId": "DP5.DO716",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3377299/DP6",
      "name": "Convictions",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END AS CONVICTED_UNCONVICTED_STATUS FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.IMPRISONMENT_STATUSES AT_IMPRISON_STATUSES_SEQ, USER_ACCESSIBLE_CASELOADS, OMS_OWNER.OFFENDER_IMPRISON_STATUSES AT_OFFENDER_IMPRISON_STS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDER_IMPRISON_STS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS = AT_OFFENDER_IMPRISON_STS.IMPRISONMENT_STATUS) AND (AT_OFFENDER_IMPRISON_STS.LATEST_STATUS = 'Y') AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O')) GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, CASE WHEN AT_IMPRISON_STATUSES_SEQ.BAND_CODE IN ('9', '10', '11', '12', '13') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('SINE DIE', 'DISCONT', 'POLICE', 'DISCHARGED', 'RX', 'S48MHA') THEN 'Unconvicted' WHEN AT_IMPRISON_STATUSES_SEQ.IMPRISONMENT_STATUS IN ('UNKNOWN', 'BOBC', 'UNFIT', 'UNK_CUST', 'DIED') THEN 'Check Record' ELSE 'Convicted' END), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, NUMBER_OF_OFFENDERS, CONVICTED_UNCONVICTED_STATUS FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP6.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP6.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP6.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "CONVICTED_UNCONVICTED_STATUS",
            "type": "string",
            "display": "Convicted / Unconvicted Status",
            "legacyId": "DP6.DO716",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3377299/DP8",
      "name": "IEP Levels",
      "description": "Demographic",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, COUNT(DISTINCT AT_OFFENDER.OFFENDER_ID_DISPLAY) AS COUNT_NOMS_NUMBER, COUNT(AT_OFFENDER.OFFENDER_ID) AS NUMBER_OF_OFFENDERS, DT_CURRENT_OFFENDER_IEP_LEVEL.IEP_LEVEL FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, (SELECT offender_book_id, iep_date, iep_time, agy_loc_id, iep_level FROM (SELECT offender_book_id, iep_date, iep_time, agy_loc_id, iep_level, ROW_NUMBER() OVER (PARTITION BY offender_book_id ORDER BY iep_time DESC, iep_level_seq DESC) AS row_seq_filter FROM oms_owner.offender_iep_levels) WHERE row_seq_filter = 1) DT_CURRENT_OFFENDER_IEP_LEVEL, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (DT_CURRENT_OFFENDER_IEP_LEVEL.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_OFFENDERS_LOCATIONS.DESCRIPTION IN ('BELMARSH (HMP)') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND AT_OFFENDER_BOOKING.BOOKING_STATUS IN ('O')) GROUP BY AT_OFFENDER.OFFENDER_ID_DISPLAY, DT_CURRENT_OFFENDER_IEP_LEVEL.IEP_LEVEL), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, COUNT_NOMS_NUMBER, NUMBER_OF_OFFENDERS, IEP_LEVEL FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP8.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "COUNT_NOMS_NUMBER",
            "type": "double",
            "display": "Count NOMS Number",
            "legacyId": "DP8.DO5e4",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NUMBER_OF_OFFENDERS",
            "type": "double",
            "display": "Number of Offenders",
            "legacyId": "DP8.DO7f0",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "IEP_LEVEL",
            "type": "string",
            "display": "Current IEP Band",
            "legacyId": "DP8.DO49c",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "157597.RS",
      "name": "Ethnic Breakdown",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3377299/DP2",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:NUMBER_OF_OFFENDERS",
            "display": "Number of Offenders",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO7f0"
          }
        ]
      }
    },
    {
      "id": "169512.RS",
      "name": "Category",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3377299/DP3",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:NUMBER_OF_OFFENDERS",
            "display": "Number of Offenders",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO7f0"
          }
        ]
      }
    },
    {
      "id": "169595.RS",
      "name": "Adult,Young Person",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3377299/DP3",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:NUMBER_OF_OFFENDERS",
            "display": "Number of Offenders",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP2.DO7f0"
          }
        ]
      }
    },
    {
      "id": "169670.RS",
      "name": "Sentence",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3377299/DP6",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:COUNT_NOMS_NUMBER",
            "display": "Count NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP4.DO5e4"
          },
          {
            "name": "$ref:COUNT_NOMS_NUMBER",
            "display": "Count NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP5.DO5e4"
          }
        ]
      }
    },
    {
      "id": "170052.RS",
      "name": "IEP Levels",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3377299/DP2",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:IEP_LEVEL",
            "display": "Current IEP Band",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP8.DO49c"
          },
          {
            "name": "$ref:NUMBER_OF_OFFENDERS",
            "display": "Number of Offenders",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP8.DO7f0"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "schema",
      "error": "Report field IEP_LEVEL does not have corresponding dataset schema field",
      "entityId": "170052.RS",
      "entityType": "variant"
    }
  ]
}