{
  "id": "FiFormDTwAgAVk8BAHCrXF9yACJIAAzC",
  "name": "ORS CSIP Open Support and Intervention Plan and Open ACCT",
  "description": "Displays the number of Prisoners in their Current Establishment who have an Open Support and Intervention Plan, as well as an Open ACCT.  Also displays the total number of Prisoners on an open ACCT<br/>INC0039 v1.0 Last Modified: 26/05/2021",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "INC0039",
      "v1.0",
      "CSIP",
      "Open Support and Intervention Plans"
    ]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3375850/DP21",
      "name": "Open Supp and Interven",
      "description": "OR - Incidents",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.LAST_NAME, AT_OFFENDER_CSIP_REPORTS.CSIP_ID, AT_OFFENDER_CSIP_PLANS.PLAN_ID, AT_OFFENDER_CSIP_PLANS.CLOSED_DATE, AT_OFFENDER_CSIP_REVIEWS.CLOSE_DATE, AT_OFFENDERS_LOCATIONS.AGY_LOC_ID, AT_OFFENDERS_LOCATIONS.DESCRIPTION FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.REFERENCE_CODES AT_REF_CSIP_CONSID_OUTCOME, OMS_OWNER.REFERENCE_CODES AT_REF_CSIP_DECISION_OUTCOME, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.OFFENDER_CSIP_REPORTS AT_OFFENDER_CSIP_REPORTS, OMS_OWNER.OFFENDER_CSIP_PLANS AT_OFFENDER_CSIP_PLANS, OMS_OWNER.OFFENDER_CSIP_REVIEWS AT_OFFENDER_CSIP_REVIEWS, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER_CSIP_REPORTS.OFFENDER_BOOK_ID = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID AND AT_OFFENDER_CSIP_REPORTS.ROOT_OFFENDER_ID = AT_OFFENDER_BOOKING.ROOT_OFFENDER_ID) AND (AT_OFFENDER_CSIP_REVIEWS.CSIP_ID (+) = AT_OFFENDER_CSIP_REPORTS.CSIP_ID) AND (AT_OFFENDER_CSIP_PLANS.CSIP_ID (+) = AT_OFFENDER_CSIP_REPORTS.CSIP_ID) AND (AT_OFFENDER_CSIP_REPORTS.CDR_OUTCOME = AT_REF_CSIP_CONSID_OUTCOME.CODE (+)) AND (AT_OFFENDER_CSIP_REPORTS.INV_OUTCOME = AT_REF_CSIP_DECISION_OUTCOME.CODE (+)) AND (AT_REF_CSIP_DECISION_OUTCOME.domain (+) = 'CSIP_OUT') AND (AT_REF_CSIP_CONSID_OUTCOME.domain (+) = 'CSIP_OUT') AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND ((AT_OFFENDERS_LOCATIONS.AGY_LOC_ID IN (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3) */) OR 'All' IN (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3) */)) AND (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND (AT_REF_CSIP_CONSID_OUTCOME.DESCRIPTION = 'Progress to CSIP' OR AT_REF_CSIP_DECISION_OUTCOME.DESCRIPTION = 'Progress to CSIP') AND NOT AT_OFFENDER_CSIP_PLANS.PLAN_ID IS NULL)), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, LAST_NAME, CSIP_ID, PLAN_ID, CLOSED_DATE, CLOSE_DATE, AGY_LOC_ID, DESCRIPTION, 'TBD' AS V_COUNT_ACCT_ALL FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP21.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP21.DO10045",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "CSIP_ID",
            "type": "double",
            "display": "RFR CSIP ID",
            "legacyId": "DP21.DO65c",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "PLAN_ID",
            "type": "double",
            "display": "PLN Plan Id",
            "legacyId": "DP21.DO69b",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "CLOSED_DATE",
            "type": "date",
            "display": "PLN Closed Date",
            "legacyId": "DP21.DO6a1",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "CLOSE_DATE",
            "type": "date",
            "display": "REV Close Date",
            "legacyId": "DP21.DO6ad",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "AGY_LOC_ID",
            "type": "string",
            "display": "Establishment Code",
            "legacyId": "DP21.DO1043b",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DP21.DO1033b",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "V_COUNT_ACCT_ALL",
            "type": "string",
            "display": "V_COUNT_ACCT_ALL",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3375850/DP28",
      "name": "ACCT",
      "description": "OR - Incidents",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER_ALERTS.ALERT_CODE, AT_ALERT_TYPE_DESC.DESCRIPTION, AT_OFFENDERS_LOCATIONS.AGY_LOC_ID FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.REFERENCE_CODES AT_ALERT_TYPE_DESC, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.OFFENDER_ALERTS AT_OFFENDER_ALERTS, USER_ACCESSIBLE_CASELOADS WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDER_ALERTS.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_ALERT_TYPE_DESC.CODE (+) = AT_OFFENDER_ALERTS.ALERT_CODE) AND (AT_ALERT_TYPE_DESC.DOMAIN = 'ALERT_CODE' OR AT_ALERT_TYPE_DESC.DOMAIN IS NULL) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */))) AND ((AT_OFFENDER_ALERTS.ALERT_STATUS = 'ACTIVE') AND AT_OFFENDER_ALERTS.ALERT_CODE = 'HA' AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID IN (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3) */) OR 'All' IN (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3) */)) AND (AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, ALERT_CODE, DESCRIPTION, AGY_LOC_ID, 'TBD' AS V_COUNT_ACCT_ALL FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code (All for all)','A','Establishment\\Establishment Code',multi,free,,Not_Persistent,,User:3)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP28.DO10044",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "ALERT_CODE",
            "type": "string",
            "display": "Alert Type Code",
            "legacyId": "DP28.DO1007e",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Alert Description",
            "legacyId": "DP28.DO10097",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "AGY_LOC_ID",
            "type": "string",
            "display": "Establishment Code",
            "legacyId": "DP28.DO1043b",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "V_COUNT_ACCT_ALL",
            "type": "string",
            "display": "V_COUNT_ACCT_ALL",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "175473.RS",
      "name": "CSIP and ACCT",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3375850/DP21",
      "filter": {
        "name": "prefilter_",
        "query": "prefilter_ AS (SELECT * FROM dataset_ WHERE (V_OPEN_INTERVENTIONS_CLOSED_38 = 1 OR V_OPEN_REVIEW_CLOSED_INTERVE37 = 1 OR V_OPEN_REVIEW_OPEN_INTERVENT35 = 1))"
      },
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-tab",
        "field": [
          {
            "name": "$ref:AGY_LOC_ID",
            "display": "Establishment Code",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP28.DO1043b"
          },
          {
            "name": "$ref:DESCRIPTION",
            "display": "Establishment Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP21.DO1033b"
          },
          {
            "name": "$ref:V_COUNT_ACCT_ALL",
            "display": "All Prisoners with Open ACCTs",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=Count([ACCT].[NOMS Number]) Where([v_ACCT_Alert_All] = 1 )In ([ACCT].[Establishment Code])"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_COUNT_ACCT_ALL :: Error: =Count([ACCT].[NOMS Number]) Where([v_ACCT_Alert_All] = 1 )In ([ACCT].[Establishment Code]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "FiFormDTwAgAVk8BAHCrXF9yACJIAAzC",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_COUNT_ACCT_ALL :: Error: =Count([ACCT].[NOMS Number]) Where([v_ACCT_Alert_All] = 1 )In ([ACCT].[Establishment Code]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "FiFormDTwAgAVk8BAHCrXF9yACJIAAzC",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_COUNT_ACCT_ALL :: Error: =Count([ACCT].[NOMS Number]) Where([v_ACCT_Alert_All] = 1 )In ([ACCT].[Establishment Code]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "FiFormDTwAgAVk8BAHCrXF9yACJIAAzC",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_COUNT_ACCT_ALL :: Error: =Count([ACCT].[NOMS Number]) Where([v_ACCT_Alert_All] = 1 )In ([ACCT].[Establishment Code]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "FiFormDTwAgAVk8BAHCrXF9yACJIAAzC",
      "entityType": "dpd"
    }
  ]
}