{
  "id": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
  "name": "MIS Current Snapshot of Prisoners including CPA and Time Left to Serve",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "PDD0106",
      "CPA",
      "Time Left to Serve"
    ]
  },
  "description": "Returns Prisoner who are on the Prison roll, along with their Security Category, Sentence Length, Legal Status, Main Offence, Admission Date, Previous Location, length of Stay, Primary Address, Rehabilitation Provider, Release Date and Days left to serve.<br/>PDD0106 v.1.0 Last Modified: 26/06/2019",
  "datasource": [
    {
      "id": "bodmis",
      "name": "BODMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "bodmis"
    }
  ],
  "dataset": [
    {
      "id": "3375368/DP9",
      "name": "All Prisoners",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_OFFENDER_BOOKING.FIRST_NAME, CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END AS DATE_OF_BIRTH, FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12) AS OFFENDER_AGE, AT_OFFENDER_BOOKING.MAIN_LEGAL_STATUS_CODE, AT_DIM_LOCATION.UNIT_4_SHORT_DESCRIPTION, CASE WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) IS NULL THEN NULL WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) < 1 THEN 'Under 1 year' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 1 AND 6 THEN '1 to 6 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 7 AND 11 THEN '7 to 11 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 12 AND 16 THEN '12 to 16 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) > 16 AND (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) < 18 THEN '16 to 17 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 18 AND 21 THEN '18 to 21 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 22 AND 29 THEN '22 to 29 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 30 AND 39 THEN '30 to 39 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 40 AND 49 THEN '40 to 49 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 50 AND 59 THEN '50 to 59 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) BETWEEN 60 AND 69 THEN '60 to 69 years' WHEN (FLOOR((MONTHS_BETWEEN((TRUNC(CURRENT_TIMESTAMP)), (CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END))) / 12)) >= 70 THEN '70 or over' END AS AGE_BAND, DT_ALL_LOCATIONS.LOCATION_DESC, CASE WHEN AT_DIM_OFFENDER_ASSESSMENTS.CURRENT_SEC_CAT_LEVEL IS NULL THEN 'Unclassfied' ELSE AT_DIM_OFFENDER_ASSESSMENTS.CURRENT_SEC_CAT_LEVEL END AS SECURITY_CATEGORY_CURRENT_LE31, AT_OFFENDER_BOOKING.SURNAME, CASE WHEN DT_LIFEFLAG.LIFE_SENTENCE_FLAG = 'Y' THEN 'Life' ELSE FACT_CURR_KEY_DATES_SENT.EFFECTIVE_SENTENCE_LENGTH END AS EFFECTIVE_SENTENCE_LENGTH, DT_ADMISSION.MOVEMENT_TIME, FACT_CURR_KEY_DATES_SENT.CURR_RELEASE_DATE, FACT_CURR_KEY_DATES_SENT.SSD FROM (SELECT establishment_sk AS LOCATION_SK, establishment_description AS LOCATION_DESC, 'Establishment' AS LOCATION_TYPE FROM bodimis.dim_establishment UNION SELECT court_sk, court_description, 'Court' FROM bodimis.dim_court UNION SELECT probation_office_sk, prob_office_description, 'Probation Office' FROM bodimis.dim_probation_office UNION SELECT outside_location_sk, outside_location_description, 'Outside Location' FROM bodimis.dim_outside_location) DT_ALL_LOCATIONS, (SELECT ob.offender_id_display, fme.offender_booking_sk, est.establishment_code_nk, fme.to_location_sk, fme.from_location_sk, fme.from_location_type, MAX(fme.MOVEMENT_SEQ) AS MOVEMENT_SEQ, MAX(d.day_date) AS MOVEMENT_TIME, TRUNC(ETL.LOAD_END_DATETIME) AS LOAD_DATE FROM BODIMIS.FACT_MOVEMENT_EXTERNAL fme, BODIMIS.DIM_OFFENDER_BOOKING ob, BODIMIS.DIM_ESTABLISHMENT est, BODIMIS.ETL_LOAD_LOG ETL, BODIMIS.DIM_DATE d WHERE ob.ESTABLISHMENT_SK = est.ESTABLISHMENT_SK AND d.date_sk = fme.date_sk AND fme.offender_booking_sk = ob.offender_booking_sk AND ob.active_status IN ('Active In', 'Active Out') AND ob.MIS_CURRENT_RECORD_IND = 'Y' AND ob.ACTIVE_FLAG = 'Y' AND ETL.LOAD_ID = (SELECT MAX(LOAD_ID) FROM BODIMIS.ETL_LOAD_LOG WHERE NOT LOAD_END_DATETIME IS NULL) AND ob.ESTABLISHMENT_SK = fme.to_location_sk AND fme.movement_seq = (SELECT MAX(fme2.movement_seq) FROM BODIMIS.FACT_MOVEMENT_EXTERNAL fme2 WHERE fme.offender_booking_sk = fme2.offender_booking_sk AND fme2.direction_code = 'IN' AND fme2.TYPE = 'Admission' AND fme2.To_location_type = 'Establishment' AND fme2.reason_code <> 'R') GROUP BY ob.offender_id_display, fme.offender_booking_sk, est.establishment_code_nk, fme.to_location_sk, fme.from_location_sk, fme.from_location_type, ETL.LOAD_END_DATETIME) DT_ADMISSION, BODIMIS.DIM_CELL AT_DIM_LOCATION, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_DATE AT_DOB, BODIMIS.DIM_OFFENDER_ASSESSMENT AT_DIM_OFFENDER_ASSESSMENTS, (SELECT DISTINCT BODIMIS.FACT_CASE_SENTENCE_TERM.offender_booking_sk, BODIMIS.FACT_CASE_SENTENCE_TERM.LIFE_SENTENCE_FLAG FROM BODIMIS.FACT_CASE_SENTENCE_TERM, BODIMIS.FACT_CASE_SENTENCE, BODIMIS.DIM_SENTENCE_STATUS dss WHERE (BODIMIS.FACT_CASE_SENTENCE.SENTENCE_STATUS_SK = dss.sentence_status_sk) AND dss.sentence_status = 'Active' AND (BODIMIS.FACT_CASE_SENTENCE.OFFENDER_BOOKING_SK = BODIMIS.FACT_CASE_SENTENCE_TERM.OFFENDER_BOOKING_SK) AND (BODIMIS.FACT_CASE_SENTENCE.SENTENCE_SEQ_NK = BODIMIS.FACT_CASE_SENTENCE_TERM.SENTENCE_SEQ_NK) AND (BODIMIS.FACT_CASE_SENTENCE.COURT_CASE_SK = BODIMIS.FACT_CASE_SENTENCE_TERM.COURT_CASE_SK) AND BODIMIS.FACT_CASE_SENTENCE_TERM.LIFE_SENTENCE_FLAG = 'Y') DT_LIFEFLAG, FACT_CURR_KEY_DATES_SENT WHERE (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = DT_LIFEFLAG.OFFENDER_BOOKING_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = FACT_CURR_KEY_DATES_SENT.OFFENDER_BOOKING_SK (+)) AND (AT_OFFENDER_BOOKING.BIRTH_DATE_SK = AT_DOB.DATE_SK) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */)) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = DT_ADMISSION.OFFENDER_BOOKING_SK (+)) AND (DT_ADMISSION.FROM_LOCATION_SK = DT_ALL_LOCATIONS.LOCATION_SK (+) AND DT_ADMISSION.FROM_LOCATION_TYPE = DT_ALL_LOCATIONS.LOCATION_TYPE (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = AT_DIM_OFFENDER_ASSESSMENTS.OFFENDER_BOOKING_SK (+)) AND (AT_OFFENDER_BOOKING.LIVING_UNIT_SK = AT_DIM_LOCATION.UNIT_4_SK (+)) AND ((AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND (AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK = (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69) */)))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, FIRST_NAME, DATE_OF_BIRTH, OFFENDER_AGE, MAIN_LEGAL_STATUS_CODE, UNIT_4_SHORT_DESCRIPTION, AGE_BAND, LOCATION_DESC, SECURITY_CATEGORY_CURRENT_LE31, SURNAME, EFFECTIVE_SENTENCE_LENGTH, MOVEMENT_TIME, CURR_RELEASE_DATE, SSD, REHAB_PROVIDER_DESCRIPTION AS V_REHAB_PROVIDER, (TO_DATE(TRUNC(SYSDATE), 'DD/MM/YYYY') - TO_DATE(CURR_RELEASE_DATE, 'DD/MM/YYYY')) AS V_TIME_LEFT_TO_SERVE, (TO_DATE(MOVEMENT_TIME, 'DD/MM/YYYY') - TO_DATE(TRUNC(SYSDATE), 'DD/MM/YYYY')) AS V_LENGTH_OF_STAY, OFFENDER_ADDRESS_FULL AS V_PRIMARY_ADDRESS, 'TBD' AS V_MAX_CONCAT_OFFENCE FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP9.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "Offender Given Name 1",
            "legacyId": "DP9.DO10080",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "DATE_OF_BIRTH",
            "type": "date",
            "display": "Date of Birth",
            "legacyId": "DP9.DO10085",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "OFFENDER_AGE",
            "type": "double",
            "display": "Offender Age",
            "legacyId": "DP9.DO10082",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "MAIN_LEGAL_STATUS_CODE",
            "type": "string",
            "display": "Main Legal Status Code",
            "legacyId": "DP9.DO100de",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "UNIT_4_SHORT_DESCRIPTION",
            "type": "string",
            "display": "Prisoner Location",
            "legacyId": "DP9.DO10a7c",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "AGE_BAND",
            "type": "string",
            "display": "Age Band",
            "legacyId": "DP9.DO107fd",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "LOCATION_DESC",
            "type": "string",
            "display": "Previous Location on Admission",
            "legacyId": "DP9.DO10805",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "SECURITY_CATEGORY_CURRENT_LE31",
            "type": "string",
            "display": "Security Category - Current Level",
            "legacyId": "DP9.DO10832",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "SURNAME",
            "type": "string",
            "display": "Offender Surname",
            "legacyId": "DP9.DO1007b",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "EFFECTIVE_SENTENCE_LENGTH",
            "type": "string",
            "display": "Effective Sentence Length",
            "legacyId": "DP9.DO2d0",
            "legacySqlClass": "column"
          },
          {
            "index": 11,
            "name": "MOVEMENT_TIME",
            "type": "date",
            "display": "Admission Date",
            "legacyId": "DP9.DO107ce",
            "legacySqlClass": "column"
          },
          {
            "index": 12,
            "name": "CURR_RELEASE_DATE",
            "type": "date",
            "display": "Current Release Date",
            "legacyId": "DP9.DO2e6",
            "legacySqlClass": "column"
          },
          {
            "index": 13,
            "name": "SSD",
            "type": "date",
            "display": "Current Sentence Start Date",
            "legacyId": "DP9.DO32d",
            "legacySqlClass": "column"
          },
          {
            "index": 14,
            "name": "V_REHAB_PROVIDER",
            "type": "string",
            "display": "V_REHAB_PROVIDER",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 15,
            "name": "V_TIME_LEFT_TO_SERVE",
            "type": "string",
            "display": "V_TIME_LEFT_TO_SERVE",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 16,
            "name": "V_LENGTH_OF_STAY",
            "type": "string",
            "display": "V_LENGTH_OF_STAY",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 17,
            "name": "V_PRIMARY_ADDRESS",
            "type": "string",
            "display": "V_PRIMARY_ADDRESS",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 18,
            "name": "V_MAX_CONCAT_OFFENCE",
            "type": "string",
            "display": "V_MAX_CONCAT_OFFENCE",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3375368/DPc",
      "name": "Main Offence",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_DIM_OFFENCE.OFFENCE_NAME FROM BODIMIS.DIM_OFFENCE AT_DIM_OFFENCE, BODIMIS.FACT_COURT_CHARGE AT_FACT_COURT_CHARGE, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_COURT_CASE AT_COURT_CASE WHERE (AT_FACT_COURT_CHARGE.OFFENCE_SK = AT_DIM_OFFENCE.OFFENCE_SK (+)) AND (AT_COURT_CASE.COURT_CASE_SK = AT_FACT_COURT_CHARGE.COURT_CASE_SK (+)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */)) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_COURT_CASE.OFFENDER_BOOKING_SK IS NULL OR AT_COURT_CASE.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */)) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND ((AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND (AT_FACT_COURT_CHARGE.MOST_SERIOUS_FLAG = 'Y' AND AT_COURT_CASE.MOST_SERIOUS_COUNT = 1) AND (AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK = (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69) */)))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, OFFENCE_NAME FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DPc.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENCE_NAME",
            "type": "string",
            "display": "Offence Name",
            "legacyId": "DPc.DO4b",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3375368/DPa",
      "name": "CPA",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, CASE WHEN BODIMIS.DIM_REHAB_PROVIDER.REHAB_PROVIDER_SK > 0 THEN BODIMIS.DIM_REHAB_PROVIDER.DESCRIPTION END AS REHAB_PROVIDER_DESCRIPTION FROM BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_REHAB_PROVIDER, BODIMIS.FACT_OFFENDER_REHAB WHERE (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER((SELECT username FROM context_ /* = #Variable('BOUSER') */)) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = BODIMIS.FACT_OFFENDER_REHAB.OFFENDER_BOOKING_SK (+)) AND (BODIMIS.FACT_OFFENDER_REHAB.REHAB_PROVIDER_SK = BODIMIS.DIM_REHAB_PROVIDER.REHAB_PROVIDER_SK (+)) AND ((AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y') AND (AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK = (SELECT ESTABLISHMENT_CODE FROM prompt_ /* = #Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69) */)) AND (BODIMIS.FACT_OFFENDER_REHAB.PROVIDER_ACTIVE_FLAG = 'Y' OR BODIMIS.FACT_OFFENDER_REHAB.PROVIDER_ACTIVE_FLAG IS NULL) AND (BODIMIS.FACT_OFFENDER_REHAB.DECISION_ACTIVE_FLAG IS NULL OR BODIMIS.FACT_OFFENDER_REHAB.DECISION_ACTIVE_FLAG = 'Y'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, REHAB_PROVIDER_DESCRIPTION FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DPa.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "REHAB_PROVIDER_DESCRIPTION",
            "type": "string",
            "display": "Rehab Provider Description",
            "legacyId": "DPa.DO10b38",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3375368/DPd",
      "name": "Addresses",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, DT_OFFENDER_ADDRESSES.FLAT || ' '|| DT_OFFENDER_ADDRESSES.PREMISE || ' '|| DT_OFFENDER_ADDRESSES.STREET || ' '|| DT_OFFENDER_ADDRESSES.LOCALITY || ' '|| DT_OFFENDER_ADDRESSES.CITY_DESC || ' '|| DT_OFFENDER_ADDRESSES.POSTAL_CODE || ' '|| DT_OFFENDER_ADDRESSES.COUNTRY_DESC FROM BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, ( select ROW_NUMBER() OVER (PARTITION BY ss.OWNER_ID ORDER BY PRIMARY_FLAG desc, ss.address_active_flag desc, ss.USAGE_ACTIVE_FLAG desc, ss.usages_dttm DESC nulls last) row_seq_filter, ss.* from ( select * from ( select AT_DIM_ADDRESSES.OWNER_ID, AT_DIM_ADDRESS_USAGES.ADDRESS_ID_NK, AT_DIM_ADDRESS_USAGES.ADDRESS_USAGE, AT_DIM_ADDRESS_USAGES.ADDR_USAGE_DESCRIPTION, AT_DIM_ADDRESS_USAGES.ACTIVE_FLAG as USAGE_ACTIVE_FLAG, AT_DIM_ADDRESSES.flat, AT_DIM_ADDRESSES.premise, AT_DIM_ADDRESSES.Street, AT_DIM_ADDRESSES.locality, AT_DIM_ADDRESSES.city_code, AT_DIM_ADDRESSES.city_desc, AT_DIM_ADDRESSES.county_code, AT_DIM_ADDRESSES.county_desc, AT_DIM_ADDRESSES.postal_code, AT_DIM_ADDRESSES.COUNTRY_CODE, AT_DIM_ADDRESSES.country_desc, AT_DIM_ADDRESSES.HOME_TEL_NO, AT_DIM_ADDRESSES.HOME_EXT_NO, AT_DIM_ADDRESSES.NO_FIXED_ADDRESS_FLAG, AT_DIM_ADDRESSES.establishment_sk, AT_DIM_ADDRESSES.PRIMARY_FLAG, AT_DIM_ADDRESSES.active_flag as address_active_flag, AT_DIM_ADDRESS_USAGES.CREATE_DATETIME, AT_DIM_ADDRESS_USAGES.MODIFY_DATETIME, COALESCE(AT_DIM_ADDRESS_USAGES.modify_datetime, AT_DIM_ADDRESS_USAGES.create_datetime) as usages_dttm from BODIMIS.DIM_ADDRESS_USAGES AT_DIM_ADDRESS_USAGES inner join BODIMIS.dim_addresses AT_DIM_ADDRESSES on AT_DIM_ADDRESS_USAGES.address_id_nk = AT_DIM_ADDRESSES.address_id_nk and AT_DIM_ADDRESSES.owner_class='OFF'  ) Addr_usages --where Addr_usages.usages_dttm is not null ) ss ) DT_OFFENDER_ADDRESSES, BODISTAGING.REF_OFFENDERS AT_BODISTAG_REF_OFFENDERS WHERE ( AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID=CSL.CASELOAD_CODE AND SAC.USERNAME = UPPER((SELECT username FROM context_ /*= #Variable('BOUSER') */ )) AND CSL.ENDYEAR >= to_char(sysdate,'YYYY')-6 ) ) AND ( AT_OFFENDER_BOOKING.ESTABLISHMENT_SK=AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK ) AND ( AT_ESTABLISHMENT_TAP.ACTIVE_FLAG='Y' ) AND ( AT_OFFENDER_BOOKING.OFFENDER_ID=AT_BODISTAG_REF_OFFENDERS.OFFENDER_ID(+) ) AND ( AT_BODISTAG_REF_OFFENDERS.ROOT_OFFENDER_ID=DT_OFFENDER_ADDRESSES.OWNER_ID(+) ) AND ( ( AT_OFFENDER_BOOKING.ACTIVE_FLAG = 'Y' ) AND ( DT_OFFENDER_ADDRESSES.ADDRESS_ACTIVE_FLAG='Y' ) AND ( AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK =(SELECT ESTABLISHMENT_CODE FROM prompt_ /*= #Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69) */ ) ) AND DT_OFFENDER_ADDRESSES.PRIMARY_FLAG = 'Y' )), dataset_ AS (SELECT FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "@Prompt('Establishment Code','A','Associated Establishment\\Associated Establishment Code',mono,free,Not_Persistent,User:69)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": []
      }
    },
    {
      "id": "3375368/DP3",
      "name": "Load End Date",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT BODIMIS.ETL_LOAD_LOG.BUSINESS_DATE FROM BODIMIS.ETL_LOAD_LOG WHERE (BODIMIS.ETL_LOAD_LOG.LOAD_ID = (SELECT MAX(LOAD_ID) FROM BODIMIS.ETL_LOAD_LOG WHERE NOT LOAD_END_DATETIME IS NULL))), dataset_ AS (SELECT BUSINESS_DATE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "BUSINESS_DATE",
            "type": "date",
            "display": "Latest Business Date Available",
            "legacyId": "DP3.DO104dd",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "137660.RS",
      "name": "All Prisoners",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3375368/DP9",
      "filter": {
        "name": "prefilter_",
        "query": "prefilter_ AS (SELECT * FROM dataset_)"
      },
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:SURNAME",
            "display": "Offender Surname",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO1007b"
          },
          {
            "name": "$ref:SSD",
            "display": "Current Sentence Start Date",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO32d"
          },
          {
            "name": "$ref:EFFECTIVE_SENTENCE_LENGTH",
            "display": "Effective Sentence Length",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO2d0"
          },
          {
            "name": "$ref:MOVEMENT_TIME",
            "display": "Admission Date",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO107ce"
          },
          {
            "name": "$ref:CURR_RELEASE_DATE",
            "display": "Current Release Date",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO2e6"
          },
          {
            "name": "$ref:V_REHAB_PROVIDER",
            "display": "Rehab Provider",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[Rehab Provider Description]"
          },
          {
            "name": "$ref:V_TIME_LEFT_TO_SERVE",
            "display": "Days Left to Serve",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=DaysBetween(CurrentDate();[Current Release Date])"
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "Offender Given Name 1",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10080"
          },
          {
            "name": "$ref:DATE_OF_BIRTH",
            "display": "Date of Birth",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10085"
          },
          {
            "name": "$ref:OFFENDER_AGE",
            "display": "Offender Age",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10082"
          },
          {
            "name": "$ref:UNIT_4_SHORT_DESCRIPTION",
            "display": "Prisoner Location",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10a7c"
          },
          {
            "name": "$ref:SECURITY_CATEGORY_CURRENT_LE31",
            "display": "Security Category - Current Level",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10832"
          },
          {
            "name": "$ref:LOCATION_DESC",
            "display": "Previous Location on Admission",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO10805"
          },
          {
            "name": "$ref:V_LENGTH_OF_STAY",
            "display": "Length of Stay",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=DaysBetween([Admission Date];CurrentDate())"
          },
          {
            "name": "$ref:V_PRIMARY_ADDRESS",
            "display": "Primary Address",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[Offender Address Full]"
          },
          {
            "name": "$ref:MAIN_LEGAL_STATUS_CODE",
            "display": "Main Legal Status Code",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP9.DO100de"
          },
          {
            "name": "$ref:V_MAX_CONCAT_OFFENCE",
            "display": "Main Offence",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[v_concat_offence] Where ([Offence Name]= [v_max_offence]) In ([NOMS Number])"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_REHAB_PROVIDER :: ReferenceError: error is not defined",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_PRIMARY_ADDRESS :: ReferenceError: error is not defined",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_MAX_CONCAT_OFFENCE :: Error: =[v_concat_offence] Where ([Offence Name]= [v_max_offence]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:61",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_REHAB_PROVIDER :: ReferenceError: error is not defined",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_PRIMARY_ADDRESS :: ReferenceError: error is not defined",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_MAX_CONCAT_OFFENCE :: Error: =[v_concat_offence] Where ([Offence Name]= [v_max_offence]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:61",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::fixSqlFormatting sql is not valid [Expecting ). Line 1, Col: 1792.\n  ESS_USAGES.address_id_nk = AT_DIM_ADDRESSES.address_id_nk and AT_DIM_ADDRESSES.owner_class='OFF'  ) \u001b[4mAddr_usages\u001b[0m --where Addr_usages.usages_dttm is not null ) ss ) DT_OFFENDER_ADDRESSES, BODISTAGING.REF_OFFENDERS]",
      "entityId": "FpqotVyvmgYAp3wAAHCLFV8MACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "schema",
      "error": "Dataset does not have any schema fields (comments -- in query)",
      "entityId": "3375368/DPd",
      "entityType": "dataset"
    },
    {
      "type": "athenQuery",
      "error": "Error: Error: Query failed: GENERIC_USER_ERROR: Failed To Get Query Passthrough Schema",
      "entityId": "3375368/DP9",
      "entityType": "dataset"
    },
    {
      "type": "athenQuery",
      "error": "unable to generate test sql",
      "entityId": "3375368/DPd",
      "entityType": "dataset"
    }
  ]
}