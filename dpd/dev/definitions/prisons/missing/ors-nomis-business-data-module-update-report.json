{
  "id": "okg_p9sABadHU80APgGEcEP6YxE",
  "name": "ORS NOMIS Business Data Module Update Report",
  "description": "This report lists the database activity in C-NOMIS maintenance screen(s) within a default period of the last 7 days. The end user can change the default period at runtime. The data is grouped by date and the user who made the changes.<br/>CAD0008 - v00.00.04 ",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "CAD0008 v00.00.04 drop9.9"
    ]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3375624/DP0",
      "name": "Business Data Module Update",
      "description": "C-NOMIS Audit",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AUDITREF.STAFF_MEMBERS.LAST_NAME, AUDITREF.STAFF_MEMBERS.FIRST_NAME, COALESCE(AUDITREF.STAFF_USER_ACCOUNTS.USERNAME, 'N/A') AS NOMIS_USER_ACCOUNT_NAME, COALESCE(AUDITREF.STAFF_USER_ACCOUNTS.STAFF_USER_TYPE, 'N/A') AS NOMIS_USER_ACCOUNT_TYPE, AUDITREF.STAFF_USER_ACCOUNTS.WORKING_CASELOAD_ID, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_USER_ID, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_IP_ADDRESS, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_WORKSTATION_NAME, TRUNC(AUDITDATA.AUDIT_TABLE.AUDIT_TIMESTAMP) AS AT_DATE_OF_CHANGE_, AUDITDATA.AUDIT_TABLE.LCR_COMMAND_TYPE, AUDITDATA.AUDIT_TABLE.AUDIT_MODULE_NAME, AUDITDATA.AUDIT_TABLE.LCR_OBJECT_NAME, OLD.LCR_COLUMN_NAME, auditdata.GETREFDATA(OLD.LCR_COLUMN_NAME, OLD.LCR_COLUMN_VALUE) AS AT_OLD_VALUE, auditdata.GETREFDATA(NEW.LCR_COLUMN_NAME, NEW.LCR_COLUMN_VALUE) AS AT_NEW_VALUE FROM AUDITDATA.AUDIT_COLUMN OLD, AUDITDATA.AUDIT_COLUMN NEW, AUDITDATA.AUDIT_TABLE, AUDITREF.STAFF_MEMBERS, AUDITREF.STAFF_USER_ACCOUNTS, AUDITREF.OMS_MODULES APPLICATION_MODULES WHERE (AUDITREF.STAFF_USER_ACCOUNTS.STAFF_ID = AUDITREF.STAFF_MEMBERS.STAFF_ID) AND (AUDITREF.STAFF_USER_ACCOUNTS.USERNAME = AUDITDATA.AUDIT_TABLE.AUDIT_USER_ID) AND (OLD.LCR_COLUMN_OLD_NEW_IND = '0') AND (NEW.AUDIT_TABLE_SEQ (+) = OLD.AUDIT_TABLE_SEQ AND NEW.LCR_SOURCE_TIME (+) = OLD.LCR_SOURCE_TIME AND NEW.LCR_COLUMN_NAME (+) = OLD.LCR_COLUMN_NAME) AND (NEW.LCR_COLUMN_OLD_NEW_IND (+) = '1') AND (AUDITDATA.AUDIT_TABLE.AUDIT_TABLE_SEQ = OLD.AUDIT_TABLE_SEQ AND AUDITDATA.AUDIT_TABLE.LCR_SOURCE_TIME = OLD.LCR_SOURCE_TIME) AND (APPLICATION_MODULES.MODULE_NAME = AUDITDATA.AUDIT_TABLE.AUDIT_MODULE_NAME) AND ((APPLICATION_MODULES.MODULE_NAME = 'OIMAGPAY') AND (TRUNC(AUDITDATA.AUDIT_TABLE.AUDIT_TIMESTAMP) >= TRUNC(CURRENT_TIMESTAMP - 7)) AND AUDITDATA.AUDIT_TABLE.LCR_COMMAND_TYPE <> 'INSERT' AND (NOT NEW.LCR_COLUMN_NAME (+) IN ('attribute_seq', 'create_date', 'create_datetime', 'create_user_id')) AND AUDITDATA.AUDIT_TABLE.LCR_OBJECT_OWNER = 'OMS_OWNER') UNION SELECT DISTINCT AUDITREF.STAFF_MEMBERS.LAST_NAME, AUDITREF.STAFF_MEMBERS.FIRST_NAME, COALESCE(AUDITREF.STAFF_USER_ACCOUNTS.USERNAME, 'N/A') AS NOMIS_USER_ACCOUNT_NAME, COALESCE(AUDITREF.STAFF_USER_ACCOUNTS.STAFF_USER_TYPE, 'N/A') AS NOMIS_USER_ACCOUNT_TYPE, AUDITREF.STAFF_USER_ACCOUNTS.WORKING_CASELOAD_ID, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_USER_ID, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_IP_ADDRESS, AUDITDATA.AUDIT_TABLE.AUDIT_CLIENT_WORKSTATION_NAME, TRUNC(AUDITDATA.AUDIT_TABLE.AUDIT_TIMESTAMP) AS AT_DATE_OF_CHANGE_, AUDITDATA.AUDIT_TABLE.LCR_COMMAND_TYPE, AUDITDATA.AUDIT_TABLE.AUDIT_MODULE_NAME, AUDITDATA.AUDIT_TABLE.LCR_OBJECT_NAME, NEW.LCR_COLUMN_NAME, '' AS AT_OLD_VALUE, auditdata.GETREFDATA(NEW.LCR_COLUMN_NAME, NEW.LCR_COLUMN_VALUE) AS AT_NEW_VALUE FROM AUDITDATA.AUDIT_COLUMN NEW, AUDITDATA.AUDIT_TABLE, AUDITREF.STAFF_MEMBERS, AUDITREF.STAFF_USER_ACCOUNTS, AUDITREF.OMS_MODULES APPLICATION_MODULES WHERE (AUDITREF.STAFF_USER_ACCOUNTS.STAFF_ID = AUDITREF.STAFF_MEMBERS.STAFF_ID) AND (AUDITREF.STAFF_USER_ACCOUNTS.USERNAME = AUDITDATA.AUDIT_TABLE.AUDIT_USER_ID) AND (APPLICATION_MODULES.MODULE_NAME = AUDITDATA.AUDIT_TABLE.AUDIT_MODULE_NAME) AND (AUDITDATA.AUDIT_TABLE.AUDIT_TABLE_SEQ = NEW.AUDIT_TABLE_SEQ AND AUDITDATA.AUDIT_TABLE.LCR_SOURCE_TIME = NEW.LCR_SOURCE_TIME) AND (NEW.LCR_COLUMN_OLD_NEW_IND (+) = '1') AND ((APPLICATION_MODULES.MODULE_NAME = 'OIMAGPAY') AND (TRUNC(AUDITDATA.AUDIT_TABLE.AUDIT_TIMESTAMP) >= TRUNC(CURRENT_TIMESTAMP - 7)) AND AUDITDATA.AUDIT_TABLE.LCR_COMMAND_TYPE = 'INSERT' AND NOT NEW.LCR_COLUMN_NAME IN ('attribute_seq', 'create_date', 'create_datetime', 'create_user_id') AND AUDITDATA.AUDIT_TABLE.LCR_OBJECT_OWNER = 'OMS_OWNER')), dataset_ AS (SELECT LAST_NAME, FIRST_NAME, NOMIS_USER_ACCOUNT_NAME, NOMIS_USER_ACCOUNT_TYPE, WORKING_CASELOAD_ID, AUDIT_CLIENT_USER_ID, AUDIT_CLIENT_IP_ADDRESS, AUDIT_CLIENT_WORKSTATION_NAME, AT_DATE_OF_CHANGE_, LCR_COMMAND_TYPE, AUDIT_MODULE_NAME, LCR_OBJECT_NAME, LCR_COLUMN_NAME, AT_OLD_VALUE, AT_NEW_VALUE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "LAST_NAME",
            "type": "string",
            "display": "NOMIS User Last Name",
            "legacyId": "DP0.DO130",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "NOMIS User First Name",
            "legacyId": "DP0.DO132",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "NOMIS_USER_ACCOUNT_NAME",
            "type": "string",
            "display": "NOMIS User Account Name",
            "legacyId": "DP0.DO133",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "NOMIS_USER_ACCOUNT_TYPE",
            "type": "string",
            "display": "NOMIS User Account Type",
            "legacyId": "DP0.DO134",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "WORKING_CASELOAD_ID",
            "type": "string",
            "display": "NOMIS User Working Caseload",
            "legacyId": "DP0.DO135",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "AUDIT_CLIENT_USER_ID",
            "type": "string",
            "display": "AT Network User Id",
            "legacyId": "DP0.DO177",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "AUDIT_CLIENT_IP_ADDRESS",
            "type": "string",
            "display": "AT Audit Client Ip Address",
            "legacyId": "DP0.DO176",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "AUDIT_CLIENT_WORKSTATION_NAME",
            "type": "string",
            "display": "AT Audit Client Workstation Name",
            "legacyId": "DP0.DO178",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "AT_DATE_OF_CHANGE_",
            "type": "date",
            "display": "AT Date of Change (DD/MM/YYYY)",
            "legacyId": "DP0.DO15f",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "LCR_COMMAND_TYPE",
            "type": "string",
            "display": "AT LCR Command type",
            "legacyId": "DP0.DO17e",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "AUDIT_MODULE_NAME",
            "type": "string",
            "display": "AT Module Name",
            "legacyId": "DP0.DO17c",
            "legacySqlClass": "column"
          },
          {
            "index": 11,
            "name": "LCR_OBJECT_NAME",
            "type": "string",
            "display": "AT Table Name",
            "legacyId": "DP0.DO17d",
            "legacySqlClass": "column"
          },
          {
            "index": 12,
            "name": "LCR_COLUMN_NAME",
            "type": "string",
            "display": "AT Old Column Name (Business)",
            "legacyId": "DP0.DO998",
            "legacySqlClass": "column"
          },
          {
            "index": 13,
            "name": "AT_OLD_VALUE",
            "type": "string",
            "display": "AT Old Value",
            "legacyId": "DP0.DO182",
            "legacySqlClass": "column"
          },
          {
            "index": 14,
            "name": "AT_NEW_VALUE",
            "type": "string",
            "display": "AT New Value",
            "legacyId": "DP0.DO183",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "140192.RS",
      "name": "NOMIS Business Data Module Update Report",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3375624/DP0",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-section",
        "field": [
          {
            "name": "$ref:AT_DATE_OF_CHANGE_",
            "display": "AT Date of Change (DD/MM/YYYY)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP0.DO15f"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "sqlQuery",
      "error": "Error: ORA-00942: table or view does not exist\nHelp: https://docs.oracle.com/error-help/db/ora-00942/",
      "entityId": "3375624/DP0",
      "entityType": "dataset"
    }
  ]
}