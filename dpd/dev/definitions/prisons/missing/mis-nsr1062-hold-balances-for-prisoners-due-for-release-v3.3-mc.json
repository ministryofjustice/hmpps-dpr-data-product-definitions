{
  "id": "Fr6fgmDbpgYAYPcAAHC7Yl8dACJIAFJ8",
  "name": "MIS NSR1062 Hold Balances for prisoners due for release v3.3 MC",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "FIN0053 v00.00.00"
    ]
  },
  "description": "FIN0053 v00.00.00                        This report displays prisoners with Hold Balances for a specified Caseload Id and Account Date.",
  "datasource": [
    {
      "id": "bodmis",
      "name": "BODMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "bodmis"
    }
  ],
  "dataset": [
    {
      "id": "3376115/DP0",
      "name": "Hold Balance",
      "description": "MIS - Finance",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_OFFENDER_BOOKING.FIRST_NAME, AT_OFFENDER_BOOKING.SURNAME, AT_OFFENDER_BOOKING.ACTIVE_STATUS, AT_OFFENDER_BOOKING.IN_OUT, AT_CASELOADS_OFF_HIST_BAL.ESTABLISHMENT_CODE_NK, AT_HIST_BALANCE_DATES.DAY_DATE, AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_CODE, AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK AS ASSOCIATED_ESTABLISHMENT_CODE, AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_NAME FROM BODIMIS.FACT_OFF_ACC_HIST_BALANCE AT_FACT_OFF_ACC_HIST_BALANCE, BODIMIS.DIM_ESTABLISHMENT AT_CASELOADS_OFF_HIST_BAL, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_DATE AT_HIST_BALANCE_DATES, BODIMIS.DIM_ACCOUNT_CODE AT_DIM_ACCOUNT_CODE_ACCOUNTS WHERE (AT_HIST_BALANCE_DATES.DATE_SK = AT_FACT_OFF_ACC_HIST_BALANCE.BALANCE_DATE_SK) AND (AT_FACT_OFF_ACC_HIST_BALANCE.ACCOUNT_CODE_SK = AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_CODE_SK) AND (AT_OFFENDER_BOOKING.ALIAS_OFFENDER_SK = AT_FACT_OFF_ACC_HIST_BALANCE.ALIAS_OFFENDER_SK AND AT_OFFENDER_BOOKING.BOOKING_SEQ = 1) AND (AT_CASELOADS_OFF_HIST_BAL.ESTABLISHMENT_SK = AT_FACT_OFF_ACC_HIST_BALANCE.ESTABLISHMENT_SK) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND ((AT_HIST_BALANCE_DATES.DAY_DATE = TO_DATE(TO_DATE('22-04-2021 00:00:00', 'DD-MM-YYYY HH24:MI:SS'), 'DD-MM-YYYY HH24:MI:SS')) AND AT_CASELOADS_OFF_HIST_BAL.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)) AND AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)) AND AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_CODE IN (2101, 2103)) GROUP BY AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_OFFENDER_BOOKING.FIRST_NAME, AT_OFFENDER_BOOKING.SURNAME, AT_OFFENDER_BOOKING.ACTIVE_STATUS, AT_OFFENDER_BOOKING.IN_OUT, AT_CASELOADS_OFF_HIST_BAL.ESTABLISHMENT_CODE_NK, AT_HIST_BALANCE_DATES.DAY_DATE, AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_CODE, AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK, AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_NAME HAVING SUM(COALESCE(CASE WHEN NOT AT_DIM_ACCOUNT_CODE_ACCOUNTS.ACCOUNT_CODE_SK IS NULL THEN AT_FACT_OFF_ACC_HIST_BALANCE.HOLD_BALANCE END, 0)) > 0), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, FIRST_NAME, SURNAME, ACTIVE_STATUS, IN_OUT, ESTABLISHMENT_CODE_NK, DAY_DATE, ACCOUNT_CODE, ASSOCIATED_ESTABLISHMENT_CODE, ACCOUNT_NAME FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP0.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "Offender Given Name 1",
            "legacyId": "DP0.DO10080",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "SURNAME",
            "type": "string",
            "display": "Offender Surname",
            "legacyId": "DP0.DO1007b",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "ACTIVE_STATUS",
            "type": "string",
            "display": "Active Status",
            "legacyId": "DP0.DO104d5",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "IN_OUT",
            "type": "string",
            "display": "In Out",
            "legacyId": "DP0.DO104d4",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "ESTABLISHMENT_CODE_NK",
            "type": "string",
            "display": "Account Caseload ID",
            "legacyId": "DP0.DO3d",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "DAY_DATE",
            "type": "date",
            "display": "Account Balance Date",
            "legacyId": "DP0.DO33",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "ACCOUNT_CODE",
            "type": "double",
            "display": "Account Code",
            "legacyId": "DP0.DO2",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "ASSOCIATED_ESTABLISHMENT_CODE",
            "type": "string",
            "display": "Associated Establishment Code",
            "legacyId": "DP0.DO107b2",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "ACCOUNT_NAME",
            "type": "string",
            "display": "Account Name",
            "legacyId": "DP0.DO3",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376115/DP1",
      "name": "MIS End Load",
      "description": "MIS - Finance",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT BODIMIS.ETL_LOAD_LOG.BUSINESS_DATE FROM BODIMIS.ETL_LOAD_LOG WHERE (BODIMIS.ETL_LOAD_LOG.LOAD_ID = (SELECT MAX(LOAD_ID) FROM BODIMIS.ETL_LOAD_LOG WHERE NOT LOAD_END_DATETIME IS NULL))), dataset_ AS (SELECT BUSINESS_DATE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "BUSINESS_DATE",
            "type": "date",
            "display": "Latest Business Date Available",
            "legacyId": "DP1.DO104dd",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3375368/DP2",
      "name": "Release date",
      "description": "MIS - Sentence",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, FACT_CURR_KEY_DATES_SENT.CURR_RELEASE_DATE, CURRENT_TIMESTAMP AS TODAY, AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK FROM BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, FACT_CURR_KEY_DATES_SENT, (SELECT DISTINCT BODIMIS.FACT_CASE_SENTENCE_TERM.offender_booking_sk, BODIMIS.FACT_CASE_SENTENCE_TERM.LIFE_SENTENCE_FLAG FROM BODIMIS.FACT_CASE_SENTENCE_TERM, BODIMIS.FACT_CASE_SENTENCE, BODIMIS.DIM_SENTENCE_STATUS dss WHERE (BODIMIS.FACT_CASE_SENTENCE.SENTENCE_STATUS_SK = dss.sentence_status_sk) AND dss.sentence_status = 'Active' AND (BODIMIS.FACT_CASE_SENTENCE.OFFENDER_BOOKING_SK = BODIMIS.FACT_CASE_SENTENCE_TERM.OFFENDER_BOOKING_SK) AND (BODIMIS.FACT_CASE_SENTENCE.SENTENCE_SEQ_NK = BODIMIS.FACT_CASE_SENTENCE_TERM.SENTENCE_SEQ_NK) AND (BODIMIS.FACT_CASE_SENTENCE.COURT_CASE_SK = BODIMIS.FACT_CASE_SENTENCE_TERM.COURT_CASE_SK) AND BODIMIS.FACT_CASE_SENTENCE_TERM.LIFE_SENTENCE_FLAG = 'Y') DT_LIFEFLAG WHERE (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = DT_LIFEFLAG.OFFENDER_BOOKING_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = FACT_CURR_KEY_DATES_SENT.OFFENDER_BOOKING_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY IN ('A1457DF', 'A3053AE', 'A1753EM', 'A9362EP', 'A3737EP', 'A3669AT', 'A2090AF', 'A2929AE', 'A1081EN', 'A2746DT', 'A2102DW', 'A0616AY', 'A3300DK', 'A4895AX', 'A5754AE', 'A2347EQ', 'A7021CH', 'A1780AE', 'A7713EK', 'A4956EM', 'A0049EQ', 'A2657EQ', 'A6440EE', 'A0059AQ', 'A4447AX', 'A9197DJ', 'A0224AE', 'A4142AG', 'A4335CN', 'A1760AE', 'A7203DX', 'A3153CG', 'A2022AZ') AND FACT_CURR_KEY_DATES_SENT.CURR_RELEASE_DATE >= CURRENT_TIMESTAMP AND CASE WHEN DT_LIFEFLAG.LIFE_SENTENCE_FLAG = 'Y' THEN 'Sentenced' WHEN FACT_CURR_KEY_DATES_SENT.EFFECTIVE_SENTENCE_LENGTH = '00/00/00' THEN 'Unsentenced' WHEN FACT_CURR_KEY_DATES_SENT.EFFECTIVE_SENTENCE_LENGTH IS NULL THEN 'Unsentenced' ELSE 'Sentenced' END = 'Sentenced' AND AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, CURR_RELEASE_DATE, TODAY, ESTABLISHMENT_CODE_NK FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP2.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "CURR_RELEASE_DATE",
            "type": "date",
            "display": "Current Release Date",
            "legacyId": "DP2.DO2e6",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "TODAY",
            "type": "date",
            "display": "Today",
            "legacyId": "DP2.DO1092a",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "ESTABLISHMENT_CODE_NK",
            "type": "string",
            "display": "Associated Establishment Code",
            "legacyId": "DP2.DO107b2",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376115/DP7",
      "name": "Transactions",
      "description": "MIS - Finance",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_CASELOADS.ESTABLISHMENT_CODE_NK, AT_DIM_TRANSACTION_TYPE.TRANSACTION_TYPE, AT_DIM_ACCOUNT_CODE_TXN.ACCOUNT_NAME, AT_DIM_DATE_TRANSACTIONS.DAY_DATE, CASE WHEN (AT_DIM_TXN_POSTING_TYPE.TRANSACTION_POSTING_TYPE_CODE) = 'CR' THEN (AT_FACT_OFFENDER_TRANSACTION.TRANSACTION_ENTRY_AMOUNT) ELSE 0 END AS CREDIT_TRANSACTIONS, CASE WHEN (AT_DIM_TXN_POSTING_TYPE.TRANSACTION_POSTING_TYPE_CODE) = 'DR' THEN (AT_FACT_OFFENDER_TRANSACTION.TRANSACTION_ENTRY_AMOUNT) ELSE 0 END AS DEBIT_TRANSACTIONS FROM BODIMIS.FACT_OFFENDER_TRANSACTION AT_FACT_OFFENDER_TRANSACTION, BODIMIS.DIM_ESTABLISHMENT AT_CASELOADS, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_TRANSACTION_TYPE AT_DIM_TRANSACTION_TYPE, BODIMIS.DIM_ACCOUNT_CODE AT_DIM_ACCOUNT_CODE_TXN, BODIMIS.DIM_DATE AT_DIM_DATE_TRANSACTIONS, BODIMIS.DIM_TXN_POSTING_TYPE AT_DIM_TXN_POSTING_TYPE WHERE (AT_DIM_TRANSACTION_TYPE.TRANSACTION_TYPE_SK = AT_FACT_OFFENDER_TRANSACTION.TRANSACTION_TYPE_SK) AND (AT_FACT_OFFENDER_TRANSACTION.TRANSACTION_POSTING_TYPE_SK = AT_DIM_TXN_POSTING_TYPE.TRANSACTION_POSTING_TYPE_SK) AND (AT_DIM_DATE_TRANSACTIONS.DATE_SK = AT_FACT_OFFENDER_TRANSACTION.TRANSACTION_ENTRY_DATE_SK) AND (AT_FACT_OFFENDER_TRANSACTION.ACCOUNT_CODE_SK = AT_DIM_ACCOUNT_CODE_TXN.ACCOUNT_CODE_SK) AND (AT_OFFENDER_BOOKING.ALIAS_OFFENDER_SK = AT_FACT_OFFENDER_TRANSACTION.ALIAS_OFFENDER_SK AND AT_OFFENDER_BOOKING.BOOKING_SEQ = 1) AND (AT_CASELOADS.ESTABLISHMENT_SK = AT_FACT_OFFENDER_TRANSACTION.ESTABLISHMENT_SK) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY IN ('A1457DF', 'A3053AE', 'A1753EM', 'A9362EP', 'A3737EP', 'A3669AT', 'A2090AF', 'A2929AE', 'A1081EN', 'A2746DT', 'A2102DW', 'A0616AY', 'A3300DK', 'A4895AX', 'A5754AE', 'A2347EQ', 'A7021CH', 'A1780AE', 'A7713EK', 'A4956EM', 'A0049EQ', 'A2657EQ', 'A6440EE', 'A0059AQ', 'A4447AX', 'A9197DJ', 'A0224AE', 'A4142AG', 'A4335CN', 'A1760AE', 'A7203DX', 'A3153CG', 'A2022AZ') AND AT_DIM_TRANSACTION_TYPE.TRANSACTION_TYPE IN ('HOA', 'HOR', 'WHF', 'WFR'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, ESTABLISHMENT_CODE_NK, TRANSACTION_TYPE, ACCOUNT_NAME, DAY_DATE, CREDIT_TRANSACTIONS, DEBIT_TRANSACTIONS FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP7.DO10076",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "ESTABLISHMENT_CODE_NK",
            "type": "string",
            "display": "Transaction Caseload ID",
            "legacyId": "DP7.DO117",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "TRANSACTION_TYPE",
            "type": "string",
            "display": "Transaction Type Code",
            "legacyId": "DP7.DO6",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "ACCOUNT_NAME",
            "type": "string",
            "display": "Transaction Account Name",
            "legacyId": "DP7.DO66",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "DAY_DATE",
            "type": "date",
            "display": "Transaction Date (Date Only)",
            "legacyId": "DP7.DO39",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "CREDIT_TRANSACTIONS",
            "type": "double",
            "display": "Credit Transactions",
            "legacyId": "DP7.DO63",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "DEBIT_TRANSACTIONS",
            "type": "double",
            "display": "Debit  Transactions",
            "legacyId": "DP7.DO65",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "201709.RS",
      "name": "Withold Funds",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "summary",
        "field": []
      }
    }
  ],
  "errors": [
    {
      "type": "schema",
      "error": "instance.report[0] requires property \"dataset\"",
      "entityId": "Fr6fgmDbpgYAYPcAAHC7Yl8dACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "schema",
      "error": "Report Variant 201709.RS does not have corresponding dataset undefined",
      "entityId": "201709.RS",
      "entityType": "variant"
    },
    {
      "type": "athenQuery",
      "error": "Error: Error: Query failed: GENERIC_USER_ERROR: Failed To Get Query Passthrough Schema",
      "entityId": "3375368/DP2",
      "entityType": "dataset"
    }
  ]
}