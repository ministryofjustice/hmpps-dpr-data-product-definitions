{
  "id": "FmtSqwCWPQwAvKQWAAAnLhoAACJIAGE1",
  "name": "ORS Convicted Unsentenced Prisoners with Last Court",
  "description": "SEN0052 - V00.00.01",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "This report displays all Convicted Unsentenced Prisoners for an establishment selected at runtime along with the latest court attended."
    ]
  },
  "datasource": [
    {
      "id": "nomis",
      "name": "NOMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "nomis"
    }
  ],
  "dataset": [
    {
      "id": "3376286/DP3",
      "name": "Conv - Unsentenced",
      "description": "OR - Sentence",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_OFFENDERS_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY, SUBSTR(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID) + 2, LENGTH(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION)) AS UNIT_DESCRIPTION_4_SHORT, AT_OFFENDER.FIRST_NAME, AT_OFFENDER.LAST_NAME, DT_ADMISSION.ADMISSION_DATE FROM OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.AGENCY_INTERNAL_LOCATIONS AT_AGENCY_INTERNAL_LOCATION_L4, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_OFFENDERS_LOCATIONS, OMS_OWNER.AGENCY_LOCATIONS AT_WING_ESTABLISHMENT, OMS_OWNER.CASELOAD_AGENCY_LOCATIONS AT_CASELOAD_LOCATIONS, OMS_OWNER.IMPRISONMENT_STATUSES AT_IMPRISON_STATUSES, USER_ACCESSIBLE_CASELOADS, USER_ACCESSIBLE_CASELOADS WING_CASELOAD_SECURITY, (SELECT DISTINCT m.OFFENDER_BOOK_ID, MAX(m.MOVEMENT_TIME) AS ADMISSION_DATE FROM OMS_OWNER.OFFENDER_EXTERNAL_MOVEMENTS m, OMS_OWNER.offender_bookings h WHERE h.booking_status = 'O' AND h.active_flag = 'Y' AND m.direction_code = 'IN' AND m.Movement_reason_code <> 'R' AND m.Movement_type = 'ADM' AND m.to_agy_loc_id = h.agy_loc_id AND h.offender_book_id = m.offender_book_id GROUP BY m.OFFENDER_BOOK_ID) DT_ADMISSION, OMS_OWNER.OFFENDER_IMPRISON_STATUSES AT_OFFENDER_IMPRISON_STATUSES WHERE (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDER_BOOKING.LIVING_UNIT_ID = AT_AGENCY_INTERNAL_LOCATION_L4.INTERNAL_LOCATION_ID) AND (AT_OFFENDER_IMPRISON_STATUSES.OFFENDER_BOOK_ID (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID) AND (AT_OFFENDER_IMPRISON_STATUSES.LATEST_STATUS = 'Y' OR AT_OFFENDER_IMPRISON_STATUSES.LATEST_STATUS IS NULL) AND (AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST') AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID) AND (AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS.AGY_LOC_ID (+)) AND (NOT AT_CASELOAD_LOCATIONS.AGY_LOC_ID IN ('OUT', 'TRN') AND NOT AT_CASELOAD_LOCATIONS.CASELOAD_ID IN ('ADMINC', 'CADM_I', 'MULTI')) AND (AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID = AT_WING_ESTABLISHMENT.AGY_LOC_ID) AND (AT_WING_ESTABLISHMENT.AGY_LOC_ID = WING_CASELOAD_SECURITY.CASELOAD_ID) AND (AT_IMPRISON_STATUSES.IMPRISONMENT_STATUS (+) = AT_OFFENDER_IMPRISON_STATUSES.IMPRISONMENT_STATUS) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = DT_ADMISSION.OFFENDER_BOOK_ID (+)) AND (USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT username FROM context_)) AND (WING_CASELOAD_SECURITY.USERNAME = (SELECT username FROM context_)) AND (CASE WHEN AT_IMPRISON_STATUSES.IMPRISONMENT_STATUS IN ('14FTR_ORA', '14FTRHDC_ORA', 'CUR_ORA', 'FTR/08', 'FTR_HDC', 'FTR_HDC_ORA', 'FTR_ORA', 'FTR_SCH15', 'FTRSCH15_ORA', 'HDR_ORA', 'LR', 'LR_ALP', 'LR_ALP_LASPO', 'LR_DLP', 'LR_DPP', 'LR_EPP', 'LR_ES', 'LR_HDC', 'LR_IPP', 'LR_LASPO_AR', 'LR_LASPO_DR', 'LR_LIFE', 'LR_MLP', 'LR_ORA', 'LR_SEC236A', 'LR_SEC91_ORA', 'LR_YOI', 'LR_YOI_ORA', 'FTRSCH18_ORA', 'FTRSCH18', 'LR_ALP_CDE18', 'LR_ALP_CDE21', 'LR_EDS18', 'LR_EDS21', 'LR_SOPC18', 'LR_SOPC21', 'LRSEC250_ORA', 'LR_EDSU18') THEN 'Recall' WHEN AT_IMPRISON_STATUSES.BAND_CODE = '0' THEN 'Dead' WHEN AT_IMPRISON_STATUSES.BAND_CODE = '1' THEN 'Indeterminate Sentence' WHEN AT_IMPRISON_STATUSES.BAND_CODE IN ('2', '3') THEN 'Sentenced' WHEN AT_IMPRISON_STATUSES.BAND_CODE IN ('4', '5', '6', '7') THEN 'Convicted Unsentenced' WHEN AT_IMPRISON_STATUSES.BAND_CODE IN ('9', '10') OR AT_IMPRISON_STATUSES.IMPRISONMENT_STATUS = 'CIV_RMD' THEN 'Civil Prisoners' WHEN AT_IMPRISON_STATUSES.BAND_CODE IN ('8', '11') THEN 'Immigration Detainees' WHEN AT_IMPRISON_STATUSES.BAND_CODE IN ('12', '13', '14') THEN 'Remand' WHEN AT_IMPRISON_STATUSES.IMPRISONMENT_STATUS = 'UNKNOWN' THEN 'Unknown' ELSE 'Other' END IN ('Convicted Unsentenced') AND (AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = (SELECT establishment_code FROM prompt_)) AND AT_OFFENDER_BOOKING.ACTIVE_FLAG IN ('Y'))), dataset_ AS (SELECT DESCRIPTION, OFFENDER_ID_DISPLAY, UNIT_DESCRIPTION_4_SHORT, FIRST_NAME, LAST_NAME, ADMISSION_DATE, CASE WHEN V_COURT_NAME IS NULL THEN 'Please Check NOMIS' ELSE V_COURT_NAME END AS V_COURT_NAME_FIX FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Establishment Name",
            "legacyId": "DP3.DO33b",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP3.DO44",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "UNIT_DESCRIPTION_4_SHORT",
            "type": "string",
            "display": "Unit Description 4 Short",
            "legacyId": "DP3.DO427",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name",
            "legacyId": "DP3.DO46",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name",
            "legacyId": "DP3.DO45",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "ADMISSION_DATE",
            "type": "date",
            "display": "Admission Date",
            "legacyId": "DP3.DOc6a",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "V_COURT_NAME_FIX",
            "type": "string",
            "display": "V_COURT_NAME_FIX",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3376286/DP6",
      "name": "Courts",
      "description": "OR - Sentence",
      "datasource": "nomis",
      "query": "dataset_base_ AS (SELECT DISTINCT AT_AGENCY_LOCATIONS.DESCRIPTION, AT_OFFENDER.OFFENDER_ID_DISPLAY FROM OMS_OWNER.COURT_EVENTS AT_OFFENDER_COURT_EVENTS, OMS_OWNER.OFFENDERS AT_OFFENDER, OMS_OWNER.OFFENDER_BOOKINGS AT_OFFENDER_BOOKING, OMS_OWNER.AGENCY_LOCATIONS AT_AGENCY_LOCATIONS, OMS_OWNER.OFFENDER_CASES AT_OFFENDER_CASES WHERE (AT_AGENCY_LOCATIONS.AGY_LOC_ID (+) = AT_OFFENDER_COURT_EVENTS.AGY_LOC_ID) AND (AT_OFFENDER_COURT_EVENTS.CASE_ID = AT_OFFENDER_CASES.CASE_ID) AND (AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOK_ID = AT_OFFENDER_CASES.OFFENDER_BOOK_ID (+)) AND ((AT_OFFENDER_COURT_EVENTS.event_date = (SELECT MAX(TO_DATE(TO_CHAR(TRUNC(a.EVENT_DATE), 'dd/mm/yyyy'), 'dd/mm/yyyy')) FROM OMS_OWNER.COURT_EVENTS a WHERE AT_OFFENDER_COURT_EVENTS.OFFENDER_BOOK_ID = a.OFFENDER_BOOK_ID)) AND AT_OFFENDER.OFFENDER_ID_DISPLAY IN ('A0019EH', 'A0061AX', 'A0130ER', 'A0274DP', 'A0416EJ', 'A0442EQ', 'A0473CV', 'A0478EN', 'A0655ER', 'A0783DL', 'A0802EV', 'A0813EV', 'A0835EJ', 'A0930ER', 'A0934ER', 'A0958DJ', 'A0969EP', 'A0996AQ', 'A1036AM', 'A1070CJ', 'A1138EP', 'A1182AQ', 'A1489EN', 'A1520EW', 'A1581EQ', 'A1727ED', 'A1743DF', 'A2035ET', 'A2116EQ', 'A2168EH', 'A2197DY', 'A2568EG', 'A2689ET', 'A2713DJ', 'A2755ET', 'A2757EV', 'A2799AV', 'A2849EV', 'A2861EV', 'A2964EW', 'A3001ER', 'A3010EW', 'A3016CV', 'A3054EQ', 'A3055EQ', 'A3074EQ', 'A3281EW', 'A3354EW', 'A3561AE', 'A3586EC', 'A3595ER', 'A3616DZ', 'A3624CF', 'A4031ER', 'A4114ET', 'A4120ET', 'A4299EP', 'A4425CP', 'A4574DZ', 'A4575CF', 'A4618EP', 'A4711EM', 'A5019DR', 'A5019EV', 'A5042DR', 'A5244EV', 'A5448DR', 'A5567EP', 'A5641EA', 'A5801ET', 'A5854CF', 'A5859AD', 'A5888EM', 'A5890EM', 'A5902EQ', 'A5999EQ', 'A6097DD', 'A6149CH', 'A6204CD', 'A6425AV', 'A6803AZ', 'A6874ET', 'A6919DF', 'A6942AH', 'A6992EN', 'A7117EV', 'A7327CD', 'A7389DA', 'A7462AN', 'A7685EV', 'A7698EM', 'A7831DM', 'A7893EV', 'A7948AM', 'A7953EP', 'A7976EP', 'A8050ER', 'A8198EN', 'A8199EP', 'A8202EN', 'A8242CN', 'A8302EQ', 'A8404EN', 'A8610AW', 'A8675EP', 'A8723ET', 'A8829EV', 'A8867EM', 'A8900CL', 'A8901EM', 'A8931EP', 'A8933EV', 'A8934EM', 'A8976ET', 'A9273EM', 'A9279EM', 'A9721CZ', 'A9803DE', 'A9878EM', 'A9916DW', 'A9984ET') AND AT_OFFENDER_BOOKING.ACTIVE_FLAG IN ('Y'))), dataset_ AS (SELECT DESCRIPTION, OFFENDER_ID_DISPLAY FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Court Name",
            "legacyId": "DP6.DO88b",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP6.DO10044",
            "legacySqlClass": "column"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "163163.RS",
      "name": "By Admission Date",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376286/DP3",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP3.DO46"
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP3.DO45"
          },
          {
            "name": "$ref:UNIT_DESCRIPTION_4_SHORT",
            "display": "Unit Description 4 Short",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP3.DO427"
          },
          {
            "name": "$ref:ADMISSION_DATE",
            "display": "Admission Date",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP3.DOc6a"
          },
          {
            "name": "$ref:V_COURT_NAME_FIX",
            "display": "Last Court Attended",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=If(IsNull([V_Court_Name]);\"Please Check NOMIS\";[V_Court_Name])"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "sqlQuery",
      "error": "Error: ORA-00904: \"V_COURT_NAME\": invalid identifier\nHelp: https://docs.oracle.com/error-help/db/ora-00904/",
      "entityId": "3376286/DP3",
      "entityType": "dataset"
    }
  ]
}