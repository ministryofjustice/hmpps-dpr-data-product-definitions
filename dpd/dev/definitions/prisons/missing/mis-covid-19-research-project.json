{
  "id": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
  "name": "MIS Covid 19 Research Project",
  "metadata": {
    "version": "1.0.0",
    "tags": [
      "COVID"
    ]
  },
  "description": "Last Modified: 30/07/2020 Version 00.00.02<br/><br/>This report was requested by the COVID 19 Regime Recover Testing Team. The latest idea being that each establishment will run the report and submit to the COVID team. There is also likely to be an accompanying survey to be sent to prisoners as part of this exercise. <br/><br/>The report is intended to show every prisoner on a prison roll at an establishment chosen at runtime.<br/>Tab 1 – Shows key demographics along with Latest Admission date with movement from location as well as a list of allocated activities, First 3 / 4 digits of postcode and Latest Address Date.<br/><br/>Tab 2 – Shows Prisoner Internal Movements which have taken place during the period selected at runtime. <br/><br/>PDD0201 ",
  "datasource": [
    {
      "id": "bodmis",
      "name": "BODMIS",
      "database": "DIGITAL_PRISON_REPORTING",
      "catalog": "bodmis"
    }
  ],
  "dataset": [
    {
      "id": "3376639/DP2",
      "name": "Demographics",
      "description": "MIS - Demographics",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_OFFENDER_BOOKING.SURNAME, CASE WHEN AT_DOB.DAY_DATE < '31/12/9000' THEN AT_DOB.DAY_DATE END AS DATE_OF_BIRTH, CASE WHEN AT_DIM_ETHNICITY_CODES.DESCRIPTION = 'Chinese' THEN 'Asian/Asian British: Chinese' WHEN AT_DIM_ETHNICITY_CODES.DESCRIPTION = 'White : Irish Traveller/Gypsy' THEN 'White: Gypsy or Irish Traveller' WHEN AT_DIM_ETHNICITY_CODES.DESCRIPTION IS NULL THEN 'Code Missing' ELSE AT_DIM_ETHNICITY_CODES.DESCRIPTION END AS ETHNIC_GROUP, AT_OFFENDER_BOOKING.GENDER_CODE, AT_DIM_LOCATION.UNIT_4_SHORT_DESCRIPTION, DT_EXT_MOVE_FROM.TYPE_DESCRIPTION_FROM, AT_FACT_MOV_EXT.MOVEMENT_SEQ, AT_FACT_MOV_EXT.MOVEMENT_TIME, AT_FACT_MOV_EXT.TYPE FROM BODIMIS.DIM_CELL AT_DIM_LOCATION, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_ETHNICITY_CODES AT_DIM_ETHNICITY_CODES, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_DATE AT_DOB, (SELECT BODIMIS.DIM_ESTABLISHMENT.ESTABLISHMENT_SK AS SK_ID_FROM, BODIMIS.DIM_ESTABLISHMENT.ESTABLISHMENT_DESCRIPTION AS TYPE_DESCRIPTION_FROM, 'Establishment' AS Location_Type_FROM FROM BODIMIS.DIM_ESTABLISHMENT UNION ALL SELECT BODIMIS.DIM_PROBATION_OFFICE.PROBATION_OFFICE_SK, BODIMIS.DIM_PROBATION_OFFICE.PROB_OFFICE_DESCRIPTION, 'Probation Office' AS Location_Type_From FROM BODIMIS.DIM_PROBATION_OFFICE UNION ALL SELECT BODIMIS.DIM_OUTSIDE_LOCATION.OUTSIDE_LOCATION_SK, BODIMIS.DIM_OUTSIDE_LOCATION.OUTSIDE_LOCATION_DESCRIPTION, 'Outside Location' AS Location_Type_From FROM BODIMIS.DIM_OUTSIDE_LOCATION UNION ALL SELECT BODIMIS.DIM_CITY.CITY_SK, BODIMIS.DIM_CITY.DESCRIPTION, 'City' AS Location_Type_From FROM BODIMIS.DIM_CITY UNION ALL SELECT BODIMIS.DIM_COURT.COURT_SK, BODIMIS.DIM_COURT.COURT_DESCRIPTION, 'Court' AS Location_Type_From FROM BODIMIS.DIM_COURT UNION ALL SELECT address_id_nk, TRIM(CASE WHEN no_fixed_address_flag = 'Y' THEN 'No fixed address' ELSE CASE WHEN NOT flat IS NULL THEN flat || '  ' END || CASE WHEN NOT premise IS NULL THEN premise || '  ' END || CASE WHEN NOT street IS NULL THEN street || '  ' END || CASE WHEN NOT locality IS NULL THEN locality || '  ' END || CASE WHEN NOT city_desc IS NULL THEN city_desc || '  ' END || CASE WHEN NOT county_desc IS NULL THEN county_desc || '  ' END || CASE WHEN NOT postal_code IS NULL THEN postal_code || '  ' END || CASE WHEN NOT country_desc IS NULL THEN country_desc END END), 'Home Leave Address' FROM bodimis.dim_addresses) DT_EXT_MOVE_FROM, BODIMIS.FACT_MOVEMENT_EXTERNAL AT_FACT_MOV_EXT WHERE (AT_OFFENDER_BOOKING.BIRTH_DATE_SK = AT_DOB.DATE_SK) AND (AT_FACT_MOV_EXT.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (AT_DIM_ETHNICITY_CODES.CODE (+) = AT_OFFENDER_BOOKING.ETHNICITY_CODE) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_FACT_MOV_EXT.FROM_LOCATION_SK = DT_EXT_MOVE_FROM.SK_ID_FROM (+) AND AT_FACT_MOV_EXT.FROM_LOCATION_TYPE = DT_EXT_MOVE_FROM.LOCATION_TYPE_FROM (+)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER_BOOKING.LIVING_UNIT_SK = AT_DIM_LOCATION.UNIT_4_SK (+)) AND ((AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)) OR 'All' IN ((SELECT establishment_code FROM prompt_))) AND AT_FACT_MOV_EXT.TYPE IN ('Admission'))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, SURNAME, DATE_OF_BIRTH, ETHNIC_GROUP, GENDER_CODE, UNIT_4_SHORT_DESCRIPTION, TYPE_DESCRIPTION_FROM, MOVEMENT_SEQ, MOVEMENT_TIME, TYPE, 'TBD' AS V_MAX_CONCANT_ACT_DESC, 'TBD' AS V_MAX_CONCAT_POSTCODE, TO_DATE(V_MAX_ADDRESS_USAGE, 'dd/MM/yyyy') AS V_FORMAT_MAX_DATE FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP2.DO76",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "SURNAME",
            "type": "string",
            "display": "Offender Surname",
            "legacyId": "DP2.DO7b",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "DATE_OF_BIRTH",
            "type": "date",
            "display": "Date of Birth",
            "legacyId": "DP2.DO85",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "ETHNIC_GROUP",
            "type": "string",
            "display": "Ethnic Group",
            "legacyId": "DP2.DO9c",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "GENDER_CODE",
            "type": "string",
            "display": "Gender Code",
            "legacyId": "DP2.DOa8",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "UNIT_4_SHORT_DESCRIPTION",
            "type": "string",
            "display": "Prisoner Location",
            "legacyId": "DP2.DOa7c",
            "legacySqlClass": "column"
          },
          {
            "index": 6,
            "name": "TYPE_DESCRIPTION_FROM",
            "type": "string",
            "display": "Movement Description (From)",
            "legacyId": "DP2.DO700",
            "legacySqlClass": "column"
          },
          {
            "index": 7,
            "name": "MOVEMENT_SEQ",
            "type": "double",
            "display": "Movement Sequence",
            "legacyId": "DP2.DO3e5",
            "legacySqlClass": "column"
          },
          {
            "index": 8,
            "name": "MOVEMENT_TIME",
            "type": "date",
            "display": "Movement Date and Time (External)",
            "legacyId": "DP2.DO3eb",
            "legacySqlClass": "column"
          },
          {
            "index": 9,
            "name": "TYPE",
            "type": "string",
            "display": "Movement Type (External)",
            "legacyId": "DP2.DO3ec",
            "legacySqlClass": "column"
          },
          {
            "index": 10,
            "name": "V_MAX_CONCANT_ACT_DESC",
            "type": "string",
            "display": "V_MAX_CONCANT_ACT_DESC",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 11,
            "name": "V_MAX_CONCAT_POSTCODE",
            "type": "string",
            "display": "V_MAX_CONCAT_POSTCODE",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 12,
            "name": "V_FORMAT_MAX_DATE",
            "type": "string",
            "display": "V_FORMAT_MAX_DATE",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    },
    {
      "id": "3376639/DP3",
      "name": "MIS Load Date",
      "description": "MIS - Demographics",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT BODIMIS.ETL_LOAD_LOG.BUSINESS_DATE FROM BODIMIS.ETL_LOAD_LOG WHERE (BODIMIS.ETL_LOAD_LOG.LOAD_ID = (SELECT MAX(LOAD_ID) FROM BODIMIS.ETL_LOAD_LOG WHERE NOT LOAD_END_DATETIME IS NULL))), dataset_ AS (SELECT BUSINESS_DATE FROM dataset_base_)",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "BUSINESS_DATE",
            "type": "date",
            "display": "Latest Business Date Available",
            "legacyId": "DP3.DO4dd",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376639/DP4",
      "name": "Activites",
      "description": "MIS - Demographics",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_DIM_PROGRAMME_TYPE.DESCRIPTION FROM BODIMIS.FACT_OFFENDER_ACTIVITY AT_FACT_OFFENDER_ACTIVITY, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.DIM_PROGRAMME_TYPE AT_DIM_PROGRAMME_TYPE WHERE (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK = AT_FACT_OFFENDER_ACTIVITY.OFFENDER_BOOKING_SK) AND (AT_DIM_PROGRAMME_TYPE.PROGRAMME_TYPE_SK = AT_FACT_OFFENDER_ACTIVITY.PROGRAMME_TYPE_SK) AND ((CASE WHEN AT_FACT_OFFENDER_ACTIVITY.ALLOCATED_FLAG = 'Y' THEN AT_FACT_OFFENDER_ACTIVITY.OFFENDER_END_DATE END > CURRENT_TIMESTAMP) AND (AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)) OR 'All' IN ((SELECT establishment_code FROM prompt_))))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, DESCRIPTION FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP4.DO76",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "DESCRIPTION",
            "type": "string",
            "display": "Activity Description",
            "legacyId": "DP4.DO64c",
            "legacySqlClass": "column"
          }
        ]
      }
    },
    {
      "id": "3376639/DP5",
      "name": "Reception Address",
      "description": "MIS - Demographics",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, DT_OFFENDER_ADDRESSES.FLAT || ' '|| DT_OFFENDER_ADDRESSES.PREMISE || ' '|| DT_OFFENDER_ADDRESSES.STREET || ' '|| DT_OFFENDER_ADDRESSES.LOCALITY || ' '|| DT_OFFENDER_ADDRESSES.CITY_DESC || ' '|| DT_OFFENDER_ADDRESSES.POSTAL_CODE || ' '|| DT_OFFENDER_ADDRESSES.COUNTRY_DESC, DT_OFFENDER_ADDRESSES.USAGES_DTTM, DT_OFFENDER_ADDRESSES.POSTAL_CODE FROM BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, ( select ROW_NUMBER() OVER (PARTITION BY ss.OWNER_ID ORDER BY PRIMARY_FLAG desc, ss.address_active_flag desc, ss.USAGE_ACTIVE_FLAG desc, ss.usages_dttm DESC nulls last) row_seq_filter, ss.* from ( select * from ( select AT_DIM_ADDRESSES.OWNER_ID, AT_DIM_ADDRESS_USAGES.ADDRESS_ID_NK, AT_DIM_ADDRESS_USAGES.ADDRESS_USAGE, AT_DIM_ADDRESS_USAGES.ADDR_USAGE_DESCRIPTION, AT_DIM_ADDRESS_USAGES.ACTIVE_FLAG as USAGE_ACTIVE_FLAG, AT_DIM_ADDRESSES.flat, AT_DIM_ADDRESSES.premise, AT_DIM_ADDRESSES.Street, AT_DIM_ADDRESSES.locality, AT_DIM_ADDRESSES.city_code, AT_DIM_ADDRESSES.city_desc, AT_DIM_ADDRESSES.county_code, AT_DIM_ADDRESSES.county_desc, AT_DIM_ADDRESSES.postal_code, AT_DIM_ADDRESSES.COUNTRY_CODE, AT_DIM_ADDRESSES.country_desc, AT_DIM_ADDRESSES.HOME_TEL_NO, AT_DIM_ADDRESSES.HOME_EXT_NO, AT_DIM_ADDRESSES.NO_FIXED_ADDRESS_FLAG, AT_DIM_ADDRESSES.establishment_sk, AT_DIM_ADDRESSES.PRIMARY_FLAG, AT_DIM_ADDRESSES.active_flag as address_active_flag, AT_DIM_ADDRESS_USAGES.CREATE_DATETIME, AT_DIM_ADDRESS_USAGES.MODIFY_DATETIME, COALESCE(AT_DIM_ADDRESS_USAGES.modify_datetime, AT_DIM_ADDRESS_USAGES.create_datetime) as usages_dttm from BODIMIS.DIM_ADDRESS_USAGES AT_DIM_ADDRESS_USAGES inner join BODIMIS.dim_addresses AT_DIM_ADDRESSES on AT_DIM_ADDRESS_USAGES.address_id_nk = AT_DIM_ADDRESSES.address_id_nk and AT_DIM_ADDRESSES.owner_class='OFF'  ) Addr_usages --where Addr_usages.usages_dttm is not null ) ss ) DT_OFFENDER_ADDRESSES, BODISTAGING.REF_OFFENDERS AT_BODISTAG_REF_OFFENDERS WHERE ( AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID=CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username from context_) AND CSL.ENDYEAR >= to_char(sysdate,'YYYY')-6 ) ) AND ( AT_OFFENDER_BOOKING.ESTABLISHMENT_SK=AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK ) AND ( AT_ESTABLISHMENT_TAP.ACTIVE_FLAG='Y' ) AND ( AT_OFFENDER_BOOKING.OFFENDER_ID=AT_BODISTAG_REF_OFFENDERS.OFFENDER_ID(+) ) AND ( AT_BODISTAG_REF_OFFENDERS.ROOT_OFFENDER_ID=DT_OFFENDER_ADDRESSES.OWNER_ID(+) ) AND ( ( DT_OFFENDER_ADDRESSES.ADDRESS_ACTIVE_FLAG='Y' ) AND DT_OFFENDER_ADDRESSES.ADDR_USAGE_DESCRIPTION IN ( 'Reception' ) AND ( AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK in ((SELECT establishment_code from prompt_)) Or 'All' in ((SELECT establishment_code from prompt_)) ) )), dataset_ AS (SELECT FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": []
      }
    },
    {
      "id": "3376639/DP6",
      "name": "Internal Movements",
      "description": "MIS - Demographics",
      "datasource": "bodmis",
      "query": "dataset_base_ AS (SELECT AT_OFFENDER_BOOKING.OFFENDER_ID_DISPLAY, AT_BED_ASSIGNMENT_HISTORY.ASSIGNMENT_TIME, AT_BED_ASSIGNMENT_HISTORY.ASSIGNMENT_END_TIME, AT_FROM_CELL.UNIT_4_DESCRIPTION, AT_TO_CELL.UNIT_4_DESCRIPTION AS MOVEMENT_LOCATION_TO_DESCRIP33 FROM BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_TAP, BODIMIS.DIM_OFFENDER_BOOKING AT_OFFENDER_BOOKING, BODIMIS.FACT_BED_ASSIGNMENT_HISTORY AT_BED_ASSIGNMENT_HISTORY, BODIMIS.DIM_CELL AT_FROM_CELL, BODIMIS.DIM_CELL AT_TO_CELL, BODIMIS.DIM_ESTABLISHMENT AT_ESTABLISHMENT_EXT_MOV_TO, (SELECT LAG(fbah.living_unit_sk) OVER (PARTITION BY offender_booking_sk ORDER BY Assignment_time) AS from_cell, bed_assign_seq_nk, offender_booking_sk FROM bodimis.fact_bed_assignment_history fbah) DT_FROM_CELL, BODIMIS.FACT_MOVEMENT_EXTERNAL AT_FACT_MOV_EXT WHERE (AT_FACT_MOV_EXT.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (CASE WHEN AT_FACT_MOV_EXT.TO_LOCATION_TYPE = 'Establishment' THEN AT_FACT_MOV_EXT.TO_LOCATION_SK END = AT_ESTABLISHMENT_EXT_MOV_TO.ESTABLISHMENT_SK (+)) AND (AT_BED_ASSIGNMENT_HISTORY.OFFENDER_BOOKING_SK (+) = AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK) AND (AT_BED_ASSIGNMENT_HISTORY.LIVING_UNIT_SK = AT_TO_CELL.UNIT_4_SK (+)) AND (AT_OFFENDER_BOOKING.OFFENDER_BOOKING_SK IN (SELECT CSL.OFFENDER_BOOKING_SK FROM BODIMIS.DIM_STAFF_ACCESSIBLE_CASELOAD SAC, BODIMIS.DIM_CASELOAD_SECURITY_LIST CSL WHERE SAC.CASELOAD_ID = CSL.CASELOAD_CODE AND SAC.USERNAME = (SELECT username FROM context_) AND CSL.ENDYEAR >= TO_CHAR(CURRENT_TIMESTAMP, 'YYYY') - 6)) AND (AT_OFFENDER_BOOKING.ESTABLISHMENT_SK = AT_ESTABLISHMENT_TAP.ESTABLISHMENT_SK) AND (AT_ESTABLISHMENT_TAP.ACTIVE_FLAG = 'Y') AND (AT_BED_ASSIGNMENT_HISTORY.BED_ASSIGN_SEQ_NK = DT_FROM_CELL.BED_ASSIGN_SEQ_NK AND AT_BED_ASSIGNMENT_HISTORY.OFFENDER_BOOKING_SK = DT_FROM_CELL.OFFENDER_BOOKING_SK) AND (DT_FROM_CELL.FROM_CELL = AT_FROM_CELL.UNIT_4_SK (+)) AND (((AT_ESTABLISHMENT_EXT_MOV_TO.ESTABLISHMENT_CODE_NK) IN ((SELECT establishment_code FROM prompt_)) OR 'All' IN ((SELECT establishment_code FROM prompt_))) AND (TRUNC((AT_BED_ASSIGNMENT_HISTORY.ASSIGNMENT_TIME)) BETWEEN TO_DATE('01-05-2021 00:00:00', 'DD-MM-YYYY HH24:MI:SS') AND TO_DATE('31-05-2021 00:00:00', 'DD-MM-YYYY HH24:MI:SS')) AND (AT_ESTABLISHMENT_TAP.ESTABLISHMENT_CODE_NK IN ((SELECT establishment_code FROM prompt_)) OR 'All' IN ((SELECT establishment_code FROM prompt_))))), dataset_ AS (SELECT OFFENDER_ID_DISPLAY, ASSIGNMENT_TIME, ASSIGNMENT_END_TIME, UNIT_4_DESCRIPTION, MOVEMENT_LOCATION_TO_DESCRIP33, SURNAME AS V_SURNAME, UNIT_4_SHORT_DESCRIPTION AS V_PRISONER_LOCATION FROM dataset_base_)",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number",
            "legacyId": "DP6.DO76",
            "legacySqlClass": "column"
          },
          {
            "index": 1,
            "name": "ASSIGNMENT_TIME",
            "type": "date",
            "display": "Movement Assignment Date and Time",
            "legacyId": "DP6.DO3ca",
            "legacySqlClass": "column"
          },
          {
            "index": 2,
            "name": "ASSIGNMENT_END_TIME",
            "type": "date",
            "display": "Movement Assignment End Date and Time (Internal)",
            "legacyId": "DP6.DO3cb",
            "legacySqlClass": "column"
          },
          {
            "index": 3,
            "name": "UNIT_4_DESCRIPTION",
            "type": "string",
            "display": "Movement Location From Description (Internal)",
            "legacyId": "DP6.DOb0f",
            "legacySqlClass": "column"
          },
          {
            "index": 4,
            "name": "MOVEMENT_LOCATION_TO_DESCRIP33",
            "type": "string",
            "display": "Movement Location To Description (Internal)",
            "legacyId": "DP6.DO162",
            "legacySqlClass": "column"
          },
          {
            "index": 5,
            "name": "V_SURNAME",
            "type": "string",
            "display": "V_SURNAME",
            "legacyId": "???",
            "legacySqlClass": "alias"
          },
          {
            "index": 6,
            "name": "V_PRISONER_LOCATION",
            "type": "string",
            "display": "V_PRISONER_LOCATION",
            "legacyId": "???",
            "legacySqlClass": "alias"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "214316.RS",
      "name": "All Prisoners",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376639/DP2",
      "filter": {
        "name": "prefilter_",
        "query": "prefilter_ AS (SELECT * FROM dataset_ WHERE V_LATEST_ADMISSION_DATE IN ('Y'))"
      },
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:SURNAME",
            "display": "Offender Surname",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DO7b"
          },
          {
            "name": "$ref:UNIT_4_SHORT_DESCRIPTION",
            "display": "Prisoner Location",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DOa7c"
          },
          {
            "name": "$ref:DATE_OF_BIRTH",
            "display": "Date of Birth",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DO85"
          },
          {
            "name": "$ref:GENDER_CODE",
            "display": "Gender Code",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DOa8"
          },
          {
            "name": "$ref:ETHNIC_GROUP",
            "display": "Ethnic Group",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DO9c"
          },
          {
            "name": "$ref:MOVEMENT_TIME",
            "display": "Movement Date and Time (External)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DO3eb"
          },
          {
            "name": "$ref:TYPE_DESCRIPTION_FROM",
            "display": "Movement Description (From)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DO700"
          },
          {
            "name": "$ref:V_MAX_CONCANT_ACT_DESC",
            "display": "Allocated Activities (Including expired)",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[v_Concat_Act_Desc]Where ([v_Activity_Description]= [v_Max_Act_Desc]) In ([NOMS Number])"
          },
          {
            "name": "$ref:V_MAX_CONCAT_POSTCODE",
            "display": "Reception Postcode(s)",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[V_Concat_Postcode]Where ([v_Postcode]= [v_Max_Postcode]) In ([NOMS Number])"
          },
          {
            "name": "$ref:V_FORMAT_MAX_DATE",
            "display": "Latest Address Date",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=ToDate([v_Max_Address_Usage];\"dd/MM/yyyy\")"
          }
        ]
      }
    },
    {
      "id": "214484.RS",
      "name": "Prisoner Movements",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "3376639/DP6",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacyId": "DP6.DO76"
          },
          {
            "name": "$ref:V_SURNAME",
            "display": "Surname",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[Offender Surname]"
          },
          {
            "name": "$ref:V_PRISONER_LOCATION",
            "display": "Current Location",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false,
            "legacySql": "=[Prisoner Location]"
          },
          {
            "name": "$ref:ASSIGNMENT_TIME",
            "display": "Movement Assignment Date and Time",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP6.DO3ca"
          },
          {
            "name": "$ref:ASSIGNMENT_END_TIME",
            "display": "Movement Assignment End Date and Time (Internal)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP6.DO3cb"
          },
          {
            "name": "$ref:UNIT_4_DESCRIPTION",
            "display": "Movement Location From Description (Internal)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP6.DOb0f"
          },
          {
            "name": "$ref:MOVEMENT_LOCATION_TO_DESCRIP33",
            "display": "Movement Location To Description (Internal)",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP6.DO162"
          }
        ]
      }
    }
  ],
  "errors": [
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_MAX_CONCANT_ACT_DESC :: Error: =[v_Concat_Act_Desc]Where ([v_Activity_Description]= [v_Max_Act_Desc]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:72",
      "entityId": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::resolveCTEs parse error for : $ref:V_MAX_CONCAT_POSTCODE :: Error: =[V_Concat_Postcode]Where ([v_Postcode]= [v_Max_Postcode]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_MAX_CONCANT_ACT_DESC :: Error: =[v_Concat_Act_Desc]Where ([v_Activity_Description]= [v_Max_Act_Desc]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:72",
      "entityId": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::injectCalculations parse error for : $ref:V_MAX_CONCAT_POSTCODE :: Error: =[V_Concat_Postcode]Where ([v_Postcode]= [v_Max_Postcode]) In ([NOMS Number]) ==> Error: Expected end of input but \"I\" found.\n at undefined:1:60",
      "entityId": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "enhanced",
      "error": "dataset::fixSqlFormatting sql is not valid [Expecting ). Line 1, Col: 1853.\n  ESS_USAGES.address_id_nk = AT_DIM_ADDRESSES.address_id_nk and AT_DIM_ADDRESSES.owner_class='OFF'  ) \u001b[4mAddr_usages\u001b[0m --where Addr_usages.usages_dttm is not null ) ss ) DT_OFFENDER_ADDRESSES, BODISTAGING.REF_OFFENDERS]",
      "entityId": "Fiee.V4LKwkAXPcAAHAL9V4WACJIAFJ8",
      "entityType": "dpd"
    },
    {
      "type": "schema",
      "error": "Dataset does not have any schema fields (comments -- in query)",
      "entityId": "3376639/DP5",
      "entityType": "dataset"
    },
    {
      "type": "athenQuery",
      "error": "Error: Error: Query failed: GENERIC_USER_ERROR: Failed To Get Query Passthrough Schema",
      "entityId": "3376639/DP2",
      "entityType": "dataset"
    },
    {
      "type": "athenQuery",
      "error": "unable to generate test sql",
      "entityId": "3376639/DP5",
      "entityType": "dataset"
    }
  ]
}