{
  "id": "dps-case-note-for-date-range-inc-omic",
  "name": "DPS Case Notes for a Date Range Report (Including OMiC)",
  "description": "This report lists the changes carried out to prisoner case notes in a specified date range and will include both sensitive (OMiC) and non-sensitive notes.",
  "metadata": {
    "version": "1.0.0"
  },
  "datasource": [
    {
      "id": "datamart",
      "name": "datamart"
    }
  ],
  "dataset": [
    {
      "id": "dps-case-note-for-date-range-inc-omic-dataset",
      "name": "Case Notes",
      "description": "Demographic",
      "datasource": "datamart",
      "query": "SELECT AT_OFFENDER.OFFENDER_ID_DISPLAY, AT_OFFENDER.FIRST_NAME, AT_OFFENDER.LAST_NAME, SPLIT_PART(AT_AGENCY_INTERNAL_LOCATION_L4.DESCRIPTION, '-', 2) AS UNIT_CODE_1, AT_OFFENDERS_LOCATIONS.AGY_LOC_ID, AT_OFFENDER_CASE_NOTES.OCCURRED_AT AS CONTACT_DATETIME, AT_STAFF_USER_ACCOUNTS.USERNAME, AT_CASE_NOTES_STAFF_MEMBERS.FIRST_NAME AS CASE_NOTES_STAFF_FIRST_NAME, AT_CASE_NOTES_STAFF_MEMBERS.LAST_NAME AS CASE_NOTES_STAFF_LAST_NAME, AT_OFFENDER_CASE_NOTES.NOTE_TEXT, AT_OFFENDER_CASE_NOTE_SUB_TYPE.TYPE_CODE AS CASE_NOTE_TYPE, AT_OFFENDER_CASE_NOTE_TYPE.CODE AS CASE_NOTE_SUB_TYPE, AT_STAFF_USER_ACCOUNTS.STAFF_USER_TYPE, SUBSTRING(AT_STAFF_USER_ACCOUNTS.USERNAME, 1, 6) AS V_USER_ID, CONCAT(CONCAT(AT_OFFENDER_CASE_NOTE_SUB_TYPE.TYPE_CODE, ' - '), AT_OFFENDER_CASE_NOTE_TYPE.CODE) AS V_CASE_NOTE_TYPE_SUBTYPE, (AT_OFFENDER.OFFENDER_ID_DISPLAY || ' ' || AT_OFFENDER.FIRST_NAME || ' ' || AT_OFFENDER.LAST_NAME) AS PRISONER_NAME FROM datamart.prisons.nomis_offenders AT_OFFENDER JOIN datamart.prisons.nomis_offender_bookings AT_OFFENDER_BOOKING ON AT_OFFENDER.OFFENDER_ID = AT_OFFENDER_BOOKING.OFFENDER_ID JOIN datamart.prisons.nomis_agency_internal_locations AT_AGENCY_INTERNAL_LOCATION_L4 ON AT_OFFENDER_BOOKING.LIVING_UNIT_ID = AT_AGENCY_INTERNAL_LOCATION_L4.INTERNAL_LOCATION_ID JOIN datamart.prisons.nomis_agency_locations AT_WING_ESTABLISHMENT ON AT_AGENCY_INTERNAL_LOCATION_L4.AGY_LOC_ID = AT_WING_ESTABLISHMENT.AGY_LOC_ID JOIN datamart.prisons.nomis_user_accessible_caseloads WING_CASELOAD_SECURITY ON AT_WING_ESTABLISHMENT.AGY_LOC_ID = WING_CASELOAD_SECURITY.CASELOAD_ID JOIN datamart.prisons.nomis_user_accessible_caseloads USER_ACCESSIBLE_CASELOADS ON USER_ACCESSIBLE_CASELOADS.USERNAME = (SELECT USERNAME FROM context_) JOIN datamart.prisons.nomis_agency_locations AT_OFFENDERS_LOCATIONS ON AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = USER_ACCESSIBLE_CASELOADS.CASELOAD_ID JOIN datamart.prisons.nomis_caseload_agency_locations AT_CASELOAD_LOCATIONS ON AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDER_BOOKING.AGY_LOC_ID LEFT JOIN datamart.prisons.nomis_agency_locations AT_OFFENDERS_LOCATIONS_OPTIONAL ON AT_CASELOAD_LOCATIONS.AGY_LOC_ID = AT_OFFENDERS_LOCATIONS_OPTIONAL.AGY_LOC_ID JOIN datamart.prisons.casenotes_case_note AT_OFFENDER_CASE_NOTES ON AT_OFFENDER.OFFENDER_ID_DISPLAY = AT_OFFENDER_CASE_NOTES.PERSON_IDENTIFIER JOIN datamart.prisons.casenotes_case_note_sub_type AT_OFFENDER_CASE_NOTE_SUB_TYPE ON AT_OFFENDER_CASE_NOTE_SUB_TYPE.ID = AT_OFFENDER_CASE_NOTES.SUB_TYPE_ID JOIN datamart.prisons.casenotes_case_note_type AT_OFFENDER_CASE_NOTE_TYPE ON AT_OFFENDER_CASE_NOTE_SUB_TYPE.TYPE_CODE = AT_OFFENDER_CASE_NOTE_TYPE.CODE JOIN datamart.prisons.nomis_staff_user_accounts AT_STAFF_USER_ACCOUNTS ON AT_OFFENDER_CASE_NOTES.AUTHOR_USER_ID = AT_STAFF_USER_ACCOUNTS.STAFF_ID::VARCHAR JOIN datamart.prisons.nomis_staff_members AT_CASE_NOTES_STAFF_MEMBERS ON AT_STAFF_USER_ACCOUNTS.STAFF_ID = AT_CASE_NOTES_STAFF_MEMBERS.STAFF_ID WHERE AT_OFFENDERS_LOCATIONS.AGENCY_LOCATION_TYPE = 'INST' AND WING_CASELOAD_SECURITY.USERNAME = (SELECT USERNAME FROM context_) AND AT_OFFENDERS_LOCATIONS.AGY_LOC_ID = (SELECT ESTABLISHMENT_CODE FROM prompt_) AND AT_OFFENDER_CASE_NOTES.OCCURRED_AT BETWEEN (SELECT START_DATE FROM prompt_) AND (SELECT END_DATE FROM prompt_) AND AT_CASELOAD_LOCATIONS.AGY_LOC_ID NOT IN ('OUT', 'TRN') AND AT_CASELOAD_LOCATIONS.CASELOAD_ID NOT IN ('ADMINC', 'CADM_I', 'MULTI')",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_code",
          "filterType": "autocomplete",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "(SELECT establishment_code from prompt_)",
          "mandatory": "true",
          "referenceType": "establishment"
        },
        {
          "index": 1,
          "name": "start_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Enter Date(Start):",
          "description": "@prompt('Enter Event Date(Start):','D',,Mono,Free,Not_Persistent,,User:2)",
          "mandatory": "true"
        },
        {
          "index": 2,
          "name": "end_date",
          "filterType": "date",
          "reportFieldType": "date",
          "display": "Enter Date(End):",
          "description": "@prompt('Enter Event Date(End):','D',,Mono,Free,Not_Persistent,,User:3)",
          "mandatory": "true"
        }
      ],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number"
          },
          {
            "index": 1,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name"
          },
          {
            "index": 2,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name"
          },
          {
            "index": 3,
            "name": "UNIT_CODE_1",
            "type": "string",
            "display": "Unit Code 1"
          },
          {
            "index": 4,
            "name": "AGY_LOC_ID",
            "type": "string",
            "display": "Establishment Code"
          },
          {
            "index": 5,
            "name": "CONTACT_DATETIME",
            "type": "datetime",
            "display": "Contact Date"
          },
          {
            "index": 7,
            "name": "USERNAME",
            "type": "string",
            "display": "Case Notes Staff User Id"
          },
          {
            "index": 8,
            "name": "CASE_NOTES_STAFF_FIRST_NAME",
            "type": "string",
            "display": "Case Notes Staff First Name"
          },
          {
            "index": 9,
            "name": "CASE_NOTES_STAFF_LAST_NAME",
            "type": "string",
            "display": "Case Notes Staff Last Name"
          },
          {
            "index": 10,
            "name": "NOTE_TEXT",
            "type": "string",
            "display": "Case Note Text"
          },
          {
            "index": 11,
            "name": "CASE_NOTE_SUB_TYPE",
            "type": "string",
            "display": "Case Note Sub Type"
          },
          {
            "index": 12,
            "name": "CASE_NOTE_TYPE",
            "type": "string",
            "display": "Case Note Type"
          },
          {
            "index": 13,
            "name": "STAFF_USER_TYPE",
            "type": "string",
            "display": "Case Notes Staff User Type"
          },
          {
            "index": 14,
            "name": "V_USER_ID",
            "type": "string",
            "display": "V_USER_ID"
          },
          {
            "index": 15,
            "name": "V_CASE_NOTE_TYPE_SUBTYPE",
            "type": "string",
            "display": "V_CASE_NOTE_TYPE_SUBTYPE"
          },
          {
            "index": 16,
            "name": "PRISONER_NAME",
            "type": "string",
            "display": "Prisoner Name"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER",
                "ROLE_VIEW_SENSITIVE_CASE_NOTES"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "dps-case-notes-by-wing",
      "name": "By Wing",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-section",
        "section": ["UNIT_CODE_1", "PRISONER_NAME"],
        "field": [
          {
            "name": "$ref:UNIT_CODE_1",
            "display": "Wing",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:PRISONER_NAME",
            "display": "Prisoner Name",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DOcc2"
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATE}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "dps-case-notes-by-prisoner",
      "name": "By Prisoner",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-section",
        "section": ["PRISONER_NAME"],
        "field": [
          {
            "name": "$ref:PRISONER_NAME",
            "display": "Prisoner Name",
            "formula": "",
            "visible": "false",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATE}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "dps-case-notes-by-prisoner-merged",
      "name": "By Prisoner Merged",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DOcc1"
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATE}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    }
  ],
  "errors": []
}