{
  "id": "dps-case-note-for-date-range-inc-omic",
  "name": "DPS Case Notes (Including OMiC) for Active Caseload by Date Range Report",
  "description": "This report lists the changes carried out to prisoner case notes in a specified date range and will include both sensitive (OMiC) and non-sensitive notes.",
  "metadata": {
    "version": "1.0.0"
  },
  "datasource": [
    {
      "id": "datamart",
      "name": "datamart"
    }
  ],
  "dataset": [
    {
      "id": "dps-case-note-for-date-range-inc-omic-dataset",
      "name": "Case Notes",
      "description": "Demographic",
      "datasource": "datamart",
      "query": "SELECT at_offender.offender_id_display, at_offender.first_name, at_offender.last_name, split_part(at_agency_internal_location_l4.description, '-', 2) AS unit_code_1, at_offenders_locations.agy_loc_id, at_offender_case_notes.occurred_at AS contact_datetime, at_staff_user_accounts.username, at_case_notes_staff_members.first_name AS case_notes_staff_first_name, at_case_notes_staff_members.last_name AS case_notes_staff_last_name, at_offender_case_notes.note_text, at_offender_case_note_sub_type.code AS case_note_sub_type, at_offender_case_note_type.code AS case_note_type, at_staff_user_accounts.staff_user_type, substring(at_staff_user_accounts.username, 1, 6) AS v_user_id, concat(concat(at_offender_case_note_type.code, ' - '), at_offender_case_note_sub_type.code) AS v_case_note_type_subtype, (at_offender.offender_id_display || ' ' || at_offender.first_name || ' ' || at_offender.last_name) AS prisoner_name, at_offender_case_note_sub_type.sensitive AS sensitive_note, at_offenders_locations.description AS establishment FROM datamart.prisons.nomis_offenders at_offender JOIN datamart.prisons.nomis_offender_bookings at_offender_booking ON at_offender.offender_id = at_offender_booking.offender_id JOIN datamart.prisons.nomis_agency_internal_locations at_agency_internal_location_l4 ON at_offender_booking.living_unit_id = at_agency_internal_location_l4.internal_location_id JOIN datamart.prisons.nomis_agency_locations at_offenders_locations ON at_agency_internal_location_l4.agy_loc_id = at_offenders_locations.agy_loc_id JOIN datamart.prisons.nomis_caseload_agency_locations at_caseload_locations ON at_caseload_locations.agy_loc_id = at_offender_booking.agy_loc_id LEFT JOIN datamart.prisons.nomis_agency_locations at_offenders_locations_optional ON at_caseload_locations.agy_loc_id = at_offenders_locations_optional.agy_loc_id JOIN datamart.prisons.casenotes_case_note at_offender_case_notes ON at_offender.offender_id_display = at_offender_case_notes.person_identifier JOIN datamart.prisons.casenotes_case_note_sub_type at_offender_case_note_sub_type ON at_offender_case_note_sub_type.id = at_offender_case_notes.sub_type_id JOIN datamart.prisons.casenotes_case_note_type at_offender_case_note_type ON at_offender_case_note_sub_type.type_code = at_offender_case_note_type.code JOIN datamart.prisons.nomis_staff_user_accounts at_staff_user_accounts ON at_offender_case_notes.author_user_id = at_staff_user_accounts.staff_id::VARCHAR JOIN datamart.prisons.nomis_staff_members at_case_notes_staff_members ON at_staff_user_accounts.staff_id = at_case_notes_staff_members.staff_id WHERE at_offenders_locations.agency_location_type = 'INST' AND at_caseload_locations.agy_loc_id NOT IN ('OUT', 'TRN') AND at_caseload_locations.caseload_id NOT IN ('ADMINC', 'CADM_I', 'MULTI')",
      "parameters": [],
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "OFFENDER_ID_DISPLAY",
            "type": "string",
            "display": "NOMS Number"
          },
          {
            "index": 1,
            "name": "FIRST_NAME",
            "type": "string",
            "display": "First Name"
          },
          {
            "index": 2,
            "name": "LAST_NAME",
            "type": "string",
            "display": "Last Name"
          },
          {
            "index": 3,
            "name": "UNIT_CODE_1",
            "type": "string",
            "display": "Unit Code 1"
          },
          {
            "index": 4,
            "name": "AGY_LOC_ID",
            "type": "string",
            "display": "Establishment Code"
          },
          {
            "index": 5,
            "name": "CONTACT_DATETIME",
            "type": "timestamp",
            "display": "Contact Date and Time"
          },
          {
            "index": 7,
            "name": "USERNAME",
            "type": "string",
            "display": "Case Notes Staff User Id"
          },
          {
            "index": 8,
            "name": "CASE_NOTES_STAFF_FIRST_NAME",
            "type": "string",
            "display": "Case Notes Staff First Name"
          },
          {
            "index": 9,
            "name": "CASE_NOTES_STAFF_LAST_NAME",
            "type": "string",
            "display": "Case Notes Staff Last Name"
          },
          {
            "index": 10,
            "name": "NOTE_TEXT",
            "type": "string",
            "display": "Case Note Text"
          },
          {
            "index": 11,
            "name": "CASE_NOTE_SUB_TYPE",
            "type": "string",
            "display": "Case Note Sub Type"
          },
          {
            "index": 12,
            "name": "CASE_NOTE_TYPE",
            "type": "string",
            "display": "Case Note Type"
          },
          {
            "index": 13,
            "name": "STAFF_USER_TYPE",
            "type": "string",
            "display": "Case Notes Staff User Type"
          },
          {
            "index": 14,
            "name": "V_USER_ID",
            "type": "string",
            "display": "V_USER_ID"
          },
          {
            "index": 15,
            "name": "V_CASE_NOTE_TYPE_SUBTYPE",
            "type": "string",
            "display": "V_CASE_NOTE_TYPE_SUBTYPE"
          },
          {
            "index": 16,
            "name": "PRISONER_NAME",
            "type": "string",
            "display": "Prisoner Name"
          },
          {
            "index": 17,
            "name": "SENSITIVE_NOTE",
            "type": "string",
            "display": "Sensitive Note"
          },
          {
            "index": 18,
            "name": "ESTABLISHMENT",
            "type": "string",
            "display": "Establishment"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER",
                "ROLE_VIEW_SENSITIVE_CASE_NOTES"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "caseload",
      "type": "row-level",
      "action": ["agy_loc_id in (${caseloads})"],
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "exists": ["${caseloads}"]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "dps-case-notes-by-wing",
      "name": "By Wing",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "metadata": {
        "hints": [
          "interactive"
        ]
      },
      "specification": {
        "template": "list",
        "section": ["UNIT_CODE_1", "PRISONER_NAME"],
        "field": [
          {
            "name": "$ref:AGY_LOC_ID",
            "display": "Establishment Code",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false,
            "filter" : {
              "type" : "caseloads",
              "mandatory": "false"
            }
          },
          {
            "name": "$ref:UNIT_CODE_1",
            "display": "Wing",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:PRISONER_NAME",
            "display": "Prisoner Name",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:ESTABLISHMENT",
            "display": "Establishment",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "legacyId": "DP2.DOcc2"
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATETIME}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true,
            "filter": {
              "type": "daterange",
              "default": "today(-1,months) - today()",
              "mandatory": "true"
            }
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:SENSITIVE_NOTE",
            "display": "Sensitive Note",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "dps-case-notes-by-prisoner",
      "name": "By Prisoner",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list-section",
        "section": ["PRISONER_NAME"],
        "field": [
          {
            "name": "$ref:AGY_LOC_ID",
            "display": "Establishment Code",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false,
            "filter" : {
              "type" : "caseloads",
              "mandatory": "false"
            }
          },
          {
            "name": "$ref:PRISONER_NAME",
            "display": "Prisoner Name",
            "formula": "",
            "visible": "false",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:ESTABLISHMENT",
            "display": "Establishment",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATETIME}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true,
            "filter": {
              "type": "daterange",
              "default": "today(-1,months) - today()",
              "mandatory": "true"
            }
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:SENSITIVE_NOTE",
            "display": "Sensitive Note",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    },
    {
      "id": "dps-case-notes-by-prisoner-merged",
      "name": "By Prisoner Merged",
      "classification": "OFFICIAL",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:dps-case-note-for-date-range-inc-omic-dataset",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:AGY_LOC_ID",
            "display": "Establishment Code",
            "formula": "",
            "visible": "false",
            "sortable": false,
            "defaultsort": false,
            "filter" : {
              "type" : "caseloads",
              "mandatory": "false"
            }
          },
          {
            "name": "$ref:ESTABLISHMENT",
            "display": "Establishment",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:OFFENDER_ID_DISPLAY",
            "display": "NOMS Number",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:LAST_NAME",
            "display": "Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:FIRST_NAME",
            "display": "First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_LAST_NAME",
            "display": "Case Notes Staff Last Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:CASE_NOTES_STAFF_FIRST_NAME",
            "display": "Case Notes Staff First Name",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:V_USER_ID",
            "display": "Staff User ID",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:CONTACT_DATETIME",
            "display": "Contact Date and Time",
            "formula": "format_date(${CONTACT_DATETIME}, 'dd/MM/yyyy HH:mm:ss')",
            "visible": "true",
            "sortable": true,
            "defaultsort": true,
            "filter": {
              "type": "daterange",
              "default": "today(-1,months) - today()",
              "mandatory": "true"
            }
          },
          {
            "name": "$ref:V_CASE_NOTE_TYPE_SUBTYPE",
            "display": "Case Note Type/Sub Type",
            "formula": "",
            "visible": "true",
            "sortable": false,
            "defaultsort": false
          },
          {
            "name": "$ref:SENSITIVE_NOTE",
            "display": "Sensitive Note",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:NOTE_TEXT",
            "display": "Case Note Text",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    }
  ],
  "errors": []
}