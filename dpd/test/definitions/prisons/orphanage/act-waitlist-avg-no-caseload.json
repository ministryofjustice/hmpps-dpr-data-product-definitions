
{
  "id": "act003-waitlist-average-by-caseload",
  "name": "Waitlist Active Averages by Activity, Status and Requestor (requires caseload)",
  "description": "The report will be used by the Activities team to look at the avergae wait times for active activities -  qq: Group by activity category or by activity",
  "metadata": {
    "version": "1.1.0",
    "tags": [
      "ACT001  v00.00.01",
      "DPS", "Activities Reporting"
    ],
	"JIRA": "https://dsdmoj.atlassian.net/browse/DPR2-2272"
  },
  "datasource": [
    {
        "id": "datamart",
        "name": "datamart"
    }
  ],
  "dataset": [
    {
      "id": "waitlist",
      "name": "Waitlist",
      "description": "Waitlist averages",
      "datasource": "datamart",
      "query":"SELECT p.name AS pc,a.description AS activity_name,status,requested_by, COUNT(a.description) as activity_count,Min(DATEDIFF (day,w.application_date,CURRENT_DATE)) as min_waittime,AVG(DATEDIFF (day,w.application_date,CURRENT_DATE)) AS avg_waittime, Max(DATEDIFF (day,w.application_date,CURRENT_DATE)) as max_waittime FROM prisons.activities_waiting_list w JOIN prisons.activities_activity a USING (activity_id) inner join prisons.activities_activity_category ac USING (activity_category_id) JOIN datamart.establishment.prison p ON w.prison_code = p.prison_id WHERE status NOT IN ('ALLOCATED','REMOVED','DECLINED') AND start_date < CURRENT_DATE AND (end_date > CURRENT_DATE OR end_date IS NULL) and pc = 'Aylesbury (HMP)' GROUP BY GROUPING SETS ((pc,activity_name,status,requested_by),(pc,activity_name),(pc,status),(pc),()) ORDER BY pc,activity_name,status",
      "schema": {
        "field": [
          {
            "index": 0,
            "name": "pc",
            "type": "string",
			"sortable": true,
            "display": "Prison code",
            "filter" : {
              "type" : "multiselect",
			  "interactive" : true,
              "dynamicoptions" : {
                "returnAsStaticOptions" : true,
                "dataset" : "prisons",
                "name" : "prison_id",
				"display": "prison_name",
                "maximumOptions" : 123
              }
            }
          },
          {
            "index": 1,
            "name": "activity_name",
            "type": "string",
            "display": "Name"
          },
          {
            "index": 2,
            "name": "status",
            "type": "string",
			"sortable": true,
            "display": "STATUS",
            "filter": {
              "type": "multiselect",
			  "interactive": "true",
              "staticoptions": [
                {
                  "name": "APPROVED",
                  "display": "Approved"
                },
                {
                  "name": "PENDING",
                  "display": "Pending"
                }
              ]
            }
          },
          {
            "index": 3,
            "name": "requested_by",
            "type": "string",
			"sortable": true,
            "display": "Requestor",
            "filter": {
              "type": "multiselect",
			  "interactive": "true",
              "staticoptions": [
                {
                  "name": "GUIDANCE_STAFF",
                  "display": "Guidance"
                },
                {
                  "name": "PRISONER",
                  "display": "Prisoner"
                },
                {
                  "name": "WING_STAFF",
                  "display": "Wing"
                }
              ]
            }
          },
          {
            "index": 4,
            "name": "activity_count",
            "type": "string",
			"sortable": true,
            "display": "Count"
          },
          {
            "index": 5,
            "name": "min_waittime",
            "type": "string",
			"sortable": true,
            "display": "Min"
          },
          {
            "index": 6,
            "name": "avg_waittime",
            "type": "string",
			"sortable": true,
            "display": "AVG"
          },
          {
            "index": 7,
            "name": "max_waittime",
            "type": "string",
            "display": "Max"
          }
        ]
      }
    },
    {
      "id": "prisons",
      "name": "prisons",
      "datasource": "datamart",
      "query": "SELECT prison_id,name AS prison_name FROM establishment.prison WHERE active = TRUE ORDER by name",
      "schema": {
        "field": [
            {
              "name": "prison_id",
              "type": "string"
            },
          {
            "name": "prison_name",
            "type": "string"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
  ],
  "dashboard": [{
    "id": "waitlist-status-breakdown",
    "name": "Waitlist Averages Breakdown",
    "description": "Waitlist Averages Breakdown",
    "dataset": "waitlist",
    "section": [
      {
        "id": "pc-activity-status-breakdown",
        "display": "Activity Status Breakdown",
        "visualisation": [
          {
            "id": "pc-activity-status",
            "type": "list",
            "display": "Average wait list duration by Activity, Status and Requester",
            "column": {
              "key": [
                  {
                    "id": "$ref:pc",
                    "display": "Prison Code"
                  },
                  {
                    "id": "$ref:activity_name",
                    "display": "Activity Name"
                  },                  {
                      "id": "$ref:status",
                      "display": "Activity Status"
                    },
  				  {
  					  "id": "$ref:requested_by",
  					  "display": "Requester"
  				  }
              ],
              "measure": [
                  {
                    "id": "$ref:pc",
                    "display": "Prison Code"
                  },
                  {
                    "id": "$ref:activity_name",
					"display": "Activity Name"
                  },                  {
                      "id": "$ref:status",
                      "display": "Activity Status"
                    },
  				  {
  					  "id": "$ref:requested_by",
  					  "display": "Requester"
  				  },
                  {
                      "id": "$ref:activity_count"
                    },
	                {
	                  "id": "$ref:min_waittime"
	                },
                {
                  "id": "$ref:avg_waittime",
                  "display": "Average (days)"
                },
                {
                  "id": "$ref:max_waittime"
                }
              ],
              "expectNull": false
            }
          }
        ]
      },
      {
        "id": "activity-status-breakdown",
        "display": "Activity breakdown",
        "visualisation": [
          {
            "id": "pc-description",
            "type": "list",
            "display": "Average wait list duration by Activity",
            "column": {
              "key": [
                  {
                    "id": "$ref:pc",
                    "display": "Prison Code"
                  },
                  {
                    "id": "$ref:activity_name",
                    "display": "Activity Name"
                  }
              ],
              "measure": [
                  {
                    "id": "$ref:pc",
                    "display": "Prison Code"
                  },
                  {
                    "id": "$ref:activity_name",
                  "display": "Activity Name"
                  },
                  {
                      "id": "$ref:activity_count",
                      "display": "Activity Count"
                    },
                {
                  "id": "$ref:avg_waittime",
                  "display": "Average time (days)"
                }
              ],
              "filter": [
                {
                  "id": "$ref:status",
                  "equals": null
                },
                {
                  "id": "$ref:requested_by",
                  "equals": null
                }
              ],
              "expectNull": false
            }
          }
        ]
      },
      {
        "id": "activity-status-breakdown",
        "display": "Activity barchart",
        "visualisation": [
          {
            "id": "pc-description",
            "type": "bar",
            "display": "Average wait list duration by Activity bar",
			"option": {
			  "horizontal": true
			},
            "column": {
              "key": [
                  {
                    "id": "$ref:pc",
                      "display": "Prison Code"
                  },
                  {
                    "id": "$ref:status",
                    "display": "Status"
                  }
              ],
              "measure": [
                {
                  "id": "$ref:avg_waittime",
                  "display": "Average time (days)"
                }
              ],
              "expectNull": false
            }
          }
        ]
      },
      {
        "id": "activity-status-breakdown",
        "display": "Establishment breakdown",
        "visualisation": [
          {
            "id": "pc",
            "type": "list",
            "display": "Average wait list duration by Establishment ",
            "column": {
              "key": [
                {
					"id": "$ref:pc",
					"display": "Prison Code"
                }
              ],
              "measure": [
                  {
                    "id": "$ref:pc",
                    "display": "Prison Code"
                  },
				  {
					  "id": "$ref:activity_count",
					  "display": "Activity Count"
				  },
				  {
					  "id": "$ref:avg_waittime",
					  "display": "Average time (days)"
				  },
				  {
					  "id": "$ref:max_waittime",
					  "display": "Max time (days)"
				  }
              ],
              "filter": [
                {
                  "id": "$ref:activity_name",
                  "equals": null
                },
                {
                  "id": "$ref:status",
                  "equals": null
                },
                {
                  "id": "$ref:requested_by",
                  "equals": null
                }
              ],
              "expectNull": false
            }
          }
        ]
      },
      {
        "id": "debug",
        "display": "Debug",
        "visualisation": [
          {
            "id": "all-data",
            "type": "list",
            "display": "All data",
            "column": {
              "measure": [],
              "expectNull": true
            }
          }
        ]
      }
    ]
  }]
}
