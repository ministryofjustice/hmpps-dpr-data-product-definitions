{
  "id": "act001-alpha-list-with-activities",
  "name": "Alpha List with Activities ACT0027 v2111 View time slot and alerts version (hardcoded prison code)",
  "description": "The report has been requested to assist in the suitable stock selection and library attendance of prisoners. Other establishment users may also find this report beneficial as it lists all Prisoners in an establishment along with their Personal details and current Activity Description(s)",
  "notes": "Todo: Activities filter to work as staticoptions",
  "metadata": {
    "author": "Zahoor Hussain",
    "owner": "Claire Morgan",
    "version": "1.0.0"
  },
  "datasource": [
    {
        "id": "athena_redshift",
        "name": "athena_redshift_federated",
        "database": "datamart",
        "catalog": "redshift_datamart",
        "connection": "federated",
        "dialect": "redshift/4"
    }
  ],
  "dataset": [
    {
      "id": "alpha-list-activities",
      "name": "Applications",
      "datasource": "datamart",
      "query": "SELECT number AS prisoner_number, name, start_date, end_date, prison_pay_band_id, last_name, first_name, living_unit_id, ethnicity_code, ethnicity, nationality_code, nationality, religion_code, religion, primary_language, gender,age, '$TBC' AS legal_status,activity_id, activity_description, session_date, time_slot,alert_description from datamart.prisoner_activity WHERE  (establishment_id = 'WDI')",
      "parameters": [
        {
          "index": 0,
          "name": "establishment_id",
          "filterType": "autocomplete",
          "referenceType": "establishment",
          "reportFieldType": "string",
          "display": "Establishment",
          "description": "",
          "mandatory": "true"
        }],
      "schema": {
        "field": [
          {
            "name": "prisoner_number",
            "type": "string",
            "display": "NOMIS Number"
          },
          {
            "name": "name",
            "type": "string",
            "display": ""
          },
          {
            "name": "start_date",
            "type": "string",
            "display": ""
          },
          {
            "name": "end_date",
            "type": "string",
            "display": ""
          },
          {
            "name": "prison_pay_band_id",
            "type": "string",
            "display": ""
          },
          {
            "name": "last_name",
            "type": "string",
            "display": ""
          },
          {
            "name": "first_name",
            "type": "string",
            "display": ""
          },
          {
            "name": "living_unit_id",
            "type": "string",
            "display": ""
          },
          {
            "name": "ethnicity_code",
            "type": "string",
            "display": "Ethnicity"
          },
          {
            "name": "ethnicity",
            "type": "string",
            "display": ""
          },
          {
            "name": "nationality_code",
            "type": "string",
            "display": "Nationality"
          },
          {
            "name": "nationality",
            "type": "string",
            "display": ""
          },
          {
            "name": "religion_code",
            "type": "string",
            "display": "Religion"
          },
          {
            "name": "religion",
            "type": "string",
            "display": ""
          },
          {
            "name": "primary_language",
            "type": "string",
            "display": ""
          },
          {
            "name": "gender",
            "type": "string",
            "display": ""
          },
		  {
            "name": "age",
            "type": "string",
            "display": ""
          },
		  {
			  "name": "legal_status",
			  "type": "string",
			  "display": ""
          },
		  {
            "name": "activity_id",
            "type": "string",
            "display": ""
          },{
            "name": "activity_description",
            "type": "string",
            "display": ""
          },
		  {
			  "name": "session_date",
			  "type": "string",
			  "display": ""
          },
		  {
			  "name": "time_slot",
			  "type": "string",
			  "display": ""
          },
		  {
            "name": "alert_description",
            "type": "string",
            "display": "Alert"
          }
        ]
      }
    },{
      "id": "nationalities",
      "name": "nationalities",
      "datasource": "datamart",
      "query": "SELECT profile_code, description FROM datamart.prisons.nomis_profile_codes where profile_type = 'NAT'",
      "schema": {
        "field": [
          {
            "name": "profile_code",
            "type": "string"
          },
          {
            "name": "description",
            "type": "string"
          }
        ]
      }
    },
	{
      "id": "activities",
      "name": "activities",
      "datasource": "datamart",
      "query": "select activity_id as id, summary from datamart.prisons.activities_activity order by summary",
      "schema": {
        "field": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "summary",
            "type": "string"
          }
        ]
      }
    },
	{
      "id": "ethnicities",
      "name": "ethnicities",
      "datasource": "datamart",
      "query": "select code, description from prisons.nomis_reference_codes where domain = 'ETHNICITY' and active_flag = 'Y' order by list_seq",
      "schema": {
        "field": [
          {
            "name": "code",
            "type": "string"
          },
          {
            "name": "description",
            "type": "string"
          }
        ]
      }
    },
	{
      "id": "religions",
      "name": "religions",
      "datasource": "datamart",
      "query": "select profile_code as code, description from prisons.nomis_profile_codes where profile_type = 'RELF' and active_flag = 'Y' order by profile_code",
      "schema": {
        "field": [
          {
            "name": "code",
            "type": "string"
          },
          {
            "name": "description",
            "type": "string"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "ROLE_PRISONS_REPORTING_USER"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
    {
      "id": "activities-in-progress",
      "name": "List of activities",
      "description": "A list of activities sortable by wing",
      "classification": "Official",
      "version": "1.0.0",
      "render": "HTML",
      "dataset": "$ref:alpha-list-activities",
      "feature": [
        {
          "type": "share|save|email|print|download"
        }
      ],
	  "metadata" : {
      	"hints" : ["interactive"]
   	 },
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:prisoner_number",
            "display": "Prison Number",
            "formula": "",
            "visible": "mandatory",
            "sortable": true,
            "defaultsort": true
          },
          {
            "name": "$ref:last_name",
            "display": "Name",
            "formula": "make_url('https://prisoner-${env}.digital.prison.service.justice.gov.uk/prisoner/${prisoner_number}',${first_name} ${last_name},TRUE)",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:living_unit_id",
            "display": "Cell",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:age",
            "display": "Age",
            "formula": "",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          },
          {
            "name": "$ref:activity_id",
            "display": "Activity",
            "formula": "make_url('https://activities-${env}.prison.service.justice.gov.uk/activities/allocation-dashboard/${activity_id}',${activity_description},TRUE)",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
			"filter": {
  				"type": "multiselect",
            	"interactive": true,
              	"dynamicoptions": {
                	"returnAsStaticOptions": true,
                	"maximumOptions": 100,
                	"name": "$ref:activity_id",
					"display": "$ref:activity_description"
				}
			}
          },
          {
            "name": "$ref:start_date",
            "display": "Start Date",
            "formula": "format_date(${start_date}, 'dd/MM/yyyy')",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
            "filter": {
            	"interactive": true,
              	"type": "daterange",
              	"default": ""
            }
		},
   	 	{
			"name": "$ref:session_date",
      		"display": "Session",
      		"formula": "",
      		"visible": "true",
      		"sortable": true,
      		"defaultsort": false
		},
      	{
        	"name": "$ref:time_slot",
        	"display": "Slot",
        	"formula": "",
        	"visible": "true",
        	"sortable": true,
        	"defaultsort": false
		},
    	{
			"name": "$ref:legal_status",
      		"display": "Legal status",
      		"formula": "",
      		"visible": "true",
      		"sortable": true,
      		"defaultsort": false
		},
		{	
            "name": "$ref:religion_code",
            "formula": "${religion}",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
			"filter": {
  			  	"type": "multiselect",
            	"interactive": true,
              	"dynamicoptions": {
                	"returnAsStaticOptions": true,
                	"maximumOptions": 100,
                	"dataset": "$ref:religions",
                	"name": "code",
					"display": "description"
				}
			}
		},
		{
            "name": "$ref:ethnicity_code",
            "display": "Ethnicity",
            "formula": "${ethnicity}",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
			"filter": {
  				"type": "multiselect",
            	"interactive": true,
              	"dynamicoptions": {
                		"returnAsStaticOptions": true,
                		"maximumOptions": 100,
                		"dataset": "$ref:ethnicities",
                		"name": "code",
						"display": "description"
				}
			}
		},
		{
            "name": "$ref:nationality_code",
            "display": "Nationality",
            "formula": "${nationality}",
            "visible": "true",
            "sortable": true,
            "defaultsort": false,
			"filter": {
				"type": "multiselect",
				"interactive": true,
				"dynamicoptions": {
	                	"returnAsStaticOptions": true,
        	        	"maximumOptions": 100,
                		"dataset": "$ref:nationalities",
	                	"name": "profile_code",
				"display": "description"
				}
          		}
          },
		  {
            "name": "$ref:primary_language",
            "display": "Primary Language",
            "formula": "",
            "visible": "false",
            "sortable": true,
            "defaultsort": false
          }, 
		  {
            "name": "$ref:alert_description",
            "display": "Latest Alert",
            "formula": "make_url('https://prisoner-${env}.digital.prison.service.justice.gov.uk/prisoner/${prisoner_number}/alerts/active}',${alert_description},TRUE)",
            "visible": "true",
            "sortable": true,
            "defaultsort": false
          }
        ]
      }
    }
  ]
}