
{
  "id": "mpc-002",
  "name": "Total number of reallocations per prison",
	"description": "This report shows the total number of reallocations recorded for each individual at a prison. It highlights the people with the highest number of reallocations so you can identify unusual activity or potential operational pressures. <P> What the table shows <P> Total: the total number of reallocations linked to an individual while they were at that prison. <P> This is aggregated across all years in the dataset. <P> Moves to other prisons or leaving the system are not included. <P> The table can be sorted, and by default shows the highest totals first. <P> What the table does not show <P> Reallocations an individual may have had at other prisons. <P> Whether the individual is still at the prison. <P> If they are no longer there, the link to their case file will not be available.",
  "metadata": {
    "version": "1.1.0",
    "tags": [
      "ACT001  v00.00.01",
      "DPS", "MPC"
    ],
	"JIRA": "https://dsdmoj.atlassian.net/browse/DPR2-2476"
  },
  "datasource": [
      {
        "id": "datamart",
        "name": "datamart"
      }
  ],
  "dataset": [
    {
      "id": "allocation-by-prison",
      "name": "allocation",
      "description": "",
      "datasource": "dps_mpc",
      "query":"WITH pallocation AS ( SELECT   prison AS prison_caseload, nomis_offender_id, Extract(year FROM primary_pom_allocated_at) AS years, Count(*)                                AS cnt FROM     prisons.managepomcases_allocation_history_versions WHERE    event = 1 GROUP BY prison_caseload, nomis_offender_id, Extract(year FROM primary_pom_allocated_at) ) SELECT *, ( SELECT Sum(cnt) FROM   pallocation T WHERE  t.nomis_offender_id = piv.nomis_offender_id AND    t.prison_caseload = piv.prison_caseload ) AS total FROM   pallocation PIVOT ( Sum(cnt) FOR years IN (2019, 2020, 2021, 2022, 2023, 2024, 2025, 2026) ) AS piv",
      "schema": {
		  
        "field": [
            {
              "index": 0,
              "name": "prison_caseload",
              "type": "string"
            },
          {
            "index": 1,
            "name": "nomis_offender_id",
            "type": "string",
            "display": "NOMS ID"
          },
          {
            "index": 2,
            "name": "2019",
            "type": "string",
            "display": "2019"
          },
          {
            "index": 4,
            "name": "2020",
            "type": "string",
            "display": "2020"
          },
          {
            "index": 4,
            "name": "2021",
            "type": "string",
            "display": "2021"
          },
          {
            "index": 4,
            "name": "2022",
            "type": "string",
            "display": "2022"
          },
          {
            "index": 4,
            "name": "2023",
            "type": "string",
            "display": "2023"
          },
          {
            "index": 4,
            "name": "2024",
            "type": "string",
            "display": "2024"
          },          {
            "index": 4,
            "name": "2025",
            "type": "string",
            "display": "2025"
          },
          {
            "index": 4,
            "name": "2026",
            "type": "string",
            "display": "2026"
          },
          {
            "index": 4,
            "name": "Total",
            "type": "string",
            "display": "Total"
          }
        ]
      }
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}", "ROLE_ALLOC_MGR"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "caseload",
      "type": "row-level",
      "action": [
        "(prison_caseload='${caseload}')"
      ],
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "exists": [
                "${caseload}"
              ]
            }
          ]
        }
      ]
    }
  ],
  "report": [
      {
        "id": "mpc-by-prison",
        "name": "Total number of reallocations per prison",
		"description": "This report shows the total number of reallocations recorded for each individual at a prison. It highlights the people with the highest number of reallocations so you can identify unusual activity or potential operational pressures. <P> What the table shows <P> Total: the total number of reallocations linked to an individual while they were at that prison. <P> This is aggregated across all years in the dataset. <P> Moves to other prisons or leaving the system are not included. <P> The table can be sorted, and by default shows the highest totals first. <P> What the table does not show <P> Reallocations an individual may have had at other prisons. <P> Whether the individual is still at the prison. <P> If they are no longer there, the link to their case file will not be available.",
        "classification": "Official",
        "version": "1.0.0",
        "render": "HTML",
        "dataset": "$ref:allocation-by-prison",
        "feature": [
          {
            "type": "share|save|email|print|download"
          }
        ],
  	  "metadata" : {
        	"hints" : ["interactive"]
     	 },
        "specification": {
          "template": "list",
          "field": [
            {
              "name": "$ref:nomis_offender_id",
            	"formula": "make_url('https://${env}.moic.service.justice.gov.uk/prisons/${prison_caseload}/prisoners/${nomis_offender_id}/allocation/history',${nomis_offender_id},TRUE)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
              "name": "$ref:2019",
              "formula": "default_value(${2019},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
			{
				"name": "$ref:2020",
              "formula": "default_value(${2020},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
			{
				"name": "$ref:2021",
              "formula": "default_value(${2021},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
			{
				"name": "$ref:2022",
              "formula": "default_value(${2022},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
				"name": "$ref:2023",
              "formula": "default_value(${2023},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
				"name": "$ref:2024",
              "formula": "default_value(${2024},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
				"name": "$ref:2025",
              "formula": "default_value(${2025},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
				"name": "$ref:2026",
              "formula": "default_value(${2026},-)",
              "visible": "true",
              "sortable": false,
              "defaultsort": false
            },
            {
				"name": "$ref:Total",
              "visible": "true",
              "sortable": true,
              "defaultsort": true,
			  "sortdirection": "desc"		  
            }
          ]
        }
      }
	  
	  
  ],
  "dashboard": [

  ]
}
